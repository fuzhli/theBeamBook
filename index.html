<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>The Erlang Runtime System</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>The Erlang Runtime System</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph"><p>This book is not about how to write correct and
beautiful code, I am assuming that you already know how to do
that. This book isn’t really about profiling and performance tuning
either. Although, there is a chapter in this book on tracing and
profiling which can help you find bottlenecks and unnecessary usage of
resources. There also is a chapter on performance tuning.</p></div>
<div class="paragraph"><p>These two chapters are the last chapters in the book, and the whole
book is building up to those chapters, but the real goal with this
book is to give you all the information, all the gory details, that
you need in order to really understand the performance of your Erlang
application.</p></div>
<div class="sect2">
<h3 id="who_is_this_book_for">About this book</h3>
<div class="paragraph"><p>For anyone who: Want to tune an Erlang installation. Want to know how
to debug VM crashes. Want to improve performance of Erlang
applications. Want to understand how Erlang really works. Want to
learn how to build your own runtime environment.</p></div>
<div class="paragraph"><p>If you want to debug the VM If you want to extend the VM If you want
to do performance tweaking&#8212;jump to the last chapter … but to really
understand that chapter you need to read the book.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book">How to read this book</h3>
<div class="paragraph"><p>The Erlang RunTime System (ERTS) is a complex system with many
interdependent components. It is written in a very portable way so
that it can run on anything from a gum-stick computer to the largest
multicore system with terabytes of memory. In order to be able to
optimize the performance of such a system for your application, you
need to not only know your application, but you also need to have a
thorough understanding of ERTS itself.</p></div>
<div class="paragraph"><p>With this knowledge of how ERTS works you will be able to understand
how your application behaves when running on ERTS, and you will also
be able to find and fix problems with the performance of your application.
In the second part of this book we will go through how you successfully
run, monitor and scale your ERTS application.</p></div>
<div class="paragraph"><p>You don’t need to be an Erlang programmer to read this book, but you
will need some basic understanding of what Erlang is. This following
section will give you some Erlang background.</p></div>
</div>
<div class="sect2">
<h3 id="_erlang">Erlang</h3>
<div class="paragraph"><p>In this section we will look at some basic Erlang concepts that
are vital to understanding the rest of the book.</p></div>
<div class="paragraph"><p>Erlang has been called, especially by one of Erlang&#8217;s creators Joe
Armstrong, a concurrency oriented language. Concurrency is definitely
at the heart of Erlang, and to be able to understand how an Erlang
system works you need to understand the concurrency model of Erlang.</p></div>
<div class="paragraph"><p>First of all we need to make a distinction between <em>concurrency</em> and
<em>parallelism</em>. In this book <em>concurrency</em> is the concept of having
two or more processes that <strong>can</strong> execute independently of each other,
this can be done by first executing one process then the other or by
interleaving the execution, or by executing the processes in
parallel. With <em>parallel</em> executions we mean that the processes
actually execute at the exact same time by using several physical
execution units. Parallelism can be achieved on different levels.
Through multiple execution units in the execution pipeline in one core,
in several cores on one CPU, by several CPUs in one machine or through
several machines.</p></div>
<div class="paragraph"><p>Erlang uses processes to achieve concurrency. Conceptually Erlang
processes are similar to most OS processes, they execute in parallel
and can communicate through signals. In practices there is a huge
difference in that Erlang processes are much more lightweight than
most OS processes. Many other concurrent programming languages call
their equivalent to Erlang processes <em>agents</em>.</p></div>
<div class="paragraph"><p>Erlang achieves concurrency by interleaving the execution of processes
on the Erlang virtual machine, the BEAM. On multi-core processor the
BEAM can also achieve parallelism by running one scheduler per core and
executing one Erlang process per scheduler. The designer of an Erlang
system can achieve further parallelism by distributing the system on
several computers.</p></div>
<div class="paragraph"><p>A typical Erlang system (a server or service built in Erlang) consists
of a number of Erlang <em>applications</em>, corresponding to a directory on disk.
Each application is made up of several Erlang <em>modules</em> corresponding to
files in the directory. Each module contains a number of <em>functions</em> and
each function is made up of <em>expressions</em>.</p></div>
<div class="paragraph"><p>Since Erlang is a functional language it has no statements,
only expressions. Erlang expressions can be combined to an Erlang
function. A function takes a number of arguments and returns a
value. In <a href="#erlang_code_examples">[erlang_code_examples]</a> we can see some examples of
Erlang expressions and functions.</p></div>
<div class="listingblock">
<a id="erlang_code_examples"></a>
<div class="title">Erlang Code Examples</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">%% Some Erlang expressions:</span></span>

<span style="color: #000080">true</span><span style="color: #990000">.</span>
<span style="color: #993399">1</span><span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> (<span style="color: #009900">X</span> <span style="color: #990000">&gt;</span> <span style="color: #009900">Y</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">X</span>; <span style="color: #000080">true</span> <span style="color: #990000">-&gt;</span> <span style="color: #009900">Y</span> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% An Erlang function:</span></span>

<span style="font-weight: bold"><span style="color: #000000">max</span></span>(<span style="color: #009900">X</span>, <span style="color: #009900">Y</span>) <span style="color: #990000">-&gt;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> (<span style="color: #009900">X</span> <span style="color: #990000">&gt;</span> <span style="color: #009900">Y</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">X</span>;
     <span style="color: #000080">true</span>    <span style="color: #990000">-&gt;</span> <span style="color: #009900">Y</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Erlang has a number of <em>built in functions</em> (or <em>BIFs</em>) which are
implemented by the VM. This is either for efficiency reasons, like the
implementation of <span class="monospaced">lists:append</span> (which could be implemented in
Erlang). It could also be to provide some low level functionality
which would be hard or impossible to implement in Erlang itself, like
<span class="monospaced">list_to_atom</span>.</p></div>
<div class="paragraph"><p>Since Erlang/OTP R13B03 you can also provide your own functions
implemented in C by using the <em>Native Implemented Functions</em> (<em>NIF</em>)
interface.</p></div>
</div>
<div class="sect2">
<h3 id="_acknowledgments">Acknowledgments</h3>
<div class="paragraph"><p>A big thank you to everyone who has contributed in some way by checking in
something:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Roberto Aloi
Alexandre Rodrigues
Ken Causey
Michał Piotrowski
Anthony Molinaro
Benjamin Tan Wei Hao
Cameron Price
Jan Lehnardt
PlatinumThinker
Yago Riveiro
Yoshihiro TANAKA</pre>
</div></div>
</div>
</div>
</div>
<h1 id="P-ERTS">Understanding ERTS</h1>
<div class="sect1">
<h2 id="introduction">Introducing the Erlang Runtime System</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Erlang RunTime System (ERTS)  is a complex system with many interdependent
components. It is written in a very portable way so that it can run on
anything from a gum stick computer to the largest multicore system
with terabytes of memory. In order to be able to optimize the
performance of such a system for your application, you need to not
only know your application, but you also need to have a thorough
understanding of ERTS itself.</p></div>
<div class="sect2">
<h3 id="_erts_and_the_erlang_runtime_system">ERTS and the Erlang Runtime System</h3>
<div class="paragraph"><p>There is a difference between any Erlang Runtime System  and a specific implementation of an Erlang Runtime
System. "Erlang/OTP" by Ericsson is the de facto standard
implementation of Erlang and the Erlang Runtime System. In this book I
will refer to this implementation as <em>ERTS</em> or spelled out <em>Erlang
RunTime System</em> with a capital T. (See <a href="#ERTS">[ERTS]</a> for a definition of
OTP).</p></div>
<div class="paragraph"><p>There is no official definition of what an Erlang Runtime System is,
or what an Erlang Virtual Machine is. You could sort of imagine what
such an ideal Platonic system would look like by taking ERTS and
removing all the implementation specific details. This is
unfortunately a circular definition, since you need to know the
general definition to be able to identify an implementation specific
detail. In the Erlang world we are usually too pragmatic to worry about
this.</p></div>
<div class="paragraph"><p>I will try to use the term <em>Erlang Runtime System</em> to refer to the
general idea of any Erlang Runtime System as opposed to the specific
implementation by Ericsson which I&#8217;ll call the Erlang RunTime System
or usually just ERTS.</p></div>
<div class="paragraph"><p><strong>Note</strong> This book is mostly a book about ERTS in particular and only to
a small extent about any general Erlang Runtime System. If you assume
that I talk about the Ericsson implementation unless I clearly state
that I am talking about a general principle you will probably be
right.</p></div>
</div>
<div class="sect2">
<h3 id="_how_to_read_this_book_2">How to read this book</h3>
<div class="paragraph"><p>In <a href="#P-Running">[P-Running]</a> of this book I will show you how to tune the
runtime system for your application and how to profile and debug
your application and the runtime system. In order to really know
how to tune the system you also need to know the system. In
<a href="#P-ERTS">[P-ERTS]</a> of this book you will get a deep understanding of
how the runtime system works.</p></div>
<div class="paragraph"><p>In the following chapters of <a href="#P-ERTS">[P-ERTS]</a> I will try to explain each
component of the system by itself, in a separate chapter for each of
the major component. You should be able to read any one of these
chapters without having a full understanding of how the other
components are implemented, but you will need a basic understanding of
what each component is. The rest of this introductory chapter should
give you enough basic understanding and vocabulary to be able to jump
between the rest of the chapters in part one in any order you like.</p></div>
<div class="paragraph"><p>However, if you have the time I strongly recommend reading the book in
order the first time. Words that are specific to Erlang and ERTS or
used in a specific way in this book are usually explained at their
first occurrence. Then, when you know the vocabulary, you can come
back and use Part I as a reference whenever you have a problem with a
particular component.</p></div>
</div>
<div class="sect2">
<h3 id="ERTS">ERTS</h3>
<div class="paragraph"><p>In this section I will give a basic overview of the main components of
ERTS  and some vocabulary needed to understand the more
detailed descriptions of each component in the following chapters.</p></div>
<div class="sect3">
<h4 id="_the_erlang_node_erts">The Erlang Node (ERTS)</h4>
<div class="paragraph"><p>An Erlang node  is a running instance of ERTS  (or
possibly another implementation of Erlang (see
<a href="#Other_Erlang_Implementations">[Other_Erlang_Implementations]</a>)).
In OO terminology one could say that an Erlang node is an object
of the Erlang Runtime System class.</p></div>
<div class="paragraph"><p>All execution of Erlang code is done within a node. An erlang node
corresponds to an OS process and you can have several Erlang nodes
running on one machine.</p></div>
<div class="paragraph"><p>Your Erlang program (or application) will run in one or more Erlang
nodes, and the performance of your program will depend not only on
your application code but also on all the layers below your code
in the <em>Erlang solution stack</em>. In particular if you are running
your code on top of ERTS you will need to know the components of
the <em>ERTS Stack</em>.</p></div>
<div class="paragraph"><p>In <a href="#the_erts_stack">[the_erts_stack]</a> you can see the ERTS Stack illustrated with
two Erlang nodes running on one machine.</p></div>
<div class="paragraph"><p>At the bottom of the stack there is the hardware you are running
on. The easiest way to improve the performance of your app is probably
to run it on better hardware. If economical or physical constraints
won&#8217;t let you upgrade your hardware you can start exploring higher
levels of the stack. The two most important choices for your hardware
is whether it is multicore and whether it is 32-bit or 64-bit. You
need different builds of ERTS depending on whether you want to use
multicore or not and whether you want to use 32-bit or 64-bit. (See
<a href="#CH-BuildingERTS">[CH-BuildingERTS]</a> for information on how to build different
versions of ERTS).  This book will not go into any details about
hardware but I will talk a bit about multicore and NUMA architectures
in <a href="#CH-Scheduling">[CH-Scheduling]</a> and <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
<div class="paragraph"><p>The second layer in the stack is the OS level. ERTS runs on most
versions of Windows and most POSIX "compliant" OS:es, including Linux,
VxWorks, Solaris, and Mac OS X. Today most of the development of ERTS
is done on Linux and OS X, and you can expect the best performance on
these platforms. However, Ericsson have been using Solaris internally
in many projects and ERTS has been tuned for Solaris for many years.
Depending on your use case you might actually get better performance on
a Solaris system. The OS choice is usually not based on performance
requirements, but is restricted by other demands. If you are building
an embedded application you might be restricted to Raspbian or VxWorks,
and if you are for some reason building an end user or client
application you might have to use Windows. The Windows port of ERTS
has so far not had the highest priority and might not be the best
choice from a performance or maintenance perspective. If you want to
use a 64-bit ERTS you of course need to have both a 64-bit machine and
a 64-bit OS. I will not cover many OS specific questions in this book.</p></div>
<div class="paragraph"><p>The third layer in the stack is the Erlang Runtime System. In our case
this will be ERTS. This and the next layer, the Erlang Virtual Machine
(BEAM), is what this book is all about. In the rest of <a href="#P-ERTS">[P-ERTS]</a>
you will see how these layers work and are implemented, and in
<a href="#P-Running">[P-Running]</a> you will see how you can tune ERTS to give your
application optimal performance.</p></div>
<div class="paragraph"><p>The fifth layer, OTP, supplies the Erlang standard
libraries. OTP originally stood for "Open Telecom Platform" and was a
number of Erlang libraries supplying building blocks (such as
<span class="monospaced">supervisor</span>, <span class="monospaced">gen_server</span> and <span class="monospaced">gen_ftp</span>) for building robust
applications (such as telephony exchanges). Early on, the libraries
and the meaning of OTP got intermingled with all the other standard
libraries shipped with ERTS. Nowadays most people use OTP together
with Erlang in "Erlang/OTP" as the name for ERTS and all Erlang
libraries shipped by Ericsson. Knowing these standard libraries
and how and when to use them can greatly improve the performance
of your application. This book will not go into any details about
the standard libraries and OTP, since there are other books that
cover these aspects.</p></div>
<div class="paragraph"><p>Finally, the sixth layer (APP) is your application which can use all
the functionality provided by the underlying layers. Apart from
upgrading your hardware this is probably the place where you most
easily can improve your application&#8217;s performance. In
<a href="#CH-Tracing">[CH-Tracing]</a> I will give some hints and show some tools that can
help you profile and optimize your application. In <a href="#CH-Crash">[CH-Crash]</a> and
<a href="#CH-Debugger">[CH-Debugger]</a> I&#8217;ll give you some hints on how to find the cause
of crashing applications and how to find bugs in your application.</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__1.png" alt="book__1.png">
</div>
</div>
<div class="paragraph"><p>For information on how to build and run an Erlang node
see <a href="#CH-BuildingERTS">[CH-BuildingERTS]</a>, and read the rest of the book to
learn all about the components of an Erlang node.</p></div>
</div>
<div class="sect3">
<h4 id="_the_erlang_compiler">The Erlang Compiler</h4>
<div class="paragraph"><p>The Erlang Compiler is responsible for compiling Erlang source code,
from .erl files into virtual machine code for BEAM (the virtual
machine). The compiler itself is written in Erlang and compiled by
itself to BEAM code and usually available in a running Erlang node.
To bootstrap the runtime system there are a number of precompiled
BEAM files, including the compiler, in the bootstrap directory.</p></div>
<div class="paragraph"><p>For more information about the compiler see <a href="#CH-Compiler">[CH-Compiler]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_the_erlang_virtual_machine_beam">The Erlang Virtual Machine: BEAM</h4>
<div class="paragraph"><p>BEAM is the Erlang virtual machine used for executing Erlang code,
just like the JVM is used for executing Java code. BEAM runs in an
Erlang Node.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p><strong>BEAM:</strong> The name BEAM originally stood for Bogdan&#8217;s Erlang Abstract
 Machine, but now a days most people refer to it as Bj&ouml;rn&#8217;s
Erlang Abstract machine, after the current maintainer.</p></div>
</div></div>
<div class="paragraph"><p>Just as ERTS is an implementation of a more general concept of a Erlang
Runtime System so is BEAM an implementation of a more general Erlang Virtual
Machine (EVM).
There is no definition of what constitutes an EVM but BEAM actually has two
levels of instructions <em>Generic Instructions</em> and <em>Specific Instructions</em>.
The generic instruction set could be seen as a blueprint for an EVM.</p></div>
<div class="paragraph"><p>For a full description of BEAM see <a href="#CH-BEAM">[CH-BEAM]</a>, <a href="#CH-beam_modules">[CH-beam_modules]</a>
and <a href="#CH-Instructions">[CH-Instructions]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_processes">Processes</h4>
<div class="paragraph"><p>An Erlang process basically works like an OS process. Each process has
its own memory (a mailbox, a heap and a stack) and a process control
block (PCB) with information about the process.</p></div>
<div class="paragraph"><p>All Erlang code execution is done within the context of a process. One
Erlang node can have many processes, which can communicate through
message passing and signals. Erlang processes can also communicate with
processes on other Erlang nodes as long as the nodes are connected.</p></div>
<div class="paragraph"><p>To learn more about processes and the PCB see <a href="#CH-Processes">[CH-Processes]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_scheduling">Scheduling</h4>
<div class="paragraph"><p>The Scheduler is responsible for choosing the Erlang process to execute.
Basically the scheduler keeps two queues, a <em>ready queue</em> of processes
ready to run, and a <em>waiting queue</em> of processes waiting to receive a
message. When a process in the waiting queue receives a message or get
a time out it is moved to the ready queue.</p></div>
<div class="paragraph"><p>The scheduler picks the first process from the ready queue and hands it
to BEAM for execution of one <em>time slice</em>. BEAM preempts the running
process when the time slice is used up and adds the processes to the
end of the ready queue. If the process is blocked in a receive before
the time slice is used up, it gets added to the waiting queue instead.</p></div>
<div class="paragraph"><p>Erlang is concurrent by nature, that is, each process is conceptually
running at the same time as all other processes, but in reality there
is just one process running in the VM. On a multicore machine Erlang
actually runs more than one scheduler, usually one per physical core,
each having their own queues. This way Erlang achieves true
parallelism. To utilize more than one core ERTS has to be built (see
<a href="#CH-BuildingERTS">[CH-BuildingERTS]</a>) in <em>SMP</em> mode. SMP stands for
<em>Symetric MultiProcessing</em>, that is, the ability to execute a
processes on any one of multiple CPUs.</p></div>
<div class="paragraph"><p>In reality the picture is more complicated with priorities among
processes and the waiting queue is implemented through a timing wheel.
All this and more is described in detail in <a href="#CH-Scheduling">[CH-Scheduling]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_the_erlang_tag_scheme">The Erlang Tag Scheme</h4>
<div class="paragraph"><p>Erlang is a dynamically typed language, and the runtime system needs a
way to keep track of the type of each data object. This is done with a
tagging scheme. Each data object or pointer to a data object also has
a tag with information about the data type of the object.</p></div>
<div class="paragraph"><p>Basically some bits of a pointer are reserved for the tag, and the
emulator can then determine the type of the object by looking at the
bit pattern of the tag.</p></div>
<div class="paragraph"><p>These tags are used for pattern matching and for type test and for
primitive operations as well as by the garbage collector.</p></div>
<div class="paragraph"><p>The complete tagging scheme is described in <a href="#CH-TypeSystem">[CH-TypeSystem]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_memory_handling">Memory Handling</h4>
<div class="paragraph"><p>Erlang uses automatic memory management and the programmer does not
have to worry about memory allocation and deallocation. Each process
has a heap and a stack which both can grow, and shrink, as needed.</p></div>
<div class="paragraph"><p>When a process runs out of heap space, the VM will first try to
reclaim free heap space through garbage collection. The garbage collector
will then go through the process stack and heap and copy live data
to a new heap while throwing away all the data that is dead. If there
still isn&#8217;t enough heap space, a new larger heap will be allocated and
the live data is moved there.</p></div>
<div class="paragraph"><p>The details of the current generational copying garbage collector, including
the handling of reference counted binaries can be found in <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
<div class="paragraph"><p>In a system which uses HiPE compiled native code, each process actually has
two stacks, a BEAM stack and a native stack, the details can be found in
<a href="#CH-Native">[CH-Native]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_the_interpreter_and_the_command_line_interface">The Interpreter and the Command Line Interface</h4>
<div class="paragraph"><p>When you start an Erlang node with <span class="monospaced">erl</span> you get a command prompt.
This is the <em>Erlang read eval print loop</em> (REPL) or the <em>command line
interface</em> (CLI) or simply the <em>Erlang shell</em>.</p></div>
<div class="paragraph"><p>You can actually type in Erlang code and execute it directly from the
shell. In this case the code is not compiled to BEAM code and executed by
the BEAM, instead the code is parsed and interpreted by the Erlang
interpreter. In general the interpreted code behaves exactly as compiled
code, but there a few subtle differences, these differences and all other
aspects of the shell are explained in <a href="#CH-Shell">[CH-Shell]</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Other_Erlang_Implementations">Other Erlang Implementations</h3>
<div class="paragraph"><p>This book is mainly concerned with the "standard" Erlang
implementation by Ericsson/OTP called ERTS, but there are a few other
implementations available and in this section I will discuss some of
them briefly.</p></div>
<div class="paragraph"><p>Throught the book I will sometimes mention differences between other
implementations and ERTS, but there is no guarantee that I will
mention all differences.</p></div>
<div class="sect3">
<h4 id="_erlang_on_xen">Erlang on Xen</h4>
<div class="paragraph"><p>Erlang on Xen (link:http://erlangonxen.org) is an Erlang implementation
running directly on server hardware with no OS layer in between, only
a thin Xen client.</p></div>
<div class="paragraph"><p>Ling, the virtual machine of Erlang on Xen is almost 100% binary compatible
with BEAM. In xref:the_eox_stack you can see how the Erlang on Xen implementation
of the Erlang Solution Stack differs from the ERTS Stack. The thing to note here
is that there is no operating system in the Erlang on Xen stack.</p></div>
<div class="paragraph"><p>Since Ling implements the generic instruction set of BEAM, it can reuse
the BEAM compiler from the OTP layer to compile Erlang to Ling.</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__2.png" alt="book__2.png">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_erjang">Erjang</h4>
<div class="paragraph"><p>Erjang (link:http://erjang.org) is an Erlang implementation which runs
on the JVM. It loads <span class="monospaced">.beam</span> files and recompile the code to Java <span class="monospaced">.class</span>
files. Erjang is almost 100% binary compatible with (generic) BEAM.</p></div>
<div class="paragraph"><p>In xref:the_erjang_stack you can see how the Erjang implementation
of the Erlang Solution Stack differs from the ERTS Stack. The thing
to note here is that JVM has replaced BEAM as the virtual machine
and that Erjang provides the services of ERTS by implementing them
in Java on top of the VM.</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__3.png" alt="book__3.png">
</div>
</div>
<div class="paragraph"><p>Now that you have a basic understanding of all the major pieces of
ERTS, and the necessary vocabulary you can dive into the details of
each component. If you are eager to understand a certain component,
you can jump directly to that chapter. Or if you are really eager to
find a solution to a specific problem you could jump to the right
chapter in <a href="#P-Running">[P-Running]</a>, and try the different methods to tune,
tweak, or debug your system. Although, I strongly suggest that you
read through the chapters in <a href="#P-ERTS">[P-ERTS]</a> in order to first get
a deep understanding of how ERTS really works.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Compiler">The Compiler</h2>
<div class="sectionbody">
<div class="paragraph"><p>This book will not cover the programming language Erlang, but since
the goal of the ERTS is to run Erlang code you will need to know how
to compile Erlang code. In this chapter we will cover the compiler
options needed to generate readable beam code and how to add debug
information to the generated beam file. At the end of the chapter
there is also a section on the Elixir compiler.</p></div>
<div class="paragraph"><p>For those readers interested in compiling their own favorite language
to ERTS this chapter will also contain detailed information about the
different intermediate formats in the compiler and how to plug your
compiler into the beam compiler backend. I will also present parse
transforms and give examples of how to use them to tweak the Erlang
language.</p></div>
<div class="sect2">
<h3 id="_compiling_erlang">Compiling Erlang</h3>
<div class="paragraph"><p>Erlang is compiled from source code modules in <span class="monospaced">.erl</span> files
to fat binary <span class="monospaced">.beam</span> files.</p></div>
<div class="paragraph"><p>The compiler can be run from the OS shell with the <span class="monospaced">erlc</span> command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> erlc foo<span style="color: #990000">.</span>erl</tt></pre></div></div>
<div class="paragraph"><p>Alternatively the compiler can be invoked from the Erlang shell with
the default shell command <span class="monospaced">c</span> or by calling <span class="monospaced">compile:file/{1,2}</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">foo</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">compile:file</span></span>(<span style="color: #FF6600">foo</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>The optional second argument to <span class="monospaced">compile:file</span> is a list of compiler
options. A full list of the options can be found in the documentation
of the compile module: see <a href="http://www.erlang.org/doc/man/compile.html">http://www.erlang.org/doc/man/compile.html</a>.</p></div>
<div class="paragraph"><p>Normally the compiler will compile Erlang source code from a <span class="monospaced">.erl</span>
file and write the resulting binary beam code to a <span class="monospaced">.beam</span> file. You
can also get the resulting binary back as an Erlang term
by giving the option <span class="monospaced">binary</span> to the compiler. This
option has then been overloaded to mean return any intermediate format
as a term instead of writing to a file. If you for example want the
compiler to return Core Erlang code you can give the options <span class="monospaced">[core,
 binary]</span>.</p></div>
<div class="paragraph"><p>The compiler is made up of a number of passes as illustrated in
<a href="#fig_compiler_passes">Compiler Passes</a>.</p></div>
<div class="imageblock shaape" id="fig_compiler_passes">
<div class="content">
<img src="book__4.png" alt="book__4.png">
</div>
<div class="title">Figure 1. Compiler Passes.</div>
</div>
<div class="paragraph"><p>If you want to see a complete and up to date list of compiler passes
you can run the function <span class="monospaced">compile:options/0</span> in an Erlang shell.
The definitive source for information about the compiler is of course
the source:
  <a href="https://github.com/erlang/otp/blob/maint/lib/compiler/src/compile.erl">compile.erl</a></p></div>
</div>
<div class="sect2">
<h3 id="_generating_intermediate_output">Generating Intermediate Output</h3>
<div class="paragraph"><p>Looking at the code produced by the compiler is a great help in trying
to understand how the virtual machine works. Fortunately, the compiler
can show us the intermediate code after each compiler pass and the
final beam code.</p></div>
<div class="paragraph"><p>Let us try out our newfound knowledge to look at the generated code.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">compile:options</span></span>()<span style="color: #990000">.</span>
 <span style="color: #FF6600">dpp</span> <span style="color: #990000">-</span> <span style="color: #009900">Generate</span> <span style="color: #990000">.</span><span style="color: #FF6600">pp</span> <span style="color: #FF6600">file</span>
 <span style="color: #FF6600">'P'</span> <span style="color: #990000">-</span> <span style="color: #009900">Generate</span> <span style="color: #990000">.</span><span style="color: #009900">P</span> <span style="color: #FF6600">source</span> <span style="color: #FF6600">listing</span> <span style="color: #FF6600">file</span></tt></pre></div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>...</pre>
</div></div>
<div class="listingblock">
<div class="content monospaced">
<pre> 'E' - Generate .E source listing file</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>...</pre>
</div></div>
<div class="listingblock">
<div class="content monospaced">
<pre> 'S' - Generate .S file</pre>
</div></div>
<div class="paragraph"><p>Let us try with a small example program "world.erl":</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">world</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">hello</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-include</span></span>(<span style="color: #FF0000">"world.hrl"</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">hello</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">?GREETING</span></span><span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="paragraph"><p>And the include file "world.hrl"</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">GREETING</span>, <span style="color: #FF0000">"hello world"</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>If you now compile this with the <em>P</em> option to get the parsed file you
get a file "world.P":</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">world</span>, [<span style="color: #FF6600">'P'</span>])<span style="color: #990000">.</span>
<span style="color: #990000">**</span> <span style="color: #009900">Warning</span><span style="color: #990000">:</span> <span style="color: #009900">No</span> <span style="color: #FF6600">object</span> <span style="color: #FF6600">file</span> <span style="color: #FF6600">created</span> <span style="color: #990000">-</span> <span style="color: #FF6600">nothing</span> <span style="color: #FF6600">loaded</span> <span style="color: #990000">**</span>
<span style="color: #FF6600">ok</span></tt></pre></div></div>
<div class="paragraph"><p>In the resulting <span class="monospaced">.P</span> file you can see a pretty printed version of
the code after the preprocessor (and parse transformation) has been
applied:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.erl"</span>, <span style="color: #993399">1</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">world</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">hello</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.hrl"</span>, <span style="color: #993399">1</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.erl"</span>, <span style="color: #993399">4</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">hello</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="color: #FF0000">"hello world"</span><span style="color: #990000">.</span>


</tt></pre></div></div>
<div class="paragraph"><p>To see how the code looks after all source code transformations are
done, you can compile the code with the <span class="monospaced"><em>E</em></span>-flag.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">world</span>, [<span style="color: #FF6600">'E'</span>])<span style="color: #990000">.</span>
<span style="color: #990000">**</span> <span style="color: #009900">Warning</span><span style="color: #990000">:</span> <span style="color: #009900">No</span> <span style="color: #FF6600">object</span> <span style="color: #FF6600">file</span> <span style="color: #FF6600">created</span> <span style="color: #990000">-</span> <span style="color: #FF6600">nothing</span> <span style="color: #FF6600">loaded</span> <span style="color: #990000">**</span>
<span style="color: #FF6600">ok</span></tt></pre></div></div>
<div class="paragraph"><p>This gives us an <span class="monospaced">.E</span> file, in this case all compiler directives have
been removed and the build in functions <span class="monospaced">module_info/{1,2}</span> have been
added to the source:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-vsn</span></span>(<span style="color: #FF0000">"\002"</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.erl"</span>, <span style="color: #993399">1</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.hrl"</span>, <span style="color: #993399">1</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-file</span></span>(<span style="color: #FF0000">"world.erl"</span>, <span style="color: #993399">5</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">hello</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="color: #FF0000">"hello world"</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">erlang:get_module_info</span></span>(<span style="color: #FF6600">world</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>(<span style="color: #009900">X</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">erlang:get_module_info</span></span>(<span style="color: #FF6600">world</span>, <span style="color: #009900">X</span>)<span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="paragraph"><p>We will make use of the <em>P</em> and <em>E</em> options when we look at parse
transforms in <a href="#SEC-parse_transform">[SEC-parse_transform]</a>, but first we will take a
look at an "assembler" view of generated BEAM code. By giving the
option <span class="monospaced"><em>S</em></span> to the compiler you get a <span class="monospaced">.S</span> file with Erlang terms
for each BEAM instruction in the code.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">world</span>, [<span style="color: #FF6600">'S'</span>])<span style="color: #990000">.</span>
<span style="color: #990000">**</span> <span style="color: #009900">Warning</span><span style="color: #990000">:</span> <span style="color: #009900">No</span> <span style="color: #FF6600">object</span> <span style="color: #FF6600">file</span> <span style="color: #FF6600">created</span> <span style="color: #990000">-</span> <span style="color: #FF6600">nothing</span> <span style="color: #FF6600">loaded</span> <span style="color: #990000">**</span>
<span style="color: #FF6600">ok</span></tt></pre></div></div>
<div class="paragraph"><p>The file <span class="monospaced">world.S</span> should look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="color: #FF6600">module</span>, <span style="color: #FF6600">world</span>}<span style="color: #990000">.</span>  <span style="font-style: italic"><span style="color: #9A1900">%% version = 0</span></span>

{<span style="color: #FF6600">exports</span>, [{<span style="color: #FF6600">hello</span>,<span style="color: #993399">0</span>},{<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>,<span style="color: #993399">0</span>},{<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>,<span style="color: #993399">1</span>}]}<span style="color: #990000">.</span>

{<span style="color: #FF6600">attributes</span>, []}<span style="color: #990000">.</span>

{<span style="color: #FF6600">labels</span>, <span style="color: #993399">7</span>}<span style="color: #990000">.</span>


{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #FF6600">hello</span>, <span style="color: #993399">0</span>, <span style="color: #993399">2</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">line</span>,[{<span style="color: #FF6600">location</span>,<span style="color: #FF0000">"world.erl"</span>,<span style="color: #993399">6</span>}]}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">world</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">hello</span>},<span style="color: #993399">0</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">literal</span>,<span style="color: #FF0000">"hello world"</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    <span style="color: #FF6600">return</span><span style="color: #990000">.</span>


{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="font-weight: bold"><span style="color: #000080">module_info</span></span>, <span style="color: #993399">0</span>, <span style="color: #993399">4</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">3</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">line</span>,[]}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">world</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>},<span style="color: #993399">0</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">4</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">world</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">line</span>,[]}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">call_ext_only</span>,<span style="color: #993399">1</span>,{<span style="color: #FF6600">extfunc</span>,<span style="color: #FF6600">erlang</span>,<span style="color: #FF6600">get_module_info</span>,<span style="color: #993399">1</span>}}<span style="color: #990000">.</span>


{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="font-weight: bold"><span style="color: #000080">module_info</span></span>, <span style="color: #993399">1</span>, <span style="color: #993399">6</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">5</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">line</span>,[]}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">world</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="font-weight: bold"><span style="color: #000080">module_info</span></span>},<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">6</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">world</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">line</span>,[]}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">call_ext_only</span>,<span style="color: #993399">2</span>,{<span style="color: #FF6600">extfunc</span>,<span style="color: #FF6600">erlang</span>,<span style="color: #FF6600">get_module_info</span>,<span style="color: #993399">2</span>}}<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Since this is a file with dot ("<em>.</em>") separated Erlang terms, you can
read the file back into the Erlang shell with:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{ok, BEAM_Code} = file:consult("world.S").</pre>
</div></div>
<div class="paragraph"><p>The assembler code mostly follows the layout of the original source
code.</p></div>
<div class="paragraph"><p>The first instruction defines the module name of the code. The version
mentioned in the comment (<span class="monospaced">%% version = 0</span>) is the version of the beam
opcode format (as given by <span class="monospaced">beam_opcodes:format_number/0</span>).</p></div>
<div class="paragraph"><p>Then comes a list of exports and any compiler attributes (none in this
example) much like in any Erlang source module.</p></div>
<div class="paragraph"><p>The first real beam-like instruction is <span class="monospaced">{labels, 7}</span> which tells the
VM the number of lables in the code to make it possible to allocate
room for all lables in one pass over the code.</p></div>
<div class="paragraph"><p>After that there is the actual code for each function. The first
instruction gives us the function name, the arity and the entry point
as a label number.</p></div>
<div class="paragraph"><p>You can use the <span class="monospaced"><em>S</em></span> option with great effect to help you understand
how the BEAM works, and we will use it like that in later chapters. It
is also invaluable if you develop your own language that you compile
to the BEAM through Core Erlang, to see the generated code.</p></div>
</div>
<div class="sect2">
<h3 id="_compiler_passes">Compiler Passes</h3>
<div class="paragraph"><p>In the following sections we will go through most of the compiler
passes shown in <a href="#fig_compiler_passes">[fig_compiler_passes]</a>. For a language designer
targeting the BEAM this is interesting since it will show you what you
can accomplish with the different approaches: macros, parse
transforms, core erlang, and BEAM code, and how they depend on each
other.</p></div>
<div class="paragraph"><p>When tuning Erlang code, it is good to know what optimizations are
applied when, and how you can look at generated code before and
after optimizations.</p></div>
<div class="sect3">
<h4 id="_compiler_pass_the_erlang_preprocessor_epp">Compiler Pass: The Erlang Preprocessor (epp)</h4>
<div class="paragraph"><p>The compilation starts with a combined tokenizer (or scanner) and
preprocessor. That is, the preprosessor drives the tokenizer.
This means that macros are expanded as tokens, so
it is not a pure string replacement (as for example m4 or cpp).
You can not use Erlang macros to define your own syntax, a macro
will expand as a separate token from its surrounding characters.
You can not concatenate a macro and a character to a token:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #FF6600">plus</span>,<span style="color: #990000">+</span>)<span style="color: #990000">.</span>
<span style="color: #FF6600">t</span>(<span style="color: #009900">A</span>,<span style="color: #009900">B</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">A</span><span style="font-weight: bold"><span style="color: #000080">?plus</span></span><span style="color: #990000">+</span><span style="color: #009900">B</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>This will expand to</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>t(A,B) -&gt; A + + B.</pre>
</div></div>
<div class="paragraph"><p>and not</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>t(A,B) -&gt; A ++ B.</pre>
</div></div>
<div class="paragraph"><p>On the other hand since macro expansion is done on the token
level, you do not need to have a valid Erlang term in the
right hand side of the macro, as long as you use it in a way
that gives you a valid term. E.g.:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-define(p,o, o]).
 t() -&gt; [f,?p.</pre>
</div></div>
<div class="paragraph"><p>There are few real useages for this other than to win the
obfuscated Erlang code contest. The main point to remember is that
you can not really use the Erlang preprocessor to define a language
with a syntax that differs from Erlang. Fortunately there are
other ways to do this, as you shall see later.</p></div>
</div>
<div class="sect3">
<h4 id="SEC-parse_transform">Compiler Pass: Parse Transformations</h4>
<div class="paragraph"><p>The easiest way to tweak the Erlang language is through Parse
Transformations (or parse transforms). Parse Transformations comes
with all sorts of warnings, like this note in the OTP documentation:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning">
</td>
<td class="content">Programmers are strongly advised not to engage in parse
transformations and no support is offered for problems encountered.</td>
</tr></table>
</div>
<div class="paragraph"><p>When you use a parse transform you are basically writing an extra pass
in the compiler and that can if you are not careful lead to very
unexpected results. But to use a parse transform you have to declare
the usage in the module using it, and it will be local to that module,
so as far as compiler tweaks goes this one is quite safe.</p></div>
<div class="paragraph"><p>The biggest problem with parse transforms as I see it is that you
are inventing your own syntax, and it will make it more difficult
for anyone else reading your code. At least until your parse transform
has become as popular and widely used as e.g. QLC.</p></div>
<div class="paragraph"><p>OK, so you know you shouldn&#8217;t use it, but if you have to, here is what
you need to know. A parse transforms is a function that works on the
abstract syntax tree (AST) (see
<a href="http://www.erlang.org/doc/apps/erts/absform.html">http://www.erlang.org/doc/apps/erts/absform.html</a> ). The compiler
does preprocessing, tokenization and parsing and then it will call the
parse transform function with the AST and expects to get back a
new AST.</p></div>
<div class="paragraph"><p>This means that you can&#8217;t change the Erlang syntax fundamentally, but
you can change the semantics. Lets say for example that you for some
reason would like to write json code directly in your Erlang code,
then you are in luck since the tokens of json and of Erlang are
basically the same. Also, since the Erlang compiler does most of
its sanity checks in the linter pass which follows the parse transform
pass, you can allow an AST which does not represent valid Erlang.</p></div>
<div class="paragraph"><p>To write a parse transform you need to write an Erlang module (lets
call it <em>p</em>) which exports the function <span class="monospaced">parse_transform/2</span>. This
function is called by the compiler during the parse transform pass if
the module being compiled (lets call it <em>m</em>) contains the compiler
option <span class="monospaced">{parse_transform, p}</span>. The arguments to the funciton is the
AST of the module m and the compiler options given to the call to the
compiler.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p>Note that you will not get any compiler options given in the file, this
is a bit of a nuisance since you can&#8217;t give options to the parse transform
from the code.</p></div>
<div class="paragraph"><p>The compiler does not expand compiler options until the <em>expand</em> pass
which occures after the parse transform pass.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The documenation of the abstract format is somewhat dense and it is
quite hard to get a grip on the abstract format by reading the
documentation. I encourage you to use the <em>syntax_tools</em> and
especially <span class="monospaced">erl_syntax_lib</span> for any serious work on the AST.</p></div>
<div class="paragraph"><p>Here we will develop a a simple parse transform just to get an
understanding of the AST. Therefore we will work directly on the AST
and use the old reliable <span class="monospaced">io:format</span> approach instead of syntax_tools.</p></div>
<div class="paragraph"><p>First we create an example of what we would like to be able to compile
json_test.erl:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">json_test</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-compile</span></span>({<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span>, <span style="color: #FF6600">json_parser</span>})<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">/</span><span style="color: #993399">1</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span>(<span style="color: #009900">V</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span>{{
      <span style="color: #FF0000">"name"</span>  <span style="color: #990000">:</span> <span style="color: #FF0000">"Jack (\"Bee\") Nimble"</span>,
      <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> {
                 <span style="color: #FF0000">"type"</span>      <span style="color: #990000">:</span> <span style="color: #FF0000">"rect"</span>,
                 <span style="color: #FF0000">"widths"</span>     <span style="color: #990000">:</span> [<span style="color: #993399">1920</span>,<span style="color: #993399">1600</span>],
                 <span style="color: #FF0000">"height"</span>    <span style="color: #990000">:</span> (<span style="color: #990000">-</span><span style="color: #993399">1080</span>),
                 <span style="color: #FF0000">"interlace"</span> <span style="color: #990000">:</span> <span style="color: #000080">false</span>,
                 <span style="color: #FF0000">"frame rate"</span><span style="color: #990000">:</span> <span style="color: #009900">V</span>
                }
      }}<span style="color: #990000">&gt;&gt;.</span></tt></pre></div></div>
<div class="paragraph"><p>Then we create a minimal parse transform module <span class="monospaced">json_parser.erl</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">json_parser</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span>(<span style="color: #009900">AST</span>, <span style="color: #009900">_Options</span>) <span style="color: #990000">-&gt;</span>
  <span style="font-weight: bold"><span style="color: #000000">io:format</span></span>(<span style="color: #FF0000">"~p~n"</span>, [<span style="color: #009900">AST</span>]),
  <span style="color: #009900">AST</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>This identity parse transform returns an unchanged AST but it also prints
it out so that you can see what an AST looks like.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; c(json_parser).
{ok,json_parser}
2&gt; c(json_test).
[{attribute,1,file,{"./json_test.erl",1}},
 {attribute,1,module,json_test},
 {attribute,3,export,[{test,1}]},
 {function,5,test,1,
  [{clause,5,
    [{var,5,'V'}],
    [],
    [{bin,6,
      [{bin_element,6,
        {tuple,6,
         [{tuple,6,
           [{remote,7,{string,7,"name"},{string,7,"Jack (\"Bee\") Nimble"}},
            {remote,8,
             {string,8,"format"},
             {tuple,8,
              [{remote,9,{string,9,"type"},{string,9,"rect"}},
               {remote,10,
                {string,10,"widths"},
                {cons,10,
                 {integer,10,1920},
                 {cons,10,{integer,10,1600},{nil,10}}}},
               {remote,11,{string,11,"height"},{op,11,'-',{integer,11,1080}}},
               {remote,12,{string,12,"interlace"},{atom,12,false}},
               {remote,13,{string,13,"frame rate"},{var,13,'V'}}]}}]}]},
        default,default}]}]}]},
 {eof,16}]
./json_test.erl:7: illegal expression
./json_test.erl:8: illegal expression
./json_test.erl:5: Warning: variable 'V' is unused
error</pre>
</div></div>
<div class="paragraph"><p>The compilation of <span class="monospaced">json_test</span> fails since the module contains invalid
Erlang syntax, but you get to see what the AST looks like. Now we can
just write some functions to traverse the AST and rewrite the json
code into Erlang code.<span class="footnote"><br>[The translation here is done in
accordance with EEP 18 (Erlang Enhancement Proposal 18: "JSON bifs")
link:http://www.erlang.org/eeps/eep-0018.html]<br></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">json_parser</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span>(<span style="color: #009900">AST</span>, <span style="color: #009900">_Options</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">AST</span>, [])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">FUNCTION</span>(<span style="color: #009900">Clauses</span>), {<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #009900">Label</span>, <span style="color: #009900">Name</span>, <span style="color: #009900">Arity</span>, <span style="color: #009900">Clauses</span>})<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We are only interested in code inside functions.</span></span>
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([<span style="font-weight: bold"><span style="color: #000080">?FUNCTION</span></span>(<span style="color: #009900">Clauses</span>) | <span style="color: #009900">Elements</span>], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">Elements</span>, [<span style="font-weight: bold"><span style="color: #000080">?FUNCTION</span></span>(<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>(<span style="color: #009900">Clauses</span>)) | <span style="color: #009900">Res</span>]);
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([<span style="color: #009900">Other</span>|<span style="color: #009900">Elements</span>], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">Elements</span>, [<span style="color: #009900">Other</span> | <span style="color: #009900">Res</span>]);
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Res</span>)<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We are interested in the code in the body of a function.</span></span>
<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>([{<span style="color: #FF6600">clause</span>, <span style="color: #009900">CLine</span>, <span style="color: #009900">A1</span>, <span style="color: #009900">A2</span>, <span style="color: #009900">Code</span>} | <span style="color: #009900">Clauses</span>]) <span style="color: #990000">-&gt;</span>
    [{<span style="color: #FF6600">clause</span>, <span style="color: #009900">CLine</span>, <span style="color: #009900">A1</span>, <span style="color: #009900">A2</span>, <span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">Code</span>)} | <span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>(<span style="color: #009900">Clauses</span>)];
<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>([]) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">JSON</span>(<span style="color: #009900">Json</span>), {<span style="color: #FF6600">bin</span>, <span style="color: #990000">_</span>, [{<span style="color: #FF6600">bin_element</span>
                                         , <span style="color: #990000">_</span>
                                         , {<span style="color: #FF6600">tuple</span>, <span style="color: #990000">_</span>, [<span style="color: #009900">Json</span>]}
                                         , <span style="color: #990000">_</span>
                                         , <span style="color: #990000">_</span>}]})<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term</span></span>
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>([])                     <span style="color: #990000">-&gt;</span> [];
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>([<span style="font-weight: bold"><span style="color: #000080">?JSON</span></span>(<span style="color: #009900">Json</span>)|<span style="color: #009900">MoreCode</span>]) <span style="color: #990000">-&gt;</span> [<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Json</span>) | <span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">MoreCode</span>)];
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">Code</span>)                   <span style="color: #990000">-&gt;</span> <span style="color: #009900">Code</span><span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% Json Object -&gt; [{}] | [{Lable, Term}]</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">tuple</span>,<span style="color: #009900">Line</span>,[]})            <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, {<span style="color: #FF6600">tuple</span>, <span style="color: #009900">Line</span>, []}};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">tuple</span>,<span style="color: #009900">Line</span>,<span style="color: #009900">Fields</span>})        <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>(<span style="color: #009900">Fields</span>,<span style="color: #009900">Line</span>);
<span style="font-style: italic"><span style="color: #9A1900">%% Json Array -&gt; List</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>})   <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Head</span>),
                                                       <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Tail</span>)};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">nil</span>, <span style="color: #009900">Line</span>})                <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">nil</span>, <span style="color: #009900">Line</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json String -&gt; &lt;</span></span><span style="font-weight: bold"><span style="color: #0000FF">&lt;String&gt;</span></span><span style="font-style: italic"><span style="color: #9A1900">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">string</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">String</span>})     <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">String</span>, <span style="color: #009900">Line</span>);
<span style="font-style: italic"><span style="color: #9A1900">%% Json Integer -&gt; Intger</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Integer</span>})   <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Integer</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Float -&gt; Float</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">float</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Float</span>})       <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">float</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Float</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Constant -&gt; true | false | null</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">true</span>})         <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">true</span>};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">false</span>})        <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">false</span>};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">null</span>})         <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">null</span>};

<span style="font-style: italic"><span style="color: #9A1900">%% Variables, should contain Erlang encoded Json</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">var</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Var</span>})         <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">var</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Var</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Negative Integer or Float</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">'-'</span>, {<span style="color: #009900">Type</span>, <span style="color: #990000">_</span>, <span style="color: #009900">N</span>}}) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #009900">Type</span> <span style="color: #990000">=:=</span> <span style="font-weight: bold"><span style="color: #000080">integer</span></span>
                                             ; <span style="color: #009900">Type</span> <span style="color: #990000">=:=</span> <span style="font-weight: bold"><span style="color: #000080">float</span></span> <span style="color: #990000">-&gt;</span>
                                          {<span style="color: #009900">Type</span>, <span style="color: #009900">Line</span>, <span style="font-weight: bold"><span style="color: #000080">-N</span></span>}<span style="color: #990000">.</span>
<span style="font-style: italic"><span style="color: #9A1900">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.</span></span>

<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">FIELD</span>(<span style="color: #009900">Lable</span>, <span style="color: #009900">Code</span>), {<span style="color: #FF6600">remote</span>, <span style="color: #009900">L</span>, {<span style="color: #FF6600">string</span>, <span style="color: #990000">_</span>, <span style="color: #009900">Label</span>}, <span style="color: #009900">Code</span>})<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>([], <span style="color: #009900">L</span>) <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">nil</span>, <span style="color: #009900">L</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Label : Json-Term  --&gt; [{&lt;</span></span><span style="font-weight: bold"><span style="color: #0000FF">&lt;Label&gt;</span></span><span style="font-style: italic"><span style="color: #9A1900">&gt;, Term} | Rest]</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>([<span style="font-weight: bold"><span style="color: #000080">?FIELD</span></span>(<span style="color: #009900">Lable</span>, <span style="color: #009900">Code</span>) | <span style="color: #009900">Rest</span>], <span style="color: #990000">_</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">cons</span></span>(<span style="font-weight: bold"><span style="color: #000000">tuple</span></span>(<span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">Label</span>, <span style="color: #009900">L</span>), <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Code</span>), <span style="color: #009900">L</span>)
         , <span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>(<span style="color: #009900">Rest</span>, <span style="color: #009900">L</span>)
         , <span style="color: #009900">L</span>)<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">tuple</span></span>(<span style="color: #009900">E1</span>, <span style="color: #009900">E2</span>, <span style="color: #009900">Line</span>)    <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">tuple</span>, <span style="color: #009900">Line</span>, [<span style="color: #009900">E1</span>, <span style="color: #009900">E2</span>]}<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">cons</span></span>(<span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>, <span style="color: #009900">Line</span>) <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">String</span>, <span style="color: #009900">Line</span>) <span style="color: #990000">-&gt;</span>
    {<span style="color: #FF6600">bin</span>
     , <span style="color: #009900">Line</span>
     , [{<span style="color: #FF6600">bin_element</span>
         , <span style="color: #009900">Line</span>
         , {<span style="color: #FF6600">string</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">String</span>}
         , <span style="color: #FF6600">default</span>
         , <span style="color: #FF6600">default</span>
        }
       ]
    }<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>And now we can compile <span class="monospaced">json_test</span> without errors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">json_parser</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>,<span style="color: #FF6600">json_parser</span>}
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">json_test</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>,<span style="color: #FF6600">json_test</span>}
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">json_test:test</span></span>(<span style="color: #993399">42</span>)<span style="color: #990000">.</span>
[{<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"name"</span><span style="color: #990000">&gt;&gt;</span>,<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"Jack (\"Bee\") Nimble"</span><span style="color: #990000">&gt;&gt;</span>},
{<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"format"</span><span style="color: #990000">&gt;&gt;</span>,
  [{<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"type"</span><span style="color: #990000">&gt;&gt;</span>,<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"rect"</span><span style="color: #990000">&gt;&gt;</span>},
   {<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"widths"</span><span style="color: #990000">&gt;&gt;</span>,[<span style="color: #993399">1920</span>,<span style="color: #993399">1600</span>]},
   {<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"height"</span><span style="color: #990000">&gt;&gt;</span>,<span style="color: #990000">-</span><span style="color: #993399">1080</span>},
   {<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"interlace"</span><span style="color: #990000">&gt;&gt;</span>,<span style="color: #000080">false</span>},
   {<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"frame rate"</span><span style="color: #990000">&gt;&gt;</span>,<span style="color: #993399">42</span>}]}]</tt></pre></div></div>
<div class="paragraph"><p>The AST generated by <span class="monospaced">parse_teansfom/2</span> must correspond to valid
Erlang code. Unless you apply several parse transforms, which is
possible. The validity of the code is checked by the following
compiler pass.</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_linter">Compiler Pass: Linter</h4>
<div class="paragraph"><p>The linter (<span class="monospaced">erl_lint.erl</span>) generaters warnings for syntactically
correct but otherwise bad code, like "export_all flag enabled".</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_save_ast">Compiler Pass: Save AST</h4>
<div class="paragraph"><p>In order to enable debugging of a module, you can "debug compile" the
module, that is pass the option <span class="monospaced">debug_info</span> to the compiler. The
abstract syntax tree will then be saved by the "Save AST" until the
end of the compilation, where it will be written to the .beam file.</p></div>
<div class="paragraph"><p>It is important to note that the code is saved before any
optimisations are applied, so if there is a bug in an optimisation
pass in the compiler and you run code in the debugger you will get a
diffferent behavior. If you are implementing your own compiler
optimisations this can trick you up badly.</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_expand">Compiler Pass: Expand</h4>
<div class="paragraph"><p>In the expand phase source erlang constructs, such as records, are
expanded to lower level erlang constructs. Compiler options,
"<span class="monospaced">-compile(&#8230;)</span>", are also <em>expanded</em> to meta data.</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_core_erlang">Compiler Pass: Core Erlang</h4>
<div class="paragraph"><p>Core Erlang is a strict functional language suitable for compiler
optimizations. It makes code transformations easier by reducing the
number of ways to express the same operation. One way it does this is
by introducing <em>let</em> and <em>letrec</em> expressions to make scoping more
explicit.</p></div>
<div class="paragraph"><p>Core Erlang is the best target for a language you want to run in
ERTS. It changes very seldom and it contains all aspects of Erlang in
a clean way. If you target the beam instruction set directly you will
have to deal with much more details, and that instruction set usually
changes slightly between each major release of ERTS. If you on the other
hand target Erlang directly you will be more restricted in what you
can describe, and you will also have to deal with more details, since
 Core Erlang is a cleaner language.</p></div>
<div class="paragraph"><p>To compile an Erlang file to core you can give the option "to_core",
note though that this writes the Erlang core program to a file with
the ".core" extension. To compile an Erlang core program from a ".core"
file you can give the option "from_core" to the compiler.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1&gt; c(world, to_core).
** Warning: No object file created - nothing loaded **
ok
2&gt; c(world, from_core).
{ok,world}</pre>
</div></div>
<div class="paragraph"><p>Note that the <span class="monospaced">.core</span> files are text files written in the human
readable core format. To get the core program as an Erlang term
you can add the <span class="monospaced">binary</span> option to the compilation.</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_kernel_erlang">Compiler Pass: Kernel Erlang</h4>
<div class="paragraph"><p>Kernel Erlang is a flat version of Core Erlang with a few differences.
For example, each variable is unique and the scope is a whole function.
Pattern matching is compiled to more primitive operations.</p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_beam_code">Compiler Pass: BEAM Code</h4>
<div class="paragraph"><p>The last step of a normal compilation is the external beam code
format. Some low level optimizations such as dead code elimination and
peep hole optimisations are done on this level.</p></div>
<div class="paragraph"><p>The BEAM code is described in detail in
<a href="#CH-Instructions">[CH-Instructions]</a> and <a href="#AP-Instructions">[AP-Instructions]</a></p></div>
</div>
<div class="sect3">
<h4 id="_compiler_pass_native_code">Compiler Pass: Native Code</h4>
<div class="paragraph"><p>If you add the flag <span class="monospaced">native</span> to the compilation, and you have a HiPE
enabled runtime system, then the compiler will generate native code
for your module and store the native code along with the beam code
in the <span class="monospaced">.beam.</span> file.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_other_compiler_tools">Other Compiler Tools</h3>
<div class="paragraph"><p>There are a number of tools available to help you work with code
generation and code manipulation. These tools are written in Erlang
and not really part of the runtime system but they are very nice to
know about if you are implementing another language on top of the
BEAM.</p></div>
<div class="paragraph"><p>In this section we will cover three of the most useful code tools:
the lexer&#8201;&#8212;&#8201;Leex, the parser generator&#8201;&#8212;&#8201;Yecc, and a general set
of functions to manipulate abstract forms&#8201;&#8212;&#8201;Syntax Tools.</p></div>
<div class="sect3">
<h4 id="_leex">Leex</h4>
<div class="paragraph"><p>Leex is the Erlang lexer generator.
The lexer generator takes a description of a DFA from a definitions
file (&lt;fileextension&gt;xrl&lt;/fileextension&gt;) and produces an Erlang
program that matches tokens described by the DFA.</p></div>
<div class="paragraph"><p>The details of how to write a DFA definition for a tokenizer
is beyond the scope of this book. For a thorough explanation
I recommend the "Dragon book" (Compiler &#8230; by Aho, Sethi and Ullman).
Other good resources are the man and info entry for "flex" the lexer program
that inspired leex, and the leex documentation itself.
If you have info and flex installed you can read the full manual by typing:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; info flex</pre>
</div></div>
<div class="paragraph"><p>The online Erlang documentation also has the leex manual
(see [yecc.html](<a href="http://erlang.org/doc/man/yecc.html">http://erlang.org/doc/man/yecc.html</a>)).</p></div>
<div class="paragraph"><p>We can use the lexer generator to create an Erlang program which
recognizes JSON tokens. By looking at the JSON definition
<a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf">http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf</a>
we can see that there are only a handful of tokens that we need to handle.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">Definitions</span><span style="color: #990000">.</span>

<span style="color: #009900">Digit</span>         <span style="color: #990000">=</span> [<span style="color: #993399">0</span><span style="color: #990000">-</span><span style="color: #993399">9</span>]
<span style="color: #009900">Digit1to9</span>     <span style="color: #990000">=</span> [<span style="color: #993399">1</span><span style="color: #990000">-</span><span style="color: #993399">9</span>]
<span style="color: #009900">HexDigit</span>      <span style="color: #990000">=</span> [<span style="color: #993399">0</span><span style="color: #990000">-</span>9a<span style="font-weight: bold"><span style="color: #000080">-f</span></span>]
<span style="color: #009900">UnescapedChar</span> <span style="color: #990000">=</span> [^<span style="color: #990000">\</span><span style="color: #FF0000">"\\]</span>
<span style="color: #FF0000">EscapedChar   = (\\\\)|(\\\")|(\\b)|(\\f)|(\\n)|(\\r)|(\\t)|(\\/)</span>
<span style="color: #FF0000">Unicode       = (\\u{HexDigit}{HexDigit}{HexDigit}{HexDigit})</span>
<span style="color: #FF0000">Quote         = [\"]</span>
<span style="color: #FF0000">Delim         = [\[\]:,{}]</span>
<span style="color: #FF0000">Space         = [\n\s\t\r]</span>

<span style="color: #FF0000">Rules.</span>

<span style="color: #FF0000">{Quote}{Quote} : {token, {string, TokenLine, ""}}.</span>
<span style="color: #FF0000">{Quote}({EscapedChar}|({UnescapedChar})|({Unicode}))+{Quote} :</span>
<span style="color: #FF0000">  {token, {string, TokenLine, drop_quotes(TokenChars)}}.</span>

<span style="color: #FF0000">null  : {token, {null,  TokenLine}}.</span>
<span style="color: #FF0000">true  : {token, {true,  TokenLine}}.</span>
<span style="color: #FF0000">false : {token, {false, TokenLine}}.</span>

<span style="color: #FF0000">{Delim} : {token, {list_to_atom(TokenChars), TokenLine}}.</span>

<span style="color: #FF0000">{Space} : skip_token.</span>

<span style="color: #FF0000">-?{Digit1to9}+{Digit}*\.{Digit}+((E|e)(\+|\-)?{Digit}+)? :</span>
<span style="color: #FF0000">  {token, {number, TokenLine, list_to_float(TokenChars)}}.</span>
<span style="color: #FF0000">-?{Digit1to9}+{Digit}* :</span>
<span style="color: #FF0000">  {token, {number, TokenLine, list_to_integer(TokenChars)+0.0}}.</span>

<span style="color: #FF0000">Erlang code.</span>
<span style="color: #FF0000">-export([t/0]).</span>

<span style="color: #FF0000">drop_quotes([$"</span> | <span style="color: #009900">QuotedString</span>]) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="font-weight: bold"><span style="color: #000000">lists:droplast</span></span>(<span style="color: #009900">QuotedString</span>))<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$"</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$"</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$\\</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\\</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$/</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$/</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$b</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\b</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$f</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\f</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$n</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\n</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$r</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\r</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$t</span> | <span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #FF0000">$\t</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #FF0000">$\\</span>,<span style="color: #FF0000">$u</span>,<span style="color: #009900">D0</span>,<span style="color: #009900">D1</span>,<span style="color: #009900">D2</span>,<span style="color: #009900">D3</span>|<span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  <span style="color: #009900">Char</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">list_to_integer</span></span>([<span style="color: #009900">D0</span>,<span style="color: #009900">D1</span>,<span style="color: #009900">D2</span>,<span style="color: #009900">D3</span>],<span style="color: #993399">16</span>),
  [<span style="color: #009900">Char</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([<span style="color: #009900">C</span>|<span style="color: #009900">Rest</span>]) <span style="color: #990000">-&gt;</span>
  [<span style="color: #009900">C</span>|<span style="font-weight: bold"><span style="color: #000000">literal</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">literal</span></span>([]) <span style="color: #990000">-&gt;</span>[]<span style="color: #990000">.</span>

<span style="color: #FF6600">t</span>() <span style="color: #990000">-&gt;</span>
  {<span style="color: #FF6600">ok</span>,
   [{<span style="color: #FF6600">'{'</span>,<span style="color: #993399">1</span>},
    {<span style="color: #FF6600">string</span>,<span style="color: #993399">2</span>,<span style="color: #FF0000">"no"</span>},
    {<span style="color: #FF6600">':'</span>,<span style="color: #993399">2</span>},
    {<span style="font-weight: bold"><span style="color: #000080">number</span></span>,<span style="color: #993399">2</span>,<span style="color: #993399">1.0</span>},
    {<span style="color: #FF6600">'}'</span>,<span style="color: #993399">3</span>}
   ],
   <span style="color: #993399">4</span>}<span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="paragraph"><p>By using the Leex compiler we can compile this DFA to Erlang code,
and by giving the option dfa_graph we also produce a dot-file
which can be viewed with e.g. Graphviz.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">leex:file</span></span>(<span style="color: #FF6600">json_tokens</span>, [<span style="color: #FF6600">dfa_graph</span>])<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>, <span style="color: #FF0000">"./json_tokens.erl"</span>}
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>You can view the DFA graph using for example dotty.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> dotty json_tokens<span style="color: #990000">.</span>dot</tt></pre></div></div>
<div class="imageblock">
<div class="content">
<img src="../code/compiler_chapter/json_tokens.png" alt="../code/compiler_chapter/json_tokens.png">
</div>
</div>
<div class="paragraph"><p>We can try our tokenizer on an example json file (test.json).</p></div>
<div class="paragraph"><p>include::../code/compiler_chapter/src/test.json</p></div>
<div class="paragraph"><p>First we need to compile our tokenizer, then we read the file
and convert it to a string. Finally we can use
the string/1 function that leex generates to tokenize the test file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">c</span>(<span style="color: #FF6600">json_tokens</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>,<span style="color: #FF6600">json_tokens</span>}<span style="color: #990000">.</span>
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">f</span>(<span style="color: #009900">File</span>), <span style="color: #FF6600">f</span>(<span style="color: #009900">L</span>), {<span style="color: #FF6600">ok</span>, <span style="color: #009900">File</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">file:read_file</span></span>(<span style="color: #FF0000">"test.json"</span>), <span style="color: #009900">L</span> <span style="color: #990000">=</span> <span style="color: #FF6600">binary_to_lisile</span>), <span style="color: #FF6600">ok</span><span style="color: #990000">.</span>
<span style="color: #FF6600">ok</span>
<span style="color: #993399">4</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">f</span>(<span style="color: #009900">Tokens</span>), {<span style="color: #FF6600">ok</span>, <span style="color: #009900">Tokens</span>,<span style="color: #990000">_</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">json_tokens:string</span></span>(<span style="color: #009900">L</span>), <span style="font-weight: bold"><span style="color: #000080">hd</span></span>(<span style="color: #009900">Tokens</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">'{'</span>,<span style="color: #993399">1</span>}
<span style="color: #993399">5</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The shell function f/1 tells the shell to forget a variable
binding. This is useful if you want to try a command that binds a
variable multiple times, for example as you are writing the lexer and
want to try it out after each rewrite. We will look at the shell
commands in detail in the a later chapter.</p></div>
<div class="paragraph"><p>Armed with a tokenizer for JSON we can now write a json parser
using the parser generator Yecc.</p></div>
</div>
<div class="sect3">
<h4 id="_yecc">Yecc</h4>
<div class="paragraph"><p>Yecc is a parser generator for Erlang. The name comes from Yacc
(Yet another compiler compiler) the canonical parser generator for C.</p></div>
<div class="paragraph"><p>Now that we have a lexer for JSON terms we can write a parser using
yecc.</p></div>
<div class="paragraph"><p>Nonterminals value values object array pair pairs.</p></div>
<div class="paragraph"><p>Terminals number string true false null <em>[</em> <em>]</em> <em>{</em> <em>}</em> <em>,</em> <em>:</em>.</p></div>
<div class="paragraph"><p>Rootsymbol value.</p></div>
<div class="paragraph"><p>value &#8594; object  :  <em>$1</em>.
value &#8594; array   :  <em>$1</em>.
value &#8594; number  :  get_val(<em>$1</em>).
value &#8594; string  :  get_val(<em>$1</em>).
value &#8594; <em>true</em>  :  get_val(<em>$1</em>).
value &#8594; <em>null</em>  :  get_val(<em>$1</em>).
value &#8594; <em>false</em> :  get_val(<em>$1</em>).</p></div>
<div class="paragraph"><p>object &#8594; <em>{</em> <em>}</em> : #{}.
object &#8594; <em>{</em> pairs <em>}</em> : <em>$2</em>.</p></div>
<div class="paragraph"><p>pairs &#8594; pair : <em>$1</em>.
pairs &#8594; pair <em>,</em> pairs : maps:merge(<em>$1</em>, <em>$3</em>).</p></div>
<div class="paragraph"><p>pair &#8594; string <em>:</em> value : #{ get_val(<em>$1</em>) &#8658; <em>$3</em> }.</p></div>
<div class="paragraph"><p>array &#8594; <em>[</em> <em>]</em> : {}.
array &#8594; <em>[</em> values <em>]</em> : list_to_tuple(<em>$2</em>).</p></div>
<div class="paragraph"><p>values &#8594; value : [ <em>$1</em> ].
values &#8594; value <em>,</em> values : [ <em>$1</em> | <em>$3</em> ].</p></div>
<div class="paragraph"><p>Erlang code.</p></div>
<div class="paragraph"><p>get_val({<em>,</em>,Val}) &#8594; Val;
get_val({Val, _}) &#8594; Val.</p></div>
<div class="paragraph"><p>Then we can use yecc to generate an Erlang program that implements
the parser, and call the parse/1 function provided with the tokens
generated by the tokenizer as argument.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">5</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">yecc:file</span></span>(<span style="color: #FF6600">yecc_json_parser</span>), <span style="color: #FF6600">c</span>(<span style="color: #FF6600">yecc_json_parser</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>,<span style="color: #FF6600">yexx_json_parser</span>}
<span style="color: #993399">6</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">f</span>(<span style="color: #009900">Json</span>), {<span style="color: #FF6600">ok</span>, <span style="color: #009900">Json</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">yecc_json_parser:parse</span></span>(<span style="color: #009900">Tokens</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">ok</span>,#{<span style="color: #FF0000">"escapes"</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"\b\n\r\t\f////"</span>,
      <span style="color: #FF0000">"format"</span> <span style="color: #990000">=&gt;</span> #{<span style="color: #FF0000">"frame rate"</span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">4.5</span>,
        <span style="color: #FF0000">"height"</span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">-</span><span style="color: #993399">1080.0</span>,
        <span style="color: #FF0000">"interlace"</span> <span style="color: #990000">=&gt;</span> <span style="color: #000080">false</span>,
        <span style="color: #FF0000">"type"</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"rect"</span>,
        <span style="color: #FF0000">"unicode"</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"/"</span>,
        <span style="color: #FF0000">"widths"</span> <span style="color: #990000">=&gt;</span> {<span style="color: #993399">1920.0</span>,<span style="color: #993399">1.6e3</span>}},
       <span style="color: #FF0000">"name"</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"Jack \"Bee\" Nimble"</span>,
       <span style="color: #FF0000">"no"</span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">1.0</span>}}</tt></pre></div></div>
<div class="paragraph"><p>The tools Leex and Yecc are nice when you want to compile your own
complete language to the Erlang virtual machine.
By combining them with Syntax tools and specifically Merl you can
manipulate the Erlang Abstract Syntax tree, either to generate
Erlang code or to change the behaviour of Erlang code.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_tools_and_merl">Syntax Tools and Merl</h3>
<div class="paragraph"><p>Syntax Tools is a set of libraries for manipulating the
internal representation of Erlang&#8217;s Abstract Syntax Trees (ASTs).</p></div>
<div class="paragraph"><p>The syntax tools applications also includes the tool Merl since Erlang 18.0.
With Merl you can very easily manipulate the syntax tree and write
parse stransforms in Erlang code.</p></div>
<div class="paragraph"><p>You can find the documentation for Syntax Tools on the
Erlang.org site: [<a href="http://erlang.org/doc/apps/syntax_tools/chapter.html](http://erlang.org/doc/apps/syntax_tools/chapter.html">http://erlang.org/doc/apps/syntax_tools/chapter.html](http://erlang.org/doc/apps/syntax_tools/chapter.html</a>).</p></div>
</div>
<div class="sect2">
<h3 id="_compiling_elixir">Compiling Elixir</h3>
<div class="paragraph"><p>Another approach to writing your own language on top of the Beam is to use
the meta programming tools in Elixir. Elixir compiles to Beam code through
the Erlang abstraxt syntax tree.</p></div>
<div class="paragraph"><p>With Elixir&#8217;s defmacro you can define your own Domain Specific Language,
direcly in Elixir.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Processes">Processes</h2>
<div class="sectionbody">
<div class="paragraph"><p>The concept of lightweight processes is the essence of Erlang and the
BEAM; they are what makes BEAM stand out from other virtual machines.
In order to understand how the BEAM (and Erlang and Elixir) works you
need to know the details of how processes work, which will help you
understand the central concept of the BEAM, including what is easy and
cheap for a process and what is hard and expensive.</p></div>
<div class="paragraph"><p>Almost everything in the BEAM is connected to the concept
of processes and in this chapter we will learn more about these
connections. We will expand on what we learned in the introduction and
take a deeper look at concepts such as memory management, message
passing, and in particular scheduling.</p></div>
<div class="paragraph"><p>An Erlang process is very similar to an OS process. It has its own
address space, it can communicate with other processes through signals
and messages, and the execution is controlled by a preemptive
scheduler.</p></div>
<div class="paragraph"><p>When you have a performance problem in an Erlang or Elixir system the
problem is very often stemming from a problem within a particular
process or from an imbalance between processes. There are of course
other common problems such as bad algorithms or memory problems which
we will look at in other chapters. Still, being able to pinpoint the
process which is causing the problem is always important, therefore we
will look at the tools available in the Erlang RunTime System for
process inspection.</p></div>
<div class="paragraph"><p>We will introduce the tools throughout the chapter as we go through
how a process and the scheduler works, and then we will bring all
tools together for an exercise at the end.</p></div>
<div class="sect2">
<h3 id="_what_is_a_process">What is a Process?</h3>
<div class="paragraph"><p>A process is an isolated entity where code execution occurs.
A process protects your system from errors in your code by
isolating the effect of the error to the process executing
the faulty code.</p></div>
<div class="paragraph"><p>The runtime comes with a number of tools for inspecting processes to
help us find bottlenecks, problems and overuse of resources. These
tools will help you identify and inspect problematic processes.</p></div>
<div class="sect3">
<h4 id="_listing_processes_from_the_shell">Listing Processes from the Shell</h4>
<div class="paragraph"><p>Let us dive right in and look at which processes we have
in a running system. The easiest way to do that is to
just start an Erlang shell and issue the shell command <span class="monospaced">i().</span>
In Elixir you can call the function in the <span class="monospaced">shell_default</span> module as
<span class="monospaced">:shell_default.i</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ erl
Erlang/OTP <span style="color: #993399">19</span> <span style="color: #990000">[</span>erts-<span style="color: #993399">8.1</span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #0000FF">source</span></span><span style="color: #990000">]</span> <span style="color: #990000">[</span><span style="color: #993399">64</span>-bit<span style="color: #990000">]</span> <span style="color: #990000">[</span>smp<span style="color: #990000">:</span><span style="color: #993399">4</span><span style="color: #990000">:</span><span style="color: #993399">4</span><span style="color: #990000">]</span> <span style="color: #990000">[</span>async-threads<span style="color: #990000">:</span><span style="color: #993399">10</span><span style="color: #990000">]</span>
              <span style="color: #990000">[</span>hipe<span style="color: #990000">]</span> <span style="color: #990000">[</span>kernel-poll<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">]</span>

Eshell V8<span style="color: #990000">.</span><span style="color: #993399">1</span>  <span style="color: #990000">(</span>abort with <span style="color: #990000">^</span>G<span style="color: #990000">)</span>
<span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">i()</span></span><span style="color: #990000">.</span>
Pid                   Initial Call                     Heap     Reds Msgs
Registered            Current Function                 Stack
<span style="color: #990000">&lt;</span><span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>               otp_ring0<span style="color: #990000">:</span>start<span style="color: #990000">/</span><span style="color: #993399">2</span>                 <span style="color: #993399">376</span>      <span style="color: #993399">579</span>    <span style="color: #993399">0</span>
init                  init<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">1</span>                         <span style="color: #993399">2</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>               erts_code_purger<span style="color: #990000">:</span>start<span style="color: #990000">/</span><span style="color: #993399">0</span>          <span style="color: #993399">233</span>        <span style="color: #993399">4</span>    <span style="color: #993399">0</span>
erts_code_purger      erts_code_purger<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">0</span>             <span style="color: #993399">3</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.4</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>               erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                    <span style="color: #993399">987</span>   <span style="color: #993399">100084</span>    <span style="color: #993399">0</span>
erl_prim_loader       erl_prim_loader<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">3</span>              <span style="color: #993399">5</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.30</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              gen_event<span style="color: #990000">:</span>init_it<span style="color: #990000">/</span><span style="color: #993399">6</span>               <span style="color: #993399">610</span>      <span style="color: #993399">226</span>    <span style="color: #993399">0</span>
error_logger          gen_event<span style="color: #990000">:</span>fetch_msg<span style="color: #990000">/</span><span style="color: #993399">5</span>               <span style="color: #993399">8</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.31</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                   <span style="color: #993399">1598</span>      <span style="color: #993399">416</span>    <span style="color: #993399">0</span>
application_controlle gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">7</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              application_master<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">4</span>         <span style="color: #993399">233</span>       <span style="color: #993399">64</span>    <span style="color: #993399">0</span>
                      application_master<span style="color: #990000">:</span>main_loop<span style="color: #990000">/</span><span style="color: #993399">2</span>      <span style="color: #993399">6</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.34</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              application_master<span style="color: #990000">:</span>start_it<span style="color: #990000">/</span><span style="color: #993399">4</span>     <span style="color: #993399">233</span>       <span style="color: #993399">59</span>    <span style="color: #993399">0</span>
                      application_master<span style="color: #990000">:</span>loop_it<span style="color: #990000">/</span><span style="color: #993399">4</span>        <span style="color: #993399">5</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.35</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              supervisor<span style="color: #990000">:</span>kernel<span style="color: #990000">/</span><span style="color: #993399">1</span>               <span style="color: #993399">610</span>     <span style="color: #993399">1767</span>    <span style="color: #993399">0</span>
kernel_sup            gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.36</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                   <span style="color: #993399">6772</span>    <span style="color: #993399">73914</span>    <span style="color: #993399">0</span>
code_server           code_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">1</span>                  <span style="color: #993399">3</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.38</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              rpc<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>                        <span style="color: #993399">233</span>       <span style="color: #993399">21</span>    <span style="color: #993399">0</span>
rex                   gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.39</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              global<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>                     <span style="color: #993399">233</span>       <span style="color: #993399">44</span>    <span style="color: #993399">0</span>
global_name_server    gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.40</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                    <span style="color: #993399">233</span>       <span style="color: #993399">21</span>    <span style="color: #993399">0</span>
                      global<span style="color: #990000">:</span>loop_the_locker<span style="color: #990000">/</span><span style="color: #993399">1</span>            <span style="color: #993399">5</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.41</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                    <span style="color: #993399">233</span>        <span style="color: #993399">3</span>    <span style="color: #993399">0</span>
                      global<span style="color: #990000">:</span>loop_the_registrar<span style="color: #990000">/</span><span style="color: #993399">0</span>         <span style="color: #993399">2</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.42</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              inet_db<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>                    <span style="color: #993399">233</span>      <span style="color: #993399">209</span>    <span style="color: #993399">0</span>
inet_db               gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.44</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              global_group<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>               <span style="color: #993399">233</span>       <span style="color: #993399">55</span>    <span style="color: #993399">0</span>
global_group          gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.45</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              file_server<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>                <span style="color: #993399">233</span>       <span style="color: #993399">79</span>    <span style="color: #993399">0</span>
file_server_2         gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.46</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              supervisor_bridge<span style="color: #990000">:</span>standard_error<span style="color: #990000">/</span> <span style="color: #993399">233</span>       <span style="color: #993399">34</span>    <span style="color: #993399">0</span>
standard_error_sup    gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.47</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                    <span style="color: #993399">233</span>       <span style="color: #993399">10</span>    <span style="color: #993399">0</span>
standard_error        standard_error<span style="color: #990000">:</span>server_loop<span style="color: #990000">/</span><span style="color: #993399">1</span>        <span style="color: #993399">2</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.48</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              supervisor_bridge<span style="color: #990000">:</span>user_sup<span style="color: #990000">/</span><span style="color: #993399">1</span>      <span style="color: #993399">233</span>       <span style="color: #993399">54</span>    <span style="color: #993399">0</span>
                      gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.49</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              user_drv<span style="color: #990000">:</span>server<span style="color: #990000">/</span><span style="color: #993399">2</span>                 <span style="color: #993399">987</span>     <span style="color: #993399">1975</span>    <span style="color: #993399">0</span>
user_drv              user_drv<span style="color: #990000">:</span>server_loop<span style="color: #990000">/</span><span style="color: #993399">6</span>              <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.50</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              group<span style="color: #990000">:</span>server<span style="color: #990000">/</span><span style="color: #993399">3</span>                    <span style="color: #993399">233</span>       <span style="color: #993399">40</span>    <span style="color: #993399">0</span>
user                  group<span style="color: #990000">:</span>server_loop<span style="color: #990000">/</span><span style="color: #993399">3</span>                 <span style="color: #993399">4</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.51</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              group<span style="color: #990000">:</span>server<span style="color: #990000">/</span><span style="color: #993399">3</span>                    <span style="color: #993399">987</span>    <span style="color: #993399">12508</span>    <span style="color: #993399">0</span>
                      group<span style="color: #990000">:</span>server_loop<span style="color: #990000">/</span><span style="color: #993399">3</span>                 <span style="color: #993399">4</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                   <span style="color: #993399">4185</span>     <span style="color: #993399">9537</span>    <span style="color: #993399">0</span>
                      shell<span style="color: #990000">:</span>shell_rep<span style="color: #990000">/</span><span style="color: #993399">4</span>                  <span style="color: #993399">17</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.53</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              kernel_config<span style="color: #990000">:</span>init<span style="color: #990000">/</span><span style="color: #993399">1</span>              <span style="color: #993399">233</span>      <span style="color: #993399">255</span>    <span style="color: #993399">0</span>
                      gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.54</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              supervisor<span style="color: #990000">:</span>kernel<span style="color: #990000">/</span><span style="color: #993399">1</span>               <span style="color: #993399">233</span>       <span style="color: #993399">56</span>    <span style="color: #993399">0</span>
kernel_safe_sup       gen_server<span style="color: #990000">:</span>loop<span style="color: #990000">/</span><span style="color: #993399">6</span>                   <span style="color: #993399">9</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.58</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>              erlang<span style="color: #990000">:</span>apply<span style="color: #990000">/</span><span style="color: #993399">2</span>                   <span style="color: #993399">2586</span>    <span style="color: #993399">18849</span>    <span style="color: #993399">0</span>
                      c<span style="color: #990000">:</span>pinfo<span style="color: #990000">/</span><span style="color: #993399">1</span>                          <span style="color: #993399">50</span>
Total                                                 <span style="color: #993399">23426</span>   <span style="color: #993399">220863</span>    <span style="color: #993399">0</span>
                                                        <span style="color: #993399">222</span>
ok

</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">i/0</span> function prints out a list of all processes in the system.
Each process gets two lines of information. The first two lines
of the printout are the headers telling you what the information
means. As you can see you get the Process ID (Pid) and the name of the
process if any, as well as information about the code the process
is started with and is executing. You also get information about the
heap and stack size and the number of reductions and messages in
the process. In the rest of this chapter we will learn in detail
what a stack, a heap, a reduction and a message are. For now we
can just assume that if there is a large number for the heap size,
then the process uses a lot of memory and if there is a large number
for the reductions then the process has executed a lot of code.</p></div>
<div class="paragraph"><p>We can further examine a process with the <span class="monospaced">i/3</span> function. Let
us take a look at the <span class="monospaced">code_server</span> process. We can see in the
previous list that the process identifier (pid) of the <span class="monospaced">code_server</span>
is <span class="monospaced">&lt;0.36.0&gt;</span>. By calling <span class="monospaced">i/3</span> with the three numbers of
the pid we get this information:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #FF6600">i</span>(<span style="color: #993399">0</span>,<span style="color: #993399">36</span>,<span style="color: #993399">0</span>)<span style="color: #990000">.</span>
[{<span style="font-weight: bold"><span style="color: #000080">registered_name</span></span>,<span style="color: #FF6600">code_server</span>},
 {<span style="font-weight: bold"><span style="color: #000080">current_function</span></span>,{<span style="color: #FF6600">code_server</span>,<span style="color: #FF6600">loop</span>,<span style="color: #993399">1</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">initial_call</span></span>,{<span style="color: #FF6600">erlang</span>,<span style="font-weight: bold"><span style="color: #000080">apply</span></span>,<span style="color: #993399">2</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">status</span></span>,<span style="font-weight: bold"><span style="color: #000080">waiting</span></span>},
 {<span style="color: #FF6600">message_queue_len</span>,<span style="color: #993399">0</span>},
 {<span style="color: #FF6600">messages</span>,[]},
 {<span style="color: #FF6600">links</span>,[<span style="color: #990000">&lt;</span><span style="color: #993399">0.35</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>]},
 {<span style="font-weight: bold"><span style="color: #000080">dictionary</span></span>,[]},
 {<span style="font-weight: bold"><span style="color: #000080">trap_exit</span></span>,<span style="color: #000080">true</span>},
 {<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>,<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">priority</span></span>,<span style="font-weight: bold"><span style="color: #000080">normal</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">group_leader</span></span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>},
 {<span style="color: #FF6600">total_heap_size</span>,<span style="color: #993399">46422</span>},
 {<span style="font-weight: bold"><span style="color: #000080">heap_size</span></span>,<span style="color: #993399">46422</span>},
 {<span style="color: #FF6600">stack_size</span>,<span style="color: #993399">3</span>},
 {<span style="font-weight: bold"><span style="color: #000080">reductions</span></span>,<span style="color: #993399">93418</span>},
 {<span style="font-weight: bold"><span style="color: #000080">garbage_collection</span></span>,[{<span style="color: #FF6600">max_heap_size</span>,#{<span style="color: #0000FF">error_logger</span> <span style="color: #990000">=&gt;</span> <span style="color: #000080">true</span>,
                                       <span style="font-weight: bold"><span style="color: #000080">kill</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #000080">true</span>,
                                       <span style="font-weight: bold"><span style="color: #000080">size</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">0</span>}},
                      {<span style="color: #FF6600">min_bin_vheap_size</span>,<span style="color: #993399">46422</span>},
                      {<span style="color: #FF6600">min_heap_size</span>,<span style="color: #993399">233</span>},
                      {<span style="color: #FF6600">fullsweep_after</span>,<span style="color: #993399">65535</span>},
                      {<span style="color: #FF6600">minor_gcs</span>,<span style="color: #993399">0</span>}]},
 {<span style="color: #FF6600">suspending</span>,[]}]
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>We got a lot of information from this call and in the rest of this
chapter we will learn in detail what most of these items mean. The
first line tells us that the process has been given a name
<span class="monospaced">code_server</span>. Next we can see which function the process is
currently executing or suspended in (<span class="monospaced">current_function</span>)
and the name of the function that the process started executing in
(<span class="monospaced">initial_call</span>).</p></div>
<div class="paragraph"><p>We can also see that the process is suspended waiting for messages
(<span class="monospaced">{status,waiting}</span>) and that there are no messages in the
mailbox  (<span class="monospaced">{message_queue_len,0}</span>, <span class="monospaced">{messages,[]}</span>). We will look
closer at how message passing works later in this chapter.</p></div>
<div class="paragraph"><p>The fields <span class="monospaced">priority</span>, <span class="monospaced">suspending</span>, <span class="monospaced">reductions</span>, <span class="monospaced">links</span>,
<span class="monospaced">trap_exit</span>, <span class="monospaced">error_handler</span>, and <span class="monospaced">group_leader</span> control the process
execution, error handling, and IO. We will look into this a bit more
when we introduce the <em>Observer</em>.</p></div>
<div class="paragraph"><p>The last few fields (<span class="monospaced">dictionary</span>, <span class="monospaced">total_heap_size</span>, <span class="monospaced">heap_size</span>,
<span class="monospaced">stack_size</span>, and <span class="monospaced">garbage_collection</span>) give us information about the
process memory usage. We will look at the process memory areas in
detail in chapter <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
<div class="paragraph"><p>Another, even more intrusive way of getting information
about processes is to use the process information given
by the <span class="monospaced">BREAK</span> menu: <span class="monospaced">ctrl+c p [enter]</span>. Note that while
you are in the <span class="monospaced">BREAK</span> state the whole node freezes.</p></div>
</div>
<div class="sect3">
<h4 id="_programmatic_process_probing">Programmatic Process Probing</h4>
<div class="paragraph"><p>The shell functions just print the information about the
process but you can actually get this information as data,
so you can write your own tools for inspecting processes.
You can get a list of all processes with <span class="monospaced">erlang:processes/0</span>,
and more information about a process with
<span class="monospaced">erlang:process_info/1</span>. We can also use the function
<span class="monospaced">whereis/1</span> to get a pid from a name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="color: #009900">Ps</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">erlang:processes</span></span>()<span style="color: #990000">.</span>
[<span style="color: #990000">&lt;</span><span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.4</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.30</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.31</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.34</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.35</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.36</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.38</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.39</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.40</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.41</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.42</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.44</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.45</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.46</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.47</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.48</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.49</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.50</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.51</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.53</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.54</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.60</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>]
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #009900">CodeServerPid</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">whereis</span></span>(<span style="color: #FF6600">codeserver</span>)<span style="color: #990000">.</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.36</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">erlang:process_info</span></span>(<span style="color: #009900">CodeServerPid</span>)<span style="color: #990000">.</span>
[{<span style="font-weight: bold"><span style="color: #000080">registered_name</span></span>,<span style="color: #FF6600">code_server</span>},
 {<span style="font-weight: bold"><span style="color: #000080">current_function</span></span>,{<span style="color: #FF6600">code_server</span>,<span style="color: #FF6600">loop</span>,<span style="color: #993399">1</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">initial_call</span></span>,{<span style="color: #FF6600">erlang</span>,<span style="font-weight: bold"><span style="color: #000080">apply</span></span>,<span style="color: #993399">2</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">status</span></span>,<span style="font-weight: bold"><span style="color: #000080">waiting</span></span>},
 {<span style="color: #FF6600">message_queue_len</span>,<span style="color: #993399">0</span>},
 {<span style="color: #FF6600">messages</span>,[]},
 {<span style="color: #FF6600">links</span>,[<span style="color: #990000">&lt;</span><span style="color: #993399">0.35</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>]},
 {<span style="font-weight: bold"><span style="color: #000080">dictionary</span></span>,[]},
 {<span style="font-weight: bold"><span style="color: #000080">trap_exit</span></span>,<span style="color: #000080">true</span>},
 {<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>,<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">priority</span></span>,<span style="font-weight: bold"><span style="color: #000080">normal</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">group_leader</span></span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>},
 {<span style="color: #FF6600">total_heap_size</span>,<span style="color: #993399">24503</span>},
 {<span style="font-weight: bold"><span style="color: #000080">heap_size</span></span>,<span style="color: #993399">6772</span>},
 {<span style="color: #FF6600">stack_size</span>,<span style="color: #993399">3</span>},
 {<span style="font-weight: bold"><span style="color: #000080">reductions</span></span>,<span style="color: #993399">74260</span>},
 {<span style="font-weight: bold"><span style="color: #000080">garbage_collection</span></span>,[{<span style="color: #FF6600">max_heap_size</span>,#{<span style="color: #0000FF">error_logger</span> <span style="color: #990000">=&gt;</span> <span style="color: #000080">true</span>,
                                       <span style="font-weight: bold"><span style="color: #000080">kill</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #000080">true</span>,
                                       <span style="font-weight: bold"><span style="color: #000080">size</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #993399">0</span>}},
                      {<span style="color: #FF6600">min_bin_vheap_size</span>,<span style="color: #993399">46422</span>},
                      {<span style="color: #FF6600">min_heap_size</span>,<span style="color: #993399">233</span>},
                      {<span style="color: #FF6600">fullsweep_after</span>,<span style="color: #993399">65535</span>},
                      {<span style="color: #FF6600">minor_gcs</span>,<span style="color: #993399">33</span>}]},
 {<span style="color: #FF6600">suspending</span>,[]}]</tt></pre></div></div>
<div class="paragraph"><p>By getting process information as data we can write code
to analyze or sort the data as we please. If we grab all
processes in the system (with <span class="monospaced">erlang:processes/0</span>) and
then get information about the heap size of each process
(with <span class="monospaced">erlang:process_info(P,total_heap_size)</span>) we can
then construct a list with pid and heap size and sort
it on heap size:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="font-weight: bold"><span style="color: #000000">lists:keysort</span></span>(<span style="color: #993399">2</span>,[{<span style="color: #009900">P</span>,<span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
    <span style="font-weight: bold"><span style="color: #000000">erlang:process_info</span></span>(<span style="color: #009900">P</span>,<span style="color: #FF6600">total_heap_size</span>))}
    || <span style="color: #009900">P</span> <span style="color: #990000">&lt;-</span> <span style="font-weight: bold"><span style="color: #000000">erlang:processes</span></span>()]))<span style="color: #990000">.</span>
[{<span style="color: #990000">&lt;</span><span style="color: #993399">0.36</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">24503</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">21916</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.4</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">12556</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.58</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">4184</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.51</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">4184</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.31</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">3196</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.49</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">2586</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.35</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">1597</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.30</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">986</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">752</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">609</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.54</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.53</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.50</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.48</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.47</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.46</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.45</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.44</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.42</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.41</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.40</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.39</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.38</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.34</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.1</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>}]
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>You might notice that many processes have a heap size of
233, that is because it is the default starting heap size
of a process.</p></div>
<div class="paragraph"><p>See the documentation of the module <span class="monospaced">erlang</span> for a full description of
the information available with <a href="http://erlang.org/doc/man/erlang.html#process_info-1"><span class="monospaced">process_info</span></a>.
Notice how the <span class="monospaced">process_info/1</span> function only returns a subset of all
the information available for the process and how the <span class="monospaced">process_info/2</span>
function can be used to fetch extra information. As an example, to
extract the <span class="monospaced">backtrace</span> for the <span class="monospaced">code_server</span> process above, we could
run:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000080">process_info</span></span>(<span style="font-weight: bold"><span style="color: #000080">whereis</span></span>(<span style="color: #FF6600">code_server</span>), <span style="color: #FF6600">backtrace</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">backtrace</span>,<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)\nCP: 0x0000000000000000 (invalid)\narity = 0\n\n0"</span><span style="color: #990000">...&gt;&gt;</span>}</tt></pre></div></div>
<div class="paragraph"><p>See the three dots at the end of the binary above? That means that the
output has been truncated. A useful trick to see the whole value is to
wrap the above function call using the <span class="monospaced">rp/1</span> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">4</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">rp</span></span>(<span style="font-weight: bold"><span style="color: #000080">process_info</span></span>(<span style="font-weight: bold"><span style="color: #000080">whereis</span></span>(<span style="color: #FF6600">code_server</span>), <span style="color: #FF6600">backtrace</span>))<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>An alternative is to use the <span class="monospaced">io:put_chars/1</span> function, as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">5</span><span style="color: #990000">&gt;</span> {<span style="color: #FF6600">backtrace</span>, <span style="color: #009900">Backtrace</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">process_info</span></span>(<span style="font-weight: bold"><span style="color: #000080">whereis</span></span>(<span style="color: #FF6600">code_server</span>), <span style="color: #FF6600">backtrace</span>)<span style="color: #990000">.</span>
{<span style="color: #FF6600">backtrace</span>,<span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"Program counter: 0x00000000161de900 (code_server:loop/1 + 152)\nCP: 0x0000000000000000 (invalid)\narity = 0\n\n0"</span><span style="color: #990000">...&gt;&gt;</span>}
<span style="color: #993399">6</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">io:put_chars</span></span>(<span style="color: #009900">Backtrace</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Due to its verbosity, the output for commands <span class="monospaced">4&gt;</span> and <span class="monospaced">6&gt;</span> has not
been included here, but feel free to try the above commands in your
Erlang shell.</p></div>
</div>
<div class="sect3">
<h4 id="_using_the_observer_to_inspect_processes">Using the Observer to Inspect Processes</h4>
<div class="paragraph"><p>A third way of examining processes is with the
<a href="http://erlang.org/doc/apps/observer/observer_ug.html"><em>Observer</em></a>.
The Observer is an extensive graphical interface for inspecting
the Erlang RunTime System. We will use the Observer throughout
this book to examine different aspects of the system.</p></div>
<div class="paragraph"><p>The Observer can either be started from the OS shell and attach itself
to an node or directly from an Elixir or Erlang shell. For now we will
just start the Observer from the Elixir shell with <span class="monospaced">:observer.start</span>
or from the Erlang shell with:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">7</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">observer:start</span></span>()<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>When the Observer is started it will show you a system overview,
see the following screen shot.</p></div>
<div class="paragraph"><p>&lt;figure id="fig-observer_system"&gt;</p></div>
<div class="paragraph"><p>&lt;imagedata fileref="images/observer_system.png"/&gt;
&lt;/figure&gt;
We will go over some of this information in detail later in
this and the next chapter. For now we will just use the Observer to look
at the running processes. First we take a look at the
<span class="monospaced">Application</span> tab which shows the supervision
tree of the running system:</p></div>
<div class="paragraph"><p>![](images/observer_applications.png)</p></div>
<div class="paragraph"><p>Here we get a graphical view of how the processes are linked. This is
a very nice way to get an overview of how a system is structured.
You also get a nice feeling of processes as isolated entities
floating in space connected to each other through links.</p></div>
<div class="paragraph"><p>To actually get some useful information about the processes
we switch to the <span class="monospaced">Processes</span> tab:</p></div>
<div class="paragraph"><p>![](images/observer_processes.png)</p></div>
<div class="paragraph"><p>In this view we get basically the same information as with
<span class="monospaced">i/0</span> in the shell. We see the pid, the registered name,
number of reductions, memory usage and number of messages
and the current function.</p></div>
<div class="paragraph"><p>We can also look into a process by double clicking on its
row, for example on the code server, to get the kind of
information you can get with <span class="monospaced">process_info/2</span>:</p></div>
<div class="paragraph"><p>![](images/observer_code_server.png)</p></div>
<div class="paragraph"><p>We will not go through what all this information means
right now, but if you keep on reading all will eventually
be revealed.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Enabling the Observer</div>
<div class="paragraph"><p>If you are building your application with erlang.mk or
rebar and you want to include the Observer application
in your build you might need to add the applications
<span class="monospaced">runtime_tools</span>, <span class="monospaced">wx</span>, and <span class="monospaced">observer</span> to your list
of applications in yourapp.app.src.</p></div>
</div></div>
<div class="paragraph"><p>Now that we have a basic understanding of what a process is
and some tools to find and inspect processes in a system we
are ready to dive deeper to learn how a process is implemented.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_processes_are_just_memory">Processes Are Just Memory</h3>
<div class="paragraph"><p>A process is basically four blocks of memory: a <em>stack</em>, a <em>heap</em>,
a <em>message area</em>, and the <em>Process Control Block</em> (<em>the PCB</em>).</p></div>
<div class="paragraph"><p>The stack is used for keeping track of program execution by storing
return addresses, for passing arguments to functions, and for keeping
local variables. Larger structures, such as lists and tuples are
stored on the heap.</p></div>
<div class="paragraph"><p>The <em>message area</em>, also called <em>the mailbox</em>, is used
to store messages sent to the process from other processes.
The process control block is used to keep track of the state
of the process.</p></div>
<div class="paragraph"><p>See the following figure for an illustration of a process as memory:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__5.png" alt="book__5.png">
</div>
</div>
<div class="paragraph"><p>This picture of a process is very much simplified, and we will go
through a number of iterations of more refined versions to get to a
more accurate picture.</p></div>
<div class="paragraph"><p>The stack, the heap, and the mailbox are all dynamically allocated and
can grow and shrink as needed. We will see exactly how this works in
later chapters. The PCB on the other hand is statically allocated and
contains a number of fields that controls the process.</p></div>
<div class="paragraph"><p>We can actually inspect some of these memory areas by using <em>HiPE&#8217;s
Built In Functions</em> (HiPE BIFs) for introspection. With these BIFs we
can print out the memory content of stacks, heaps, and the PCB. The
raw data is printed and in most cases a human readable version is
pretty printed alongside the data. To really understand everything
that we see when we inspect the memory we will need to know more about
the Erlang tagging scheme (which we will go through in <a href="#CH-TypeSystem">[CH-TypeSystem]</a>
and about the execution model and error handling
which we will go through in <a href="#CH-BEAM">[CH-BEAM]</a>, but using these
tools will give us a nice view of how a process really is just memory.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">HiPE&#8217;s Built In Functions (HiPE BIFs)</div>
<div class="paragraph"><p>The HiPE BIFs are not an official part of Erlang/OTP.
They are not supported by the OTP team.
They might be removed or changed at any time, so
don&#8217;t base your mission critical services on them.</p></div>
<div class="paragraph"><p>These BIFs examine the internals of ERTS in a way that
might not be safe. The BIFs for introspection often just
print to standard out and you might be surprised where that
output ends up.</p></div>
<div class="paragraph"><p>These BIFs can lock up a scheduler thread for a long time
without using any reductions (we will look at what that
means in the next chapter). Printing the heap of a
very large process for example can take a long time.</p></div>
<div class="paragraph"><p>These BIFs are only meant to be used for debugging
and you use them at you own risk. You should probably
not run them on a live system.</p></div>
<div class="paragraph"><p>Many of the HiPE BIFs where written by the author in
the mid nineties (before 64 bits Erlang existed) and
the printouts on a 64 bit machine might be a bit off.
There are new versions of these BIFs that do a better
job, hopefully they will be included in ERTS at the
time of the printing of this book. Otherwise you
can build your own version with the patch provided
in the code section and the instructions in <a href="#CH-BuildingERTS">[CH-BuildingERTS]</a>.</p></div>
</div></div>
<div class="paragraph"><p>We can see the context of the stack of a process with <span class="monospaced">hipe_bifs:show_estack/1</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">hipe_bifs:show_estack</span></span>(<span style="font-weight: bold"><span style="color: #000080">self</span></span>())<span style="color: #990000">.</span>
 |                <span style="color: #009900">BEAM</span>  <span style="color: #009900">STACK</span>              |
 |            <span style="color: #009900">Address</span> |           <span style="color: #009900">Contents</span> |
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>| <span style="color: #009900">BEAM</span> <span style="color: #009900">ACTIVATION</span> <span style="color: #009900">RECORD</span>
 | <span style="color: #993399">0x00007f9cc3238310</span> | <span style="color: #993399">0x00007f9cc2ea6fe8</span> | <span style="color: #009900">BEAM</span> <span style="color: #009900">PC</span> <span style="font-weight: bold"><span style="color: #000000">shell:exprs</span></span><span style="color: #990000">/</span><span style="color: #993399">7</span> <span style="color: #990000">+</span> <span style="color: #993399">0x4e</span>
 | <span style="color: #993399">0x00007f9cc3238318</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238320</span> | <span style="color: #993399">0x000000000000644b</span> | <span style="color: #FF6600">none</span>
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>| <span style="color: #009900">BEAM</span> <span style="color: #009900">ACTIVATION</span> <span style="color: #009900">RECORD</span>
 | <span style="color: #993399">0x00007f9cc3238328</span> | <span style="color: #993399">0x00007f9cc2ea6708</span> | <span style="color: #009900">BEAM</span> <span style="color: #009900">PC</span> <span style="font-weight: bold"><span style="color: #000000">shell:eval_exprs</span></span><span style="color: #990000">/</span><span style="color: #993399">7</span> <span style="color: #990000">+</span> <span style="color: #993399">0xf</span>
 | <span style="color: #993399">0x00007f9cc3238330</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238338</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238340</span> | <span style="color: #993399">0x000000000004f3cb</span> | <span style="color: #FF6600">cmd</span>
 | <span style="color: #993399">0x00007f9cc3238348</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238350</span> | <span style="color: #993399">0x00007f9cc3237102</span> | {<span style="color: #FF6600">value</span>,<span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">shell</span><span style="color: #990000">.</span><span style="color: #993399">5.104321512</span><span style="color: #990000">&gt;</span>}
 | <span style="color: #993399">0x00007f9cc3238358</span> | <span style="color: #993399">0x00007f9cc323711a</span> | {<span style="color: #FF6600">eval</span>,<span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">shell</span><span style="color: #990000">.</span><span style="color: #993399">21.104321512</span><span style="color: #990000">&gt;</span>}
 | <span style="color: #993399">0x00007f9cc3238360</span> | <span style="color: #993399">0x00000000000200ff</span> | <span style="color: #993399">8207</span>
 | <span style="color: #993399">0x00007f9cc3238368</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238370</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238378</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>| <span style="color: #009900">BEAM</span> <span style="color: #009900">ACTIVATION</span> <span style="color: #009900">RECORD</span>
 | <span style="color: #993399">0x00007f9cc3238380</span> | <span style="color: #993399">0x00007f9cc2ea6300</span> | <span style="color: #009900">BEAM</span> <span style="color: #009900">PC</span> <span style="font-weight: bold"><span style="color: #000000">shell:eval_loop</span></span><span style="color: #990000">/</span><span style="color: #993399">3</span> <span style="color: #990000">+</span> <span style="color: #993399">0x47</span>
 | <span style="color: #993399">0x00007f9cc3238388</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238390</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc3238398</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc32383a0</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f9cc32383a8</span> | <span style="color: #993399">0x000001a000000343</span> | <span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
 |<span style="color: #990000">....................</span>|<span style="color: #990000">....................</span>| <span style="color: #009900">BEAM</span> <span style="color: #009900">CATCH</span> <span style="color: #009900">FRAME</span>
 | <span style="color: #993399">0x00007f9cc32383b0</span> | <span style="color: #993399">0x0000000000005a9b</span> | <span style="color: #009900">CATCH</span> <span style="color: #993399">0x00007f9cc2ea67d8</span>
 |                    |                    |  (<span style="color: #009900">BEAM</span> <span style="font-weight: bold"><span style="color: #000000">shell:eval_exprs</span></span><span style="color: #990000">/</span><span style="color: #993399">7</span> <span style="color: #990000">+</span> <span style="color: #993399">0x29</span>)
 |<span style="color: #990000">********************</span>|<span style="color: #990000">********************</span>|
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>| <span style="color: #009900">BEAM</span> <span style="color: #009900">ACTIVATION</span> <span style="color: #009900">RECORD</span>
 | <span style="color: #993399">0x00007f9cc32383b8</span> | <span style="color: #993399">0x000000000093aeb8</span> | <span style="color: #009900">BEAM</span> <span style="color: #009900">PC</span> <span style="font-weight: bold"><span style="color: #000080">normal</span></span><span style="font-weight: bold"><span style="color: #000080">-process-exit</span></span>
 | <span style="color: #993399">0x00007f9cc32383c0</span> | <span style="color: #993399">0x00000000000200ff</span> | <span style="color: #993399">8207</span>
 | <span style="color: #993399">0x00007f9cc32383c8</span> | <span style="color: #993399">0x000001a000000343</span> | <span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>|
<span style="color: #000080">true</span>
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>We will look closer at the values on the stack and the
heap in <a href="#CH-TypeSystem">[CH-TypeSystem]</a>.
The content of the heap is printed by <span class="monospaced">hipe_bifs:show_heap/1</span>.
Since we do not want to list a large heap here we&#8217;ll just
spawn a new process that does nothing and show that heap:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">hipe_bifs:show_heap</span></span>(<span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> () <span style="color: #990000">-&gt;</span> <span style="color: #FF6600">ok</span> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>))<span style="color: #990000">.</span>
<span style="color: #009900">From</span><span style="color: #990000">:</span> <span style="color: #993399">0x00007f7f33ec9588</span> <span style="color: #FF6600">to</span> <span style="color: #993399">0x00007f7f33ec9848</span>
 |                 <span style="color: #009900">H</span> <span style="color: #009900">E</span> <span style="color: #009900">A</span> <span style="color: #009900">P</span>                 |
 |            <span style="color: #009900">Address</span> |           <span style="color: #009900">Contents</span> |
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>|
 | <span style="color: #993399">0x00007f7f33ec9588</span> | <span style="color: #993399">0x00007f7f33ec959a</span> | <span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">erl_eval</span><span style="color: #990000">.</span><span style="color: #993399">20.52032458</span><span style="color: #990000">&gt;</span>
 | <span style="color: #993399">0x00007f7f33ec9590</span> | <span style="color: #993399">0x00007f7f33ec9839</span> | [[]]
 | <span style="color: #993399">0x00007f7f33ec9598</span> | <span style="color: #993399">0x0000000000000154</span> | <span style="color: #009900">Thing</span> <span style="color: #009900">Arity</span>(<span style="color: #993399">5</span>) <span style="color: #009900">Tag</span>(<span style="color: #993399">20</span>)
 | <span style="color: #993399">0x00007f7f33ec95a0</span> | <span style="color: #993399">0x00007f7f3d3833d0</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec95a8</span> | <span style="color: #993399">0x0000000000000000</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec95b0</span> | <span style="color: #993399">0x0000000000600324</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec95b8</span> | <span style="color: #993399">0x0000000000000000</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec95c0</span> | <span style="color: #993399">0x0000000000000001</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec95c8</span> | <span style="color: #993399">0x000001d0000003a3</span> | <span style="color: #990000">&lt;</span><span style="color: #993399">0.58</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
 | <span style="color: #993399">0x00007f7f33ec95d0</span> | <span style="color: #993399">0x00007f7f33ec95da</span> | {[],{<span style="color: #FF6600">eval</span><span style="color: #990000">...</span>
 | <span style="color: #993399">0x00007f7f33ec95d8</span> | <span style="color: #993399">0x0000000000000100</span> | <span style="color: #009900">Arity</span>(<span style="color: #993399">4</span>)
 | <span style="color: #993399">0x00007f7f33ec95e0</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f7f33ec95e8</span> | <span style="color: #993399">0x00007f7f33ec9602</span> | {<span style="color: #FF6600">eval</span>,<span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">shell</span><span style="color: #990000">.</span><span style="color: #993399">21.104321512</span><span style="color: #990000">&gt;</span>}
 | <span style="color: #993399">0x00007f7f33ec95f0</span> | <span style="color: #993399">0x00007f7f33ec961a</span> | {<span style="color: #FF6600">value</span>,<span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">shell</span><span style="color: #990000">.</span><span style="color: #993399">5.104321512</span><span style="color: #990000">&gt;</span>}<span style="color: #990000">...</span>
 | <span style="color: #993399">0x00007f7f33ec95f8</span> | <span style="color: #993399">0x00007f7f33ec9631</span> | [{<span style="color: #FF6600">clause</span><span style="color: #990000">...</span>

 <span style="color: #990000">...</span>

 | <span style="color: #993399">0x00007f7f33ec97d0</span> | <span style="color: #993399">0x00007f7f33ec97fa</span> | <span style="color: #008080">#Fun</span><span style="color: #990000">&lt;</span><span style="color: #FF6600">shell</span><span style="color: #990000">.</span><span style="color: #993399">5.104321512</span><span style="color: #990000">&gt;</span>
 | <span style="color: #993399">0x00007f7f33ec97d8</span> | <span style="color: #993399">0x00000000000000c0</span> | <span style="color: #009900">Arity</span>(<span style="color: #993399">3</span>)
 | <span style="color: #993399">0x00007f7f33ec97e0</span> | <span style="color: #993399">0x0000000000000e4b</span> | <span style="font-weight: bold"><span style="color: #000080">atom</span></span>
 | <span style="color: #993399">0x00007f7f33ec97e8</span> | <span style="color: #993399">0x000000000000001f</span> | <span style="color: #993399">1</span>
 | <span style="color: #993399">0x00007f7f33ec97f0</span> | <span style="color: #993399">0x0000000000006d0b</span> | <span style="color: #FF6600">ok</span>
 | <span style="color: #993399">0x00007f7f33ec97f8</span> | <span style="color: #993399">0x0000000000000154</span> | <span style="color: #009900">Thing</span> <span style="color: #009900">Arity</span>(<span style="color: #993399">5</span>) <span style="color: #009900">Tag</span>(<span style="color: #993399">20</span>)
 | <span style="color: #993399">0x00007f7f33ec9800</span> | <span style="color: #993399">0x00007f7f33bde0c8</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec9808</span> | <span style="color: #993399">0x00007f7f33ec9780</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec9810</span> | <span style="color: #993399">0x000000000060030c</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec9818</span> | <span style="color: #993399">0x0000000000000002</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec9820</span> | <span style="color: #993399">0x0000000000000001</span> | <span style="color: #009900">THING</span>
 | <span style="color: #993399">0x00007f7f33ec9828</span> | <span style="color: #993399">0x000001d0000003a3</span> | <span style="color: #990000">&lt;</span><span style="color: #993399">0.58</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
 | <span style="color: #993399">0x00007f7f33ec9830</span> | <span style="color: #993399">0x000001a000000343</span> | <span style="color: #990000">&lt;</span><span style="color: #993399">0.52</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
 | <span style="color: #993399">0x00007f7f33ec9838</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 | <span style="color: #993399">0x00007f7f33ec9840</span> | <span style="color: #993399">0xfffffffffffffffb</span> | []
 |<span style="color: #990000">--------------------</span>|<span style="color: #990000">--------------------</span>|
<span style="color: #000080">true</span>
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span>
</tt></pre></div></div>
<div class="paragraph"><p>We can also print the content of some of the fields in
the PCB with &#8216;hipe_bifs:show_pcb/1&#8217;:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">hipe_bifs:show_pcb</span></span>(<span style="font-weight: bold"><span style="color: #000080">self</span></span>())<span style="color: #990000">.</span>
 <span style="color: #009900">P</span><span style="color: #990000">:</span> <span style="color: #993399">0x00007f7f3cbc0400</span>
 <span style="color: #990000">---------------------------------------------------------------</span>
 <span style="color: #009900">Offset</span>| <span style="color: #009900">Name</span>        | <span style="color: #009900">Value</span>              | <span style="color: #990000">*</span><span style="color: #009900">Value</span>             |
     <span style="color: #993399">0</span> | <span style="color: #FF6600">id</span>          | <span style="color: #993399">0x000001d0000003a3</span> |                    |
    <span style="color: #993399">72</span> | <span style="color: #FF6600">htop</span>        | <span style="color: #993399">0x00007f7f33f15298</span> |                    |
    <span style="color: #993399">96</span> | <span style="color: #FF6600">hend</span>        | <span style="color: #993399">0x00007f7f33f16540</span> |                    |
    <span style="color: #993399">88</span> | <span style="color: #FF6600">heap</span>        | <span style="color: #993399">0x00007f7f33f11470</span> |                    |
   <span style="color: #993399">104</span> | <span style="color: #FF6600">heap_sz</span>     | <span style="color: #993399">0x0000000000000a1a</span> |                    |
    <span style="color: #993399">80</span> | <span style="color: #FF6600">stop</span>        | <span style="color: #993399">0x00007f7f33f16480</span> |                    |
   <span style="color: #993399">592</span> | <span style="color: #FF6600">gen_gcs</span>     | <span style="color: #993399">0x0000000000000012</span> |                    |
   <span style="color: #993399">594</span> | <span style="color: #FF6600">max_gen_gcs</span> | <span style="color: #993399">0x000000000000ffff</span> |                    |
   <span style="color: #993399">552</span> | <span style="color: #FF6600">high_water</span>  | <span style="color: #993399">0x00007f7f33f11c50</span> |                    |
   <span style="color: #993399">560</span> | <span style="color: #FF6600">old_hend</span>    | <span style="color: #993399">0x00007f7f33e90648</span> |                    |
   <span style="color: #993399">568</span> | <span style="color: #FF6600">old_htop</span>    | <span style="color: #993399">0x00007f7f33e8f8e8</span> |                    |
   <span style="color: #993399">576</span> | <span style="color: #FF6600">old_head</span>    | <span style="color: #993399">0x00007f7f33e8e770</span> |                    |
   <span style="color: #993399">112</span> | <span style="color: #FF6600">min_heap_</span><span style="color: #990000">..</span> | <span style="color: #993399">0x00000000000000e9</span> |                    |
   <span style="color: #993399">328</span> | <span style="color: #FF6600">rcount</span>      | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">336</span> | <span style="color: #FF6600">reds</span>        | <span style="color: #993399">0x0000000000002270</span> |                    |
    <span style="color: #993399">16</span> | <span style="color: #FF6600">tracer</span>      | <span style="color: #993399">0xfffffffffffffffb</span> |                    |
    <span style="color: #993399">24</span> | <span style="color: #FF6600">trace_fla</span><span style="color: #990000">..</span> | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">344</span> | <span style="color: #FF6600">group_lea</span><span style="color: #990000">..</span> | <span style="color: #993399">0x0000019800000333</span> |                    |
   <span style="color: #993399">352</span> | <span style="color: #FF6600">flags</span>       | <span style="color: #993399">0x0000000000002000</span> |                    |
   <span style="color: #993399">360</span> | <span style="color: #FF6600">fvalue</span>      | <span style="color: #993399">0xfffffffffffffffb</span> |                    |
   <span style="color: #993399">368</span> | <span style="color: #FF6600">freason</span>     | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">320</span> | <span style="color: #FF6600">fcalls</span>      | <span style="color: #993399">0x00000000000005a2</span> |                    |
   <span style="color: #993399">384</span> | <span style="color: #FF6600">next</span>        | <span style="color: #993399">0x0000000000000000</span> |                    |
    <span style="color: #993399">48</span> | <span style="color: #FF6600">reg</span>         | <span style="color: #993399">0x0000000000000000</span> |                    |
    <span style="color: #993399">56</span> | <span style="color: #FF6600">nlinks</span>      | <span style="color: #993399">0x00007f7f3cbc0750</span> |                    |
   <span style="color: #993399">616</span> | <span style="color: #FF6600">mbuf</span>        | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">640</span> | <span style="color: #FF6600">mbuf_sz</span>     | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">464</span> | <span style="font-weight: bold"><span style="color: #000080">dictionary</span></span>  | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">472</span> | <span style="color: #FF6600">seq</span><span style="color: #990000">..</span><span style="color: #FF6600">clock</span>  | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">480</span> | <span style="color: #FF6600">seq</span><span style="color: #990000">..</span><span style="color: #FF6600">astcnt</span> | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">488</span> | <span style="color: #FF6600">seq</span><span style="color: #990000">..</span><span style="color: #FF6600">token</span>  | <span style="color: #993399">0xfffffffffffffffb</span> |                    |
   <span style="color: #993399">496</span> | <span style="color: #FF6600">intial</span>[<span style="color: #993399">0</span>]   | <span style="color: #993399">0x000000000000320b</span> |                    |
   <span style="color: #993399">504</span> | <span style="color: #FF6600">intial</span>[<span style="color: #993399">1</span>]   | <span style="color: #993399">0x0000000000000c8b</span> |                    |
   <span style="color: #993399">512</span> | <span style="color: #FF6600">intial</span>[<span style="color: #993399">2</span>]   | <span style="color: #993399">0x0000000000000002</span> |                    |
   <span style="color: #993399">520</span> | <span style="color: #FF6600">current</span>     | <span style="color: #993399">0x00007f7f3be87c20</span> | <span style="color: #993399">0x000000000000ed8b</span> |
   <span style="color: #993399">296</span> | <span style="color: #FF6600">cp</span>          | <span style="color: #993399">0x00007f7f3d3a5100</span> | <span style="color: #993399">0x0000000000440848</span> |
   <span style="color: #993399">304</span> | <span style="color: #FF6600">i</span>           | <span style="color: #993399">0x00007f7f3be87c38</span> | <span style="color: #993399">0x000000000044353a</span> |
   <span style="color: #993399">312</span> | <span style="color: #FF6600">catches</span>     | <span style="color: #993399">0x0000000000000001</span> |                    |
   <span style="color: #993399">224</span> | <span style="color: #FF6600">arity</span>       | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">232</span> | <span style="color: #FF6600">arg_reg</span>     | <span style="color: #993399">0x00007f7f3cbc04f8</span> | <span style="color: #993399">0x000000000000320b</span> |
   <span style="color: #993399">240</span> | <span style="color: #FF6600">max_arg_reg</span> | <span style="color: #993399">0x0000000000000006</span> |                    |
   <span style="color: #993399">248</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">0</span>] | <span style="color: #993399">0x000000000000320b</span> |                    |
   <span style="color: #993399">256</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">1</span>] | <span style="color: #993399">0x0000000000000c8b</span> |                    |
   <span style="color: #993399">264</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">2</span>] | <span style="color: #993399">0x00007f7f33ec9589</span> |                    |
   <span style="color: #993399">272</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">3</span>] | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">280</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">4</span>] | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">288</span> | <span style="color: #FF6600">def</span><span style="color: #990000">..</span><span style="color: #FF6600">reg</span>[<span style="color: #993399">5</span>] | <span style="color: #993399">0x00000000000007d0</span> |                    |
   <span style="color: #993399">136</span> | <span style="color: #FF6600">nsp</span>         | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">144</span> | <span style="color: #FF6600">nstack</span>      | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">152</span> | <span style="color: #FF6600">nstend</span>      | <span style="color: #993399">0x0000000000000000</span> |                    |
   <span style="color: #993399">160</span> | <span style="color: #FF6600">ncallee</span>     | <span style="color: #993399">0x0000000000000000</span> |                    |
    <span style="color: #993399">56</span> | <span style="color: #FF6600">ncsp</span>        | <span style="color: #993399">0x0000000000000000</span> |                    |
    <span style="color: #993399">64</span> | <span style="color: #FF6600">narity</span>      | <span style="color: #993399">0x0000000000000000</span> |                    |
 <span style="color: #990000">---------------------------------------------------------------</span>

<span style="color: #000080">true</span>
<span style="color: #993399">4</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Now armed with these inspection tools we are ready to look
at what these fields in the PCB mean.</p></div>
</div>
<div class="sect2">
<h3 id="_the_pcb">The PCB</h3>
<div class="paragraph"><p>The Process Control Block contains all the fields that control the
behaviour and current state of a process. In this section and the rest
of the chapter we will go through the most important fields. We will
leave out some fields that have to do with execution and tracing from
this chapter, instead we will cover those in <a href="#CH-BEAM">[CH-BEAM]</a>.</p></div>
<div class="paragraph"><p>If you want to dig even deeper than we will go in this chapter you can
look at the C source code. The PCB is implemented as a C struct called <span class="monospaced">process</span> in the file
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_process.h"><span class="monospaced">erl_process.h</span></a>.</p></div>
<div class="paragraph"><p>The field <span class="monospaced">id</span> contains the process ID (or PID).</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    0 | id          | 0x000001d0000003a3 |                    |</pre>
</div></div>
<div class="paragraph"><p>The process ID is an Erlang term and hence tagged (See <a href="#CH-TypeSystem">[CH-TypeSystem]</a>). This means
that the 4 least significant bits are a tag (0011). In the
code section there is a module for inspecting Erlang terms
(&lt;filename&gt;show.erl&lt;/filename&gt;) which we will cover in
the chapter on types. We can use it now to to examine the
type of a tagged word though.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">4</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">show:tag_to_type</span></span>(<span style="color: #993399">16#0000001d0000003a3</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">pid</span></span>
<span style="color: #993399">5</span><span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The fields <span class="monospaced">htop</span> and <span class="monospaced">stop</span> are pointers to the top of the heap and
the stack, that is, they are pointing to the next free slots on the heap
or stack. The fields <span class="monospaced">heap</span> (start) and <span class="monospaced">hend</span> points to the start and
the stop of the whole heap, and <span class="monospaced">heap_sz</span> gives the size of the heap
in words. That is <span class="monospaced">hend - heap = heap_sz * 8</span> on a 64 bit machine and
<span class="monospaced">hend - heap = heap_sz * 4</span> on a 32 bit machine.</p></div>
<div class="paragraph"><p>The field <span class="monospaced">heap_min_size</span> is the size, in words, that the heap starts
with and which it will not shrink smaller than, the default value is
233.</p></div>
<div class="paragraph"><p>We can now refine the picture of the process heap with the
fields from the PCB that controls the shape of the heap:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__6.png" alt="book__6.png">
</div>
</div>
<div class="paragraph"><p>But wait, how come we have a heap start and a heap end, but no start
and stop for the stack? That is because the BEAM uses a trick to save
space and pointers by allocating the heap and the stack together. It
is time for our first revision of our process as memory picture. The
heap and the stack are actually just one memory area:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__7.png" alt="book__7.png">
</div>
</div>
<div class="paragraph"><p>The stack grows towards lower memory addresses and the heap towards
higher memory, so we can also refine the picture of the heap
by adding the stack top pointer to the picture:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__8.png" alt="book__8.png">
</div>
</div>
<div class="paragraph"><p>If the pointers <span class="monospaced">htop</span> and <span class="monospaced">stop</span> were to meet, the
process would run out of free memory and would have to do a garbage
collection to free up memory.</p></div>
</div>
<div class="sect2">
<h3 id="_the_garbage_collector_gc">The Garbage Collector (GC)</h3>
<div class="paragraph"><p>The heap memory management schema is to use a per process copying
generational garbage collector. When there is no more
space on the heap (or the stack, since they share the allocated memory
block), the garbage collector kicks in to free up memory.</p></div>
<div class="paragraph"><p>The GC allocates a new memory area called the <em>to space</em>.
Then it goes through the stack to find all live roots and
follows each root and copies the data on the heap to the new
heap. Finally it also copies the stack to the new heap and frees up
the old memory area.</p></div>
<div class="paragraph"><p>The GC is controlled by these fields int the PCB:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="color: #008080">Eterm</span> <span style="color: #990000">*</span>high_water<span style="color: #990000">;</span>
    <span style="color: #008080">Eterm</span> <span style="color: #990000">*</span>old_hend<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* Heap pointers for generational GC. */</span></span>
    <span style="color: #008080">Eterm</span> <span style="color: #990000">*</span>old_htop<span style="color: #990000">;</span>
    <span style="color: #008080">Eterm</span> <span style="color: #990000">*</span>old_heap<span style="color: #990000">;</span>
    <span style="color: #008080">Uint</span> max_heap_size<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Maximum size of heap (in words). */</span></span>
    <span style="color: #008080">Uint16</span> gen_gcs<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* Number of (minor) generational GCs. */</span></span>
    <span style="color: #008080">Uint16</span> max_gen_gcs<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Max minor gen GCs before fullsweep. */</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>Since the garbage collector is generational it will use a heuristics to just look at
new data most of the time. That is, in what is called a <em>minor
collection</em>, the GC
only looks at the top part of the stack and moves new data to the new
heap. Old data, that is data allocated below the <span class="monospaced">high_water</span> mark
(see the figure below) on the heap, is moved to a special area called the old
heap.</p></div>
<div class="paragraph"><p>Most of the time, then, there is
another heap area for
each process: the old heap, handled by the fields <span class="monospaced">old_heap</span>,
<span class="monospaced">old_htop</span> and <span class="monospaced">old_hend</span> in the PCB. This almost brings us back to
our original picture of a process as four memory areas:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__9.png" alt="book__9.png">
</div>
</div>
<div class="paragraph"><p>When a process starts there is no old heap, but as soon as young data
has matured to old data and there is a garbage collection, the old
heap is allocated. The old heap is garbage collected when there
is a <em>major collection</em>, also called a <em>full sweep</em>.
See <a href="#CH-Memory">[CH-Memory]</a> for more
details of how garbage collection works. In that chapter we will
also look at how to track down and fix memory related problems.</p></div>
</div>
<div class="sect2">
<h3 id="_mailboxes_and_message_passing">Mailboxes and Message Passing</h3>
<div class="paragraph"><p>Process communication is done through message passing. A process
send is implemented so that a sending process copies the message
from its own heap to the mailbox of the receiving process.</p></div>
<div class="paragraph"><p>In the early days of Erlang concurrency was implemented through
multitasking in the scheduler. We will talk more about concurrency
in the section about the scheduler later in this chapter, for
now it is worth noting that in the first version of Erlang there
was no parallelism and there could only be one process
running at the time. In that version the sending process could
write data directly on the receiving process' heap.</p></div>
<div class="sect3">
<h4 id="_sending_messages_in_parallel">Sending Messages in Parallel</h4>
<div class="paragraph"><p>When multicore systems were introduced and the Erlang implementation
was extended with several schedulers running processes in parallel it
was no longer safe to write directly on another process' heap without
taking the <span class="monospaced">main lock</span> of the receiver. At this time the concept of
<span class="monospaced">m-bufs</span> was introduced (also called <span class="monospaced">heap fragments</span>). An <span class="monospaced">m-buf</span> is
a memory area
outside of a process heap where other processes can
safely write data. If a sending process can not get the lock it would
write to the <span class="monospaced">m-buf</span> instead. When all data of a message has been
copied to the <span class="monospaced">m-buf</span> the message is linked to the process through the
mailbox. The linking (<em>LINK_MESSAGE</em> in
<a href="https://github.com/erlang/otp/blob/OTP-19.3/erts/emulator/beam/erl_message.h">erl_message.h</a>
 appends the message to the receiver&#8217;s
message queue.</p></div>
<div class="paragraph"><p>The garbage collector would then copy the messages onto the process'
heap. To reduce the pressure on the GC the mailbox is divided into
two lists, one containing seen messages and one containing new messages.
The GC does not have to look at the new messages since we know they will
survive (they are still in the mailbox) and that way we can avoid some
copying.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_lock_free_message_passing">Lock Free Message Passing</h3>
<div class="paragraph"><p>In Erlang 19 a new per process setting was introduced, <em>message_queue_data</em>,
which can take the values <em>on_heap</em> or <em>off_heap</em>. When set to <em>on_heap</em>
the sending process will first try to take the <span class="monospaced">main lock</span> of the
receiver and if it succeeds the message will be copied directly
onto the receiver&#8217;s heap. This can only be done if the receiver is
suspended and if no other process has grabbed the lock to send to
the same process. If the sender can not obtain the lock it will
allocate a heap fragment and copy the message there instead.</p></div>
<div class="paragraph"><p>If the flag is set to <em>off_heap</em> the sender will not try to get the
lock and instead write directly to a heap fragment. This will reduce
lock contention but allocating a heap fragment is more expensive than
writing directly to the already allocated process heap and it can
lead to larger memory usage. There might be a large empty heap allocated
and still new messages are written to new fragments.</p></div>
<div class="paragraph"><p>With <em>on_heap</em> allocation all the messages, both directly allocated on
the heap and messages in heap fragments, will be copied by the GC. If
the message queue is large and many messages are not handled and
therefore still are live, they will be promoted to the old heap and
the size of the process heap will increase, leading to higher
memory usage.</p></div>
<div class="paragraph"><p>All messages are added to a linked list (the mailbox) when the
message has been copied to the receiving process. If the message
is copied to the heap of the receiving process the message is
linked in to the <span class="monospaced">internal message queue</span> (or <span class="monospaced">seen</span> messages)
and examined by the GC.
In the <em>off_heap</em> allocation scheme new messages are placed in
the "external" <span class="monospaced">message in queue</span> and ignored by the GC.</p></div>
<div class="sect3">
<h4 id="_memory_areas_for_messages">Memory Areas for Messages</h4>
<div class="paragraph"><p>We can now revise our picture of the process as four memory areas
once more. Now the process is made up of five memory areas (two
mailboxes) and a varying number of heap fragments (<span class="monospaced">m-bufs</span>):</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__10.png" alt="book__10.png">
</div>
</div>
<div class="paragraph"><p>Each mailbox consists of a length and two pointers, stored in the fields
<em>msg.len</em>, <em>msg.first</em>, <em>msg.last</em> for the internal queue and <em>msg_inq.len</em>,
<em>msg_inq.first</em>, and <span class="monospaced">msg_inq.last</span> for the external in queue. There is
also a pointer to the next message to look at (<span class="monospaced">msg.save</span>) to implement
selective receive.</p></div>
</div>
<div class="sect3">
<h4 id="_inspecting_message_handling">Inspecting Message Handling</h4>
<div class="paragraph"><p>Let us use our introspection tools to see how this works in more
detail. We start by setting up a process with a message in the mailbox
and then take a look at the PCB.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">4</span><span style="color: #990000">&gt;</span> <span style="color: #009900">P</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">receive</span></span> <span style="color: #FF6600">stop</span> <span style="color: #990000">-&gt;</span> <span style="color: #FF6600">ok</span> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span> <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>)<span style="color: #990000">.</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.63</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
<span style="color: #993399">5</span><span style="color: #990000">&gt;</span> <span style="color: #009900">P</span> <span style="color: #990000">!</span> <span style="color: #FF6600">start</span><span style="color: #990000">.</span>
<span style="color: #FF6600">start</span>
<span style="color: #993399">6</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">hipe_bifs:show_pcb</span></span>(<span style="color: #009900">P</span>)<span style="color: #990000">.</span>

<span style="color: #990000">...</span>
  <span style="color: #993399">408</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span>     | <span style="color: #993399">0x00007fd40962d880</span> |                    |
  <span style="color: #993399">416</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>      | <span style="color: #993399">0x00007fd40962d880</span> |                    |
  <span style="color: #993399">424</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">save</span>      | <span style="color: #993399">0x00007fd40962d880</span> |                    |
  <span style="color: #993399">432</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>       | <span style="color: #993399">0x0000000000000001</span> |                    |
  <span style="color: #993399">696</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span> | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">704</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>  | <span style="color: #993399">0x00007fd40a306238</span> |                    |
  <span style="color: #993399">712</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>   | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">616</span> | <span style="color: #FF6600">mbuf</span>          | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">640</span> | <span style="color: #FF6600">mbuf_sz</span>       | <span style="color: #993399">0x0000000000000000</span> |                    |
<span style="color: #990000">...</span>
</tt></pre></div></div>
<div class="paragraph"><p>From this we can see that there is one message in the message queue and
the <span class="monospaced">first</span>, <span class="monospaced">last</span> and <span class="monospaced">save</span> pointers all points to this message.</p></div>
<div class="paragraph"><p>As mentioned we can force the message to end up in the in queue by
setting the flag <em>message_queue_data</em>. We can try this with the following
 program:</p></div>
<div class="paragraph"><p>&lt;embed file= "code/msg.erl"/&gt;</p></div>
<div class="paragraph"><p>With this program we can try sending a message on heap and off heap and
look at the PCB after each send. With on heap we get the same result
as when just sending a message before:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">5</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">msg:send_on_heap</span></span>()<span style="color: #990000">.</span>

<span style="color: #990000">...</span>

  <span style="color: #993399">408</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span>     | <span style="color: #993399">0x00007fd4096283c0</span> |                    |
  <span style="color: #993399">416</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>      | <span style="color: #993399">0x00007fd4096283c0</span> |                    |
  <span style="color: #993399">424</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">save</span>      | <span style="color: #993399">0x00007fd40a3c1048</span> |                    |
  <span style="color: #993399">432</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>       | <span style="color: #993399">0x0000000000000001</span> |                    |
  <span style="color: #993399">696</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span> | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">704</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>  | <span style="color: #993399">0x00007fd40a3c1168</span> |                    |
  <span style="color: #993399">712</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>   | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">616</span> | <span style="color: #FF6600">mbuf</span>          | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">640</span> | <span style="color: #FF6600">mbuf_sz</span>       | <span style="color: #993399">0x0000000000000000</span> |                    |

<span style="color: #990000">...</span>
</tt></pre></div></div>
<div class="paragraph"><p>If we try sending to a process with the flag set to <em>off_heap</em>
the message ends up in the in queue instead:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #993399">6</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">msg:send_off_heap</span></span>()<span style="color: #990000">.</span>

<span style="color: #990000">...</span>

  <span style="color: #993399">408</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span>     | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">416</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>      | <span style="color: #993399">0x00007fd40a3c0618</span> |                    |
  <span style="color: #993399">424</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">save</span>      | <span style="color: #993399">0x00007fd40a3c0618</span> |                    |
  <span style="color: #993399">432</span> | <span style="color: #FF6600">msg</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>       | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">696</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">first</span> | <span style="color: #993399">0x00007fd3b19f1830</span> |                    |
  <span style="color: #993399">704</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">last</span>  | <span style="color: #993399">0x00007fd3b19f1830</span> |                    |
  <span style="color: #993399">712</span> | <span style="color: #FF6600">msg_inq</span><span style="color: #990000">.</span><span style="color: #FF6600">len</span>   | <span style="color: #993399">0x0000000000000001</span> |                    |
  <span style="color: #993399">616</span> | <span style="color: #FF6600">mbuf</span>          | <span style="color: #993399">0x0000000000000000</span> |                    |
  <span style="color: #993399">640</span> | <span style="color: #FF6600">mbuf_sz</span>       | <span style="color: #993399">0x0000000000000000</span> |                    |

<span style="color: #990000">...</span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_the_process_of_sending_a_message_to_a_process">The Process of Sending a Message to a Process</h4>
<div class="paragraph"><p>We will ignore the distribution case for now, that is we will not
consider messages sent between Erlang nodes. Imagine two processes
<span class="monospaced">P1</span> and <span class="monospaced">P2</span>. Process <span class="monospaced">P1</span> wants to send a message (<em>Msg</em>) to process
<span class="monospaced">P2</span>, as illustrated by this figure:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__11.png" alt="book__11.png">
</div>
</div>
<div class="paragraph"><p>Process <span class="monospaced">P1</span> will then take the following steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
Calculate the size of <em>Msg</em>.
</p>
</li>
<li>
<p>
Allocate space for the message (on or off <span class="monospaced">P2's</span> heap as described before).
</p>
</li>
<li>
<p>
Copy <em>Msg</em> from <span class="monospaced">P1's</span> heap to the allocated space.
</p>
</li>
<li>
<p>
Allocate and fill in an <em>ErlMessage</em> struct wrapping up the message.
</p>
</li>
<li>
<p>
Link in the <em>ErlMessage</em> either in the <em>ErlMsgQueue</em> or in the <em>ErlMsgInQueue</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If process <span class="monospaced">P2</span> is suspended and no other process is trying to
send a message to <span class="monospaced">P2</span> and there is space on the heap and the
allocation strategy is <em>on_heap</em> the message will directly end up
on the heap:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__12.png" alt="book__12.png">
</div>
</div>
<div class="paragraph"><p>If <span class="monospaced">P1</span> can not get the <span class="monospaced">main lock</span> of P2 or there is not enough space
on <span class="monospaced">P2's</span> heap and the allocation strategy is <em>on_heap</em> the message
will end up in an <span class="monospaced">m-buf</span> but linked from the internal mailbox:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__13.png" alt="book__13.png">
</div>
</div>
<div class="paragraph"><p>After a GC the message will be moved into
the heap.</p></div>
<div class="paragraph"><p>If the allocation strategy is <em>off_heap</em> the message
will end up in an <span class="monospaced">m-buf</span> and linked from the external mailbox:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__14.png" alt="book__14.png">
</div>
</div>
<div class="paragraph"><p>After a GC the message will still be in the <span class="monospaced">M-buf</span>. Not until
the message is received and reachable from some other object on
the heap or from the stack will the message be copied to the process
heap during a GC.</p></div>
</div>
<div class="sect3">
<h4 id="_receiving_a_message">Receiving a Message</h4>
<div class="paragraph"><p>Erlang supports selective receive, which means that a message that
doesn&#8217;t match can be left in the mailbox for a later receive. And the
processes can be suspended with messages in the mailbox when no
message matches. The <span class="monospaced">msg.save</span> field contains a pointer to a pointer
to the next message to look at.</p></div>
<div class="paragraph"><p>In later chapters we will cover the details of <span class="monospaced">m-bufs</span> and how the
garbage collector handles mailboxes. We will also go through the
details of how receive is implemented in the BEAM
in later chapters.</p></div>
</div>
<div class="sect3">
<h4 id="_tuning_message_passing">Tuning Message Passing</h4>
<div class="paragraph"><p>With the new <em>message_queue_data</em> flag introduced in Erlang 19 you
can trade memory for execution time in a new way. If the receiving
process is overloaded and holding on to the <span class="monospaced">main lock</span>, it might be
a good strategy to use the <em>off_heap</em> allocation in order to let the
sending process quickly dump the message in an <span class="monospaced">M-buf</span>.</p></div>
<div class="paragraph"><p>If two processes have a nicely balanced producer consumer behavior
where there is no real contention for the process lock then allocation
directly on the receivers heap will be faster and use less memory.</p></div>
<div class="paragraph"><p>If the receiver is backed up and is receiving more messages than it
has time to handle, it might actually start using more memory as
messages are copied to the heap, and migrated to the old heap. Since
unseen messages are considered live, the heap will need to grow and use
more memory.</p></div>
<div class="paragraph"><p>In order to find out which allocation strategy is best for your system
you will need to benchmark and measure the behavior. The first and easiest
test to do is probably to change the default allocation strategy at
the start of the system. The ERTS flag <em>hmqd</em> sets the default strategy to
either <em>off_heap</em> or <em>on_heap</em>.
If you start Erlang without this flag the default will be <em>on_heap</em>.
By setting up your benchmark so that Erlang is started with
<em>+hmqd off_heap</em> you can test whether the system behaves better or
worse if all processes use off heap allocation.
Then you might want to find bottle neck processes and test switching
allocation strategies for those processes only.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_process_dictionary">The Process Dictionary</h3>
<div class="paragraph"><p>There is actually one more memory area in a process where
Erlang terms can be stored, the <em>Process Dictionary</em>.</p></div>
<div class="paragraph"><p>The <em>Process Dictionary</em> (PD) is a process local key-value store. One
advantage with this is that all keys and values are stored on the heap
and there is no copying as with send or an ETS table.</p></div>
<div class="paragraph"><p>We can now update our view of a process with yet another
memory area, PD, the process dictionary:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__15.png" alt="book__15.png">
</div>
</div>
<div class="paragraph"><p>With such a small array you are bound to get some collisions before the
area grows. Each hash value points to a bucket with key value pairs.
The bucket is actually an Erlang list on the heap. Each entry in the
list is a two tuple (<em>{key, Value}</em>) also stored on the heap.</p></div>
<div class="paragraph"><p>Putting an element in the PD is not completely free, it will result in
an extra tuple and a cons, and
might cause garbage collection to be triggered. Updating a key in the
dictionary, which is in a bucket, causes the whole bucket (the whole
list) to be reallocated to make sure we don&#8217;t get pointers from the
old heap to the new heap. (In <a href="#CH-Memory">[CH-Memory]</a> we will
see the details of how garbage collection works.)</p></div>
</div>
<div class="sect2">
<h3 id="_dig_in">Dig In</h3>
<div class="paragraph"><p>In this chapter we have looked at how a process is implemented. In
particular we looked at how the memory of a process is organized, how
message passing works and the information in the PCB. We also looked
at a number of tools for inspecting processes introspection, such as
<em>erlang:process_info</em>, and the <em>hipe:show</em>*_ bifs.</p></div>
<div class="paragraph"><p>Use the functions <span class="monospaced">erlang:processes/0</span> and <span class="monospaced">erlang:process_info/1,2</span>
to inspect the processes in the system. Here are
some functions to try:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="color: #009900">Ps</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">erlang:processes</span></span>()<span style="color: #990000">.</span>
[<span style="color: #990000">&lt;</span><span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.3</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.7</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.9</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.10</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.11</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.12</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.13</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.14</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.15</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.16</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.17</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.19</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.20</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.21</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.22</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.23</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.24</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,
 <span style="color: #990000">&lt;</span><span style="color: #993399">0.25</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.26</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.27</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.28</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.29</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>]
<span style="color: #993399">2</span><span style="color: #990000">&gt;</span> <span style="color: #009900">P</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">self</span></span>()<span style="color: #990000">.</span>
<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>
<span style="color: #993399">3</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">erlang:process_info</span></span>(<span style="color: #009900">P</span>)<span style="color: #990000">.</span>
[{<span style="font-weight: bold"><span style="color: #000080">current_function</span></span>,{<span style="color: #FF6600">erl_eval</span>,<span style="color: #FF6600">do_apply</span>,<span style="color: #993399">6</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">initial_call</span></span>,{<span style="color: #FF6600">erlang</span>,<span style="font-weight: bold"><span style="color: #000080">apply</span></span>,<span style="color: #993399">2</span>}},
 {<span style="font-weight: bold"><span style="color: #000080">status</span></span>,<span style="font-weight: bold"><span style="color: #000080">running</span></span>},
 {<span style="color: #FF6600">message_queue_len</span>,<span style="color: #993399">0</span>},
 {<span style="color: #FF6600">messages</span>,[]},
 {<span style="color: #FF6600">links</span>,[<span style="color: #990000">&lt;</span><span style="color: #993399">0.27</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>]},
 {<span style="font-weight: bold"><span style="color: #000080">dictionary</span></span>,[]},
 {<span style="font-weight: bold"><span style="color: #000080">trap_exit</span></span>,<span style="color: #000080">false</span>},
 {<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>,<span style="font-weight: bold"><span style="color: #000080">error_handler</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">priority</span></span>,<span style="font-weight: bold"><span style="color: #000080">normal</span></span>},
 {<span style="font-weight: bold"><span style="color: #000080">group_leader</span></span>,<span style="color: #990000">&lt;</span><span style="color: #993399">0.26</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>},
 {<span style="color: #FF6600">total_heap_size</span>,<span style="color: #993399">17730</span>},
 {<span style="font-weight: bold"><span style="color: #000080">heap_size</span></span>,<span style="color: #993399">6772</span>},
 {<span style="color: #FF6600">stack_size</span>,<span style="color: #993399">24</span>},
 {<span style="font-weight: bold"><span style="color: #000080">reductions</span></span>,<span style="color: #993399">25944</span>},
 {<span style="font-weight: bold"><span style="color: #000080">garbage_collection</span></span>,[{<span style="color: #FF6600">min_bin_vheap_size</span>,<span style="color: #993399">46422</span>},
                      {<span style="color: #FF6600">min_heap_size</span>,<span style="color: #993399">233</span>},
                      {<span style="color: #FF6600">fullsweep_after</span>,<span style="color: #993399">65535</span>},
                      {<span style="color: #FF6600">minor_gcs</span>,<span style="color: #993399">1</span>}]},
 {<span style="color: #FF6600">suspending</span>,[]}]
 <span style="color: #993399">4</span><span style="color: #990000">&gt;</span>  <span style="font-weight: bold"><span style="color: #000000">lists:keysort</span></span>(<span style="color: #993399">2</span>,[{<span style="color: #009900">P</span>,<span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,<span style="font-weight: bold"><span style="color: #000000">erlang:process_info</span></span>(<span style="color: #009900">P</span>,
     <span style="color: #FF6600">total_heap_size</span>))} || <span style="color: #009900">P</span> <span style="color: #990000">&lt;-</span> <span style="color: #009900">Ps</span>])<span style="color: #990000">.</span>
[{<span style="color: #990000">&lt;</span><span style="color: #993399">0.10</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.13</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.14</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.15</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.16</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.17</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.19</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.20</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.21</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.22</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.23</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.25</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.28</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.29</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">233</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.6</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">752</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.9</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">752</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.11</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">1363</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.7</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">1597</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">1974</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.24</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">2585</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.26</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">6771</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.12</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">13544</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.33</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">13544</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.3</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">15143</span>},
 {<span style="color: #990000">&lt;</span><span style="color: #993399">0.27</span><span style="color: #990000">.</span><span style="color: #993399">0</span><span style="color: #990000">&gt;</span>,<span style="color: #993399">32875</span>}]
<span style="color: #993399">9</span><span style="color: #990000">&gt;</span>
</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-TypeSystem">The Erlang Type System and Tags</h2>
<div class="sectionbody">
<div class="paragraph"><p>One of the most important aspects of ERTS to understand is how ERTS
stores data, that is, how Erlang terms are stored in memory. This
gives you the basis for understanding how garbage collection works,
how message passing works, and gives you an insight into how much
memory is needed.</p></div>
<div class="paragraph"><p>In this chapter you will learn the basic data types of Erlang and
how they are implemented in ERTS. This knowledge will be essential
in understanding the chapter on memory allocation and garbage
collection, see <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
<div class="sect2">
<h3 id="_the_erlang_type_system">The Erlang Type System</h3>
<div class="paragraph"><p>Erlang is <em>strongly typed</em>. That is, there is no way to coerce one
type into another type, you can only convert from one type to another.
Compare this to e.g. C where you can coerce a <em>char</em> to an <em>int</em> or
any type pointed to by a pointer to (<em>void *</em>).</p></div>
<div class="paragraph"><p>The Erlang type lattice is quite flat, there are only a few real sub
types, numbers have the sub types integer and float, and list has the
subtypes nil and cons. (One could also argue that tuple has one
subtype for each size.)</p></div>
<div class="paragraph"><p>The Erlang Type Lattice</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__16.png" alt="book__16.png">
</div>
</div>
<div class="paragraph"><p>There is a partial order (&lt; and &gt;) on all terms in Erlang where the
types are ordered from left to right in the above lattice.</p></div>
<div class="paragraph"><p>The order is partial and not total since integers and floats
are converted before comparison. Both (1 &lt; 1.0) and (1.0 &lt; 1) are
false, and (1 =&lt; 1.0 and 1 &gt;= 1.0) and (1 =/= 1.0). The number with
the lesser precision is converted to the number with higher precision.
Usually integers are converted to floats. For very large or small
floats the float is converted to an integer. This happens if all
significant digits are to the left of the decimal point.</p></div>
<div class="paragraph"><p>Since Erlang 18, when two maps are compared for order they are
compared as follows: If one map has fewer elements than the other it
is considered smaller. Otherwise the keys are compared in term order,
where all integers are considered smaller than all floats. If all the
keys are the same then each value pair (in key order) is compared
arithmetically, i.e. by first converting them to the same precision.</p></div>
<div class="paragraph"><p>The same is true when comparing for equality, thus #{1 &#8658; 1.0} == #{1 &#8658; 1} but #{1.0 &#8658; 1} /= #{1 &#8658; 1}.</p></div>
<div class="paragraph"><p>In Erlang versions prior to 18 keys where also compared
arithmetically.</p></div>
<div class="paragraph"><p>Erlang is dynamically typed. That is, types will be checked at
runtime and if a type error occurs an exception is thrown. The
compiler does not check the types at compile time, unlike in a
statically typed language like C or Java where you can get a
type error during compilation.</p></div>
<div class="paragraph"><p>These aspects of the Erlang type system, strongly dynamically typed
with an order on the types puts some constraints on the implementation
of the language. In order to be able to check and compare types at
runtime each Erlang term has to carry its type with it.</p></div>
<div class="paragraph"><p>This is solved by <em>tagging</em> the terms.</p></div>
</div>
<div class="sect2">
<h3 id="_the_tagging_scheme">The Tagging Scheme</h3>
<div class="paragraph"><p>In the memory representation of an Erlang term a few bits are reserved
for a type tag. For performance reasons the terms are divided into
<em>immediates</em> and <em>boxed</em> terms. An immediate term can fit into a
machine word, that is, in a register or on a stack slot. A boxed term
consists of two parts: a tagged pointer and a number of words stored
on the process heap. The <em>boxes</em> stored on the heap have a header and
a body, unless it is a list.</p></div>
<div class="paragraph"><p>Currently ERTS uses a staged tag scheme, the history and reasoning
behind the this scheme is explained in a technical report from the
HiPE group. (See
link:http://www.it.uu.se/research/publications/reports/2000-029/)
The tagging scheme is implemented in <span class="monospaced">erl_term.h</span>.</p></div>
<div class="paragraph"><p>The basic idea is to use the least significant bits for tags. Since
most modern CPU architectures aligns 32- and 64-bit words, there are at
least two bits that are "unused" for pointers. These bits can be
used as tags instead. Unfortunately those two bits are not enough
for all the types in Erlang, more bits are therefore used as needed.</p></div>
<div class="sect3">
<h4 id="_tags_for_immediates">Tags for Immediates</h4>
<div class="paragraph"><p>The first two bits (the primary tag) are used as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>  00 Header (on heap) CP (on stack)
  01 List (cons)
  10 Boxed
  11 Immediate</pre>
</div></div>
<div class="paragraph"><p>The header tag is only used on the heap for header words, more on that later.
On the stack 00 indicates a return address.
The list tag is used for cons cells, and the boxed tag is used for all other
pointers to the heap. The immediate tag is used further divided like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> 00 11 Pid
 01 11 Port
 10 11 Immediate 2
 11 11 Small integer</pre>
</div></div>
<div class="paragraph"><p>Pid and ports are immediates and can be compared for equality
efficiently. They are of course in reality just references, a pid
is a process identifier and it points to a process. The process does
not reside on the heap of any process but is handled by the PCB.
A port works in much the same way.</p></div>
<div class="paragraph"><p>There are two types of integers in ERTS, small integers and
bignums. Small integers fits in one machine word minus four tag bits,
i.e. in 28 or 60 bits for 32 and 64 bits system respectively. Bignums
on the other hand can be as large as needed (only limited by the heap
space) and are stored on the heap, as boxed objects.</p></div>
<div class="paragraph"><p>By having all four tag bits as ones for small integers the emulator
can make an efficient test when doing integer arithmetic to see if
both arguments are immediates. (<span class="monospaced">is_both_small(x,y)</span> is defined as
<span class="monospaced">(x &amp; y &amp; 1111) == 1111</span>).</p></div>
<div class="paragraph"><p>The Immediate 2 tag is further divided like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> 00 10 11 Atom
 01 10 11 Catch
 10 10 11   [UNUSED]
 11 10 11 Nil</pre>
</div></div>
<div class="paragraph"><p>Atoms are made up of an index in the <em>atom table</em> and the atom tag.
Two atom immediates can be compared for equality by just comparing
their immediate representation.</p></div>
<div class="paragraph"><p>In the atom table atoms are stored as C structs like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>typedef struct atom {
    IndexSlot slot;  /* MUST BE LOCATED AT TOP OF STRUCT!!! */
    int len;         /* length of atom name */
    int ord0;        /* ordinal value of first 3 bytes + 7 bits */
    byte* name;      /* name of atom */
} Atom;</pre>
</div></div>
<div class="paragraph"><p>Thanks to the <span class="monospaced">len</span> and the <span class="monospaced">ord0</span> fields the order of two atoms can
be compared efficiently as long as they don&#8217;t start with the same four
letters.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If you for some reason generate atoms with a pattern like name
followed by a number and then store them in an ordered list or ordered
tree the atom comparison will be more expensive if they all have the
same first letters (e.g. foo_1, foo_2, etc.).</td>
</tr></table>
</div>
<div class="paragraph"><p>Not that you should ever generate atom names, since the atom table is
limited. I&#8217;m just saying, there is an evil micro optimization to be
found here.</p></div>
<div class="paragraph"><p>You would of course never do this, but if you find code that generates
atom with a number followed by a postfix name, now you know what the
author of that code might have been thinking.</p></div>
</div></div>
<div class="paragraph"><p>The Catch immediate is only used on the stack. It contains an indirect
pointer to the continuation point in the code where execution should
continue after an exception. More on this in <a href="#CH-Calls">[CH-Calls]</a>.</p></div>
<div class="paragraph"><p>The Nil tag is used for the empty list (nil or <span class="monospaced">[]</span>). The rest of the
word is filled with ones.</p></div>
</div>
<div class="sect3">
<h4 id="_tags_for_boxed_terms">Tags for Boxed Terms</h4>
<div class="paragraph"><p>Erlang terms stored on the heap uses several machine words. Lists, or
cons cells, are just two consecutive words on the heap. The head and
the tail (or car and cdr as they are called in lisp and some places in
the ERTS code).</p></div>
<div class="paragraph"><p>A string in Erlang is just a list of integers representing
characters. In releases prior to Erlang OTP R14 strings have been
encoded as ISO-latin-1 (ISO8859-1). Since R14 strings are encoded as
lists of Unicode code points. For strings in latin-1 there is no
difference since latin-1 is a subset of Unicode.</p></div>
<div class="paragraph"><p>The string "Hello" might look like this in memory:</p></div>
<div class="listingblock">
<div class="title">Representation of the string "Hello" on a 32 bit machine.</div>
<div class="content monospaced">
<pre> hend -&gt;     +-------- -------- -------- --------+
             |              ...                  |
             |              ...                  |
             |00000000 00000000 00000000 10000001| 128 + list tag  ---------------+
 stop -&gt;     |                                   |                                |
                                                                                  |
 htop -&gt;     |                                   |                                |
         132 |00000000 00000000 00000000 01111001| 120 + list tag  -------------- | -+
         128 |00000000 00000000 00000110 10001111| (H) 104 bsl 4 + small int tag &lt;+  |
         124 |00000000 00000000 00000000 01110001| 112 + list tag  ----------------- | -+
         120 |00000000 00000000 00000110 01011111| (e) 101 bsl 4 + small int tag &lt;---+  |
         116 |00000000 00000000 00000000 01110001| 112 + list tag  -------------------- | -+
         112 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;------+  |
         108 |00000000 00000000 00000000 01110001|  96 + list tag  ----------------------- | -+
         104 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;---------+  |
         100 |11111111 11111111 11111111 11111011| NIL                                        |
          96 |00000000 00000000 00000110 11111111| (o) 111 bsl 4 + small int tag &lt;------------+
             |                ...                |
 heap -&gt;     +-----------------------------------+</pre>
</div></div>
<div class="paragraph"><p>All other boxed terms start with a header word. The header word uses a
four bit header tag and the primary header tag (00), it also has an
arity which says how many words the boxed term uses. On a 32-bit
machine it looks like this: <span class="monospaced">aaaaaaaaaaaaaaaaaaaaaaaaaatttt00</span>.</p></div>
<div class="paragraph"><p>The tags are:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> 0000   ARITYVAL (Tuples)
 0001   BINARY_AGGREGATE                |
 001s   BIGNUM with sign bit            |
 0100   REF                             |
 0101   FUN                             | THINGS
 0110   FLONUM                          |
 0111   EXPORT                          |
 1000   REFC_BINARY     |               |
 1001   HEAP_BINARY     | BINARIES      |
 1010   SUB_BINARY      |               |
 1011     [UNUSED]
 1100   EXTERNAL_PID  |                 |
 1101   EXTERNAL_PORT | EXTERNAL THINGS |
 1110   EXTERNAL_REF  |                 |
 1111   MAP</pre>
</div></div>
<div class="paragraph"><p>Tuples are stored on the heap with just the arity and then each
element in the following words. The empty tuple <span class="monospaced">{}</span> is stored just as
the word 0 (header tag 0, tuple tag 0000, and arity 0).</p></div>
<div class="listingblock">
<div class="title">Representation of the tuple {104,101,108,108,111} on a 32 bit machine.</div>
<div class="content monospaced">
<pre> hend -&gt;     +-------- -------- -------- --------+
             |              ...                  |
             |              ...                  |
             |00000000 00000000 00000000 10000010| 128 + boxed tag ---------------+
 stop -&gt;     |                                   |                                |
                                                                                  |
 htop -&gt;     |                                   |                                |
         150 |00000000 00000000 00000110 11111111| (o) 111 bsl 4 + small int tag  |
         144 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag  |
         140 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag  |
         136 |00000000 00000000 00000110 01011111| (e) 101 bsl 4 + small int tag  |
         132 |00000000 00000000 00000110 10001111| (H) 104 bsl 4 + small int tag  |
         128 |00000000 00000000 00000000 10100000| 5 bsl 6 + tuple &amp; header tag &lt;-+
             |                ...                |
 heap -&gt;     +-----------------------------------+</pre>
</div></div>
<div class="paragraph"><p>A <em>binary</em> is an imutable array of bytes. There are four types of
internal representations of <em>binaries</em>. The two types <em>heap binaries</em>
and <em>refc binaries</em> contains binary data. The other two types, <em>sub
binaries</em> and <em>match contexts</em> (the BINARY_AGREGATE tag) are smaller
references into one of the other two types.</p></div>
<div class="paragraph"><p>Binaries that are 64 bytes or less can be stored directly on the
process heap as <em>heap binaries</em>. Larger binaries are reference
counted and the paylod is stored outside of the process heap, a
reference to the payload is stored on the process heap in an object
called a <em>ProcBin</em>.</p></div>
<div class="paragraph"><p>We will talk more about binaries in the <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
<div class="paragraph"><p>Integers that do not fit in a small integer (word size - 4 bits) are
stored on the heap as "bignums" (or arbitrary precision integers). A
bignum has a header word followed by a number of words encoding the
bignum. The sign part of the bignum tag (s) in the header encodes the
sign of the number (s=0 for positive numbers, and s=1 for negative
numbers).</p></div>
<div class="paragraph"><p>TODO: Describe bignum encoding. (And arithmetic ?)</p></div>
<div class="paragraph"><p>A reference is a <em>"unique"</em> term often used to tag messages in order
to basically implement a channel over a process mailbox. A references
is implemented as an 82 bit counter. After 9671406556917033397649407
calls to <span class="monospaced">make_ref</span> the counter will wrap and start over with ref 0
again. You need a really fast machine to do that many calls to
<span class="monospaced">make_ref</span> within your lifetime. Unless you restart the node, in which
case it also will start from 0 again, but then all the old local refs
are gone. If you send the pid to another node it becomes an external
ref, see below.</p></div>
<div class="paragraph"><p>On a 32-bit system a local ref takes up four 32-bit words on the
heap. On a 64-bit system a ref takes up three 64-bit words on the
heap.</p></div>
<div class="listingblock">
<div class="title">Representation of a ref in a 32-bit (or half-word) system.</div>
<div class="content monospaced">
<pre>    |00000000 00000000 00000000 11010000| Arity 3 + ref tag
    |00000000 000000rr rrrrrrrr rrrrrrrr| Data0
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data1
    |rrrrrrrr rrrrrrrr rrrrrrrr rrrrrrrr| Data2</pre>
</div></div>
<div class="paragraph"><p>The reference number is (Data2 bsl 50) + (Data1 bsl 18) + Data0.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Outline</div>
<div class="paragraph"><p><strong>TODO</strong></p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>The implementation of floats,  ports, pids. Strings as lists, IO lists,
lists on 64-bit machines. Binaries, sub binaries, and copying. Records.</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Possibly: The half-word machine. Sharing and deep copy. (or this will be in GC)</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Outro/conclusion</pre>
</div></div>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-BEAM">The Erlang Virtual Machine: BEAM</h2>
<div class="sectionbody">
<div class="paragraph"><p>BEAM (Bogumil&#8217;s/Bj&ouml;rn&#8217;s Abstract Machine) is the machine that executes
the code in the Erlang Runtime System. It is a garbage collecting,
reduction counting, virtual, non-preemptive, directly threaded,
register machine. If that doesn&#8217;t tell you much, don&#8217;t worry, in the
following sections we will go through what each of those words means
in this context.</p></div>
<div class="paragraph"><p>The virtual machine, BEAM, is at the heart of the Erlang node.
It is the BEAM that executes the Erlang code. That is, it is
BEAM that executes your application code. Understanding how BEAM
executes the code is vital to be able to profile and tune your
code.</p></div>
<div class="paragraph"><p>The BEAM design influences large parts of the rest of ERTS. The
primitives for scheduling infuences the Scheduler
(<a href="#CH-Scheduling">[CH-Scheduling]</a>), the representation of Erlang terms and the
interaction with the memory infuences the Garbage Collector
(<a href="#CH-Memory">[CH-Memory]</a>). By understanding the basic design of BEAM you
will more easily understand the implementations of these other
components.</p></div>
<div class="sect2">
<h3 id="_working_memory_a_stack_machine_it_is_not">Working Memory: A stack machine, it is not</h3>
<div class="paragraph"><p>As opposed to its predecessor Jam (Joe&#8217;s Abstract Machine) which was a
stack machine, the BEAM is a register machine loosely based on WAM
(TODO: cite). In a stack machine each operand to an instruction is
first pushed to the working stack, then the instruction pops its
arguments and then it pushes the result on the stack.</p></div>
<div class="paragraph"><p>Stack machines are quite popular among virtual machine- and
programming language implementers since they are quite easy to
generate code for, and the code becomes very compact. The compiler
does not need to do any register allocation, and most operations do
not need any arguments (in the instruction stream).</p></div>
<div class="paragraph"><p>Compiling the expression "8 + 17 * 2." to a stack machine
could yield code like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>push 8
push 17
push 2
multiply
add</pre>
</div></div>
<div class="paragraph"><p>This code can be generated directly from the parse tree of
the expression. By using Erlang expression and the modules
<span class="monospaced">erl_scan</span> and <span class="monospaced">erl_parse</span> we can build the world&#8217;s most simplistic
compiler.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">compile</span></span>(<span style="color: #009900">String</span>) <span style="color: #990000">-&gt;</span>
    [<span style="color: #009900">ParseTree</span>] <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                          <span style="font-weight: bold"><span style="color: #000000">erl_parse:parse_exprs</span></span>(
                            <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                                    <span style="font-weight: bold"><span style="color: #000000">erl_scan:string</span></span>(<span style="color: #009900">String</span>)))),
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">ParseTree</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'+'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="color: #FF6600">add</span>];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'*'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="color: #FF6600">multiply</span>];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">_Line</span>, <span style="color: #009900">I</span>}) <span style="color: #990000">-&gt;</span> [<span style="color: #FF6600">push</span>, <span style="color: #009900">I</span>]<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>And an even more simplistic virtual stack machine:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">interpret</span></span>(<span style="color: #009900">Code</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">interpret</span></span>(<span style="color: #009900">Code</span>, [])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">interpret</span></span>([<span style="color: #FF6600">push</span>, <span style="color: #009900">I</span> |<span style="color: #009900">Rest</span>], <span style="color: #009900">Stack</span>)              <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">interpret</span></span>(<span style="color: #009900">Rest</span>, [<span style="color: #009900">I</span>|<span style="color: #009900">Stack</span>]);
<span style="font-weight: bold"><span style="color: #000000">interpret</span></span>([<span style="color: #FF6600">add</span>     |<span style="color: #009900">Rest</span>], [<span style="color: #009900">Arg2</span>, <span style="color: #009900">Arg1</span>|<span style="color: #009900">Stack</span>]) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">interpret</span></span>(<span style="color: #009900">Rest</span>, [<span style="color: #009900">Arg1</span><span style="color: #990000">+</span><span style="color: #009900">Arg2</span>|<span style="color: #009900">Stack</span>]);
<span style="font-weight: bold"><span style="color: #000000">interpret</span></span>([<span style="color: #FF6600">multiply</span>|<span style="color: #009900">Rest</span>], [<span style="color: #009900">Arg2</span>, <span style="color: #009900">Arg1</span>|<span style="color: #009900">Stack</span>]) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">interpret</span></span>(<span style="color: #009900">Rest</span>, [<span style="color: #009900">Arg1</span><span style="color: #990000">*</span><span style="color: #009900">Arg2</span>|<span style="color: #009900">Stack</span>]);
<span style="font-weight: bold"><span style="color: #000000">interpret</span></span>([],              [<span style="color: #009900">Res</span>|<span style="color: #990000">_</span>])            <span style="color: #990000">-&gt;</span> <span style="color: #009900">Res</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>And a quick test run gives us the answer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">1</span><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #000000">stack_machine:interpret</span></span>(<span style="font-weight: bold"><span style="color: #000000">stack_machine:compile</span></span>(<span style="color: #FF0000">"8 + 17 * 2."</span>))<span style="color: #990000">.</span>
<span style="color: #993399">42</span></tt></pre></div></div>
<div class="paragraph"><p>Great, you have built your first virtual machine! Handling
subtraction, division and the rest of the Erlang language is left as
an exercise for the reader.</p></div>
<div class="paragraph"><p>Anyway, the BEAM is <strong>not</strong> a stack machine, it is a <em>register machine</em>.
In a register machine instruction operands are stored in registers
instead of the stack, and the result of an operation usually end up
in a specific register.</p></div>
<div class="paragraph"><p>Most register machines do still have a stack used for passing arguments
to functions and saving return addresses. BEAM has both a stack and
registers, but just as in WAM the stack slots are accessible through
registers called Y-registers. BEAM also have a number of X-registers,
and a special register X0 (sometimes also called R0) which works as
an accumulator where results are stored.</p></div>
<div class="paragraph"><p>The X registers are used as argument registers for function calls
and register X0 is used for the return value.</p></div>
<div class="paragraph"><p>The X registers are stored in a C-array in the BEAM emulator and they
are globally accessible from all functions. The X0 register is cached
in a local variable mapped to a physical machine register in the native
machine on most architectures.</p></div>
<div class="paragraph"><p>The Y registers are stored in the stack frame of the caller and only
accessible by the calling functions. To save a value across a function
call BEAM allocates a stack slot for it in the current stack frame and
then moves the value to a Y register.</p></div>
<div class="imageblock shaape" id="x_and_y_regs_in_memory">
<div class="content">
<img src="book__17.png" alt="book__17.png">
</div>
</div>
<div class="paragraph"><p>Let us compile the following program with the <em>'S'</em> flag:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">add</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">add</span></span>(<span style="color: #009900">A</span>,<span style="color: #009900">B</span>) <span style="color: #990000">-&gt;</span>  <span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">A</span>) <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">B</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">I</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">I</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Then we get the following code for the add function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #FF6600">add</span>, <span style="color: #993399">2</span>, <span style="color: #993399">2</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">add</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">add</span>},<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">allocate</span>,<span style="color: #993399">1</span>,<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>},{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="font-weight: bold"><span style="color: #000080">call</span></span>,<span style="color: #993399">1</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">4</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>},{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="font-weight: bold"><span style="color: #000080">call</span></span>,<span style="color: #993399">1</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">4</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">gc_bif</span>,<span style="color: #FF6600">'+'</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">0</span>},<span style="color: #993399">1</span>,[{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}],{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">deallocate</span>,<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
    <span style="color: #FF6600">return</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Here we can see that the code (starting at label 2) first allocates a
stack slot, to get space to save the argument <em>B</em> over the function
call <em>id(A)</em>. The value is then saved by the instruction
<em>{move,{x,1},{y,0}}</em> (read as move x1 to y0 or in imperative style: y0
:= x1).</p></div>
<div class="paragraph"><p>The id function (at label f4) is then called by
<em>{call,1,{f,4}}</em>. (We will come back to what the argument "1" stands for later.)
Then the result of the call (now in X0)
need to be saved on the stack (Y0), but the argument <em>B</em>
is saved in Y0 so the BEAM does a bit of shuffling:</p></div>
<div class="paragraph"><p>Except for the x and y registers, there are a number of special
purpose registers:</p></div>
<div class="ulist"><div class="title">Special Purpose Registers</div><ul>
<li>
<p>
Htop - The top of the heap.
</p>
</li>
<li>
<p>
E - The top of the stack.
</p>
</li>
<li>
<p>
CP - Continuation Pointer, i.e. function return address
</p>
</li>
<li>
<p>
I - instruction pointer
</p>
</li>
<li>
<p>
fcalls - reduction counter
</p>
</li>
</ul></div>
<div class="paragraph"><p>These registers are cached versions of the corresponding
fields in the PCB.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    {move,{x,0},{x,1}}. % x1 := x0 (id(A))
    {move,{y,0},{x,0}}. % x0 := y0 (B)
    {move,{x,1},{y,0}}. % y0 := x1 (id(A))</pre>
</div></div>
<div class="paragraph"><p>Now we have the second argument <em>B</em> in x0 (the first
argument register) and we can call the <em>id</em> function
again <em>{call,1,{f,4}}</em>.</p></div>
<div class="paragraph"><p>After the call x0 contains <em>id(B)</em> and y0 contains <em>id(A)</em>,
now we can do the addition: <em>{gc_bif,<em>+</em>,{f,0},1,[{y,0},{x,0}],{x,0}}</em>.
(We will go into the details of BIF calls and GC later.)</p></div>
</div>
<div class="sect2">
<h3 id="_dispatch_directly_threaded_code">Dispatch: Directly Threaded Code</h3>
<div class="paragraph"><p>The instruction decoder in BEAM is implemented with a technique called
<em>directly threaded</em> code. In this context the word <em>threaded</em> has
nothing to do with OS threads, concurrency or parallelism. It is the
execution path which is threaded through the virtual machine itself.</p></div>
<div class="paragraph"><p>If we take a look at our naive stack machine for arithmetic expressions
we see that we use Erlang atoms and pattern matching to decode which
instruction to execute. This is a very heavy machinery to just decode
machine instructions. In a real machine we would code each instruction
as a "machine word" integer.</p></div>
<div class="paragraph"><p>We can rewrite our stack machine to be a <em>byte code</em> machine
implemented in C. First we rewrite the compiler so that it produces
byte codes. This is pretty straight forward, just replace each
instruction encoded as an atom with a byte representing the
instruction. To be able to handle integers larger than 255 we encode
integers with a size byte followed by the integer encoded in bytes.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">compile</span></span>(<span style="color: #009900">Expression</span>, <span style="color: #009900">FileName</span>) <span style="color: #990000">-&gt;</span>
    [<span style="color: #009900">ParseTree</span>] <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                          <span style="font-weight: bold"><span style="color: #000000">erl_parse:parse_exprs</span></span>(
                            <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                                    <span style="font-weight: bold"><span style="color: #000000">erl_scan:string</span></span>(<span style="color: #009900">Expression</span>)))),
    <span style="font-weight: bold"><span style="color: #000000">file:write_file</span></span>(<span style="color: #009900">FileName</span>, <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">ParseTree</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">stop</span></span>()])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'+'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">add</span></span>()];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'*'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">multiply</span></span>()];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">_Line</span>, <span style="color: #009900">I</span>}) <span style="color: #990000">-&gt;</span> [<span style="font-weight: bold"><span style="color: #000000">push</span></span>(), <span style="font-weight: bold"><span style="color: #000080">integer</span></span>(<span style="color: #009900">I</span>)]<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">stop</span></span>()     <span style="color: #990000">-&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">add</span></span>()      <span style="color: #990000">-&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">multiply</span></span>() <span style="color: #990000">-&gt;</span> <span style="color: #993399">2</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">push</span></span>()     <span style="color: #990000">-&gt;</span> <span style="color: #993399">3</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">integer</span></span>(<span style="color: #009900">I</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">L</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="font-weight: bold"><span style="color: #000000">binary:encode_unsigned</span></span>(<span style="color: #009900">I</span>)),
    [<span style="font-weight: bold"><span style="color: #000080">length</span></span>(<span style="color: #009900">L</span>) | <span style="color: #009900">L</span>]<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Now lets write a simple virtual machine in C. The full code can
be found in [appendix].</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> STOP <span style="color: #993399">0</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> ADD  <span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> MUL  <span style="color: #993399">2</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> PUSH <span style="color: #993399">3</span>

<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span>   <span style="color: #990000">(</span>stack<span style="color: #990000">[--</span>sp<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>X<span style="color: #990000">)</span> <span style="color: #990000">(</span>stack<span style="color: #990000">[</span>sp<span style="color: #990000">++]</span> <span style="color: #990000">=</span> X<span style="color: #990000">)</span>

<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>code<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span> stack<span style="color: #990000">[</span><span style="color: #993399">1000</span><span style="color: #990000">];</span>
  <span style="color: #009900">int</span> sp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> size <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="color: #009900">char</span> <span style="color: #990000">*</span>ip <span style="color: #990000">=</span> code<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(*</span>ip <span style="color: #990000">!=</span> STOP<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(*</span>ip<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ADD<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">());</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> MUL<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">());</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> PUSH<span style="color: #990000">:</span>
      size <span style="color: #990000">=</span> <span style="color: #990000">*</span>ip<span style="color: #990000">++;</span>
      val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>size<span style="color: #990000">--)</span> <span style="color: #FF0000">{</span> val <span style="color: #990000">=</span> val <span style="color: #990000">*</span> <span style="color: #993399">256</span> <span style="color: #990000">+</span> <span style="color: #990000">*</span>ip<span style="color: #990000">++;</span> <span style="color: #FF0000">}</span>
      <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>val<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>You see, a virtual machine written in C does not need to
be very complicated. This machine is just a loop checking
the byte code at each instruction by looking at the value
pointed to by the _instruction pointer _ (ip).</p></div>
<div class="paragraph"><p>For each byte code instruction it will switch on the instruction byte
code and jump to the case which executes the instruction. This
requires a decoding of the instruction and then a jump to the correct
code. If we look at the assembly for vsm.c (<span class="monospaced">gcc -S vsm.c</span>) we see
the inner loop of the decoder:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>L11:
        movl    -16(%ebp), %eax
        movzbl  (%eax), %eax
        movsbl  %al, %eax
        addl    $1, -16(%ebp)
        cmpl    $2, %eax
        je      L7
        cmpl    $3, %eax
        je      L8
        cmpl    $1, %eax
        jne     L5</pre>
</div></div>
<div class="paragraph"><p>It has to compare the byte code with each instruction code and
then do a conditional jump. In a real machine with many instructions
this can become quite expensive.</p></div>
<div class="paragraph"><p>A better solution would be to have a table with the address of
the code then we could just use an index into the table
to load the address and jump without
the need to do a compare. This technique is sometimes called
<em>token threaded code</em>. Taking this a step further we can
actually store the address of the function implementing the
instruction in the code memory. This is called
<em>subroutine threaded code</em>.</p></div>
<div class="paragraph"><p>This approach will make the decoding simpler at runtime, but it makes
the whole VM more complicated by requiring a loader. The loader
replaces the byte code instructions with addresses to
functions implementing the instructions.</p></div>
<div class="paragraph"><p>A loader might look like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="color: #009900">void</span> <span style="color: #990000">(*</span>instructionp_t<span style="color: #990000">)(</span><span style="color: #009900">void</span><span style="color: #990000">);</span>

<span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span><span style="font-weight: bold"><span style="color: #000000">read_file</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">FILE</span> <span style="color: #990000">*</span>file<span style="color: #990000">;</span>
  <span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span>code<span style="color: #990000">;</span>
  <span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span>cp<span style="color: #990000">;</span>
  <span style="color: #009900">long</span>  size<span style="color: #990000">;</span>
  <span style="color: #009900">char</span> ch<span style="color: #990000">;</span>
  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> val<span style="color: #990000">;</span>

  file <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fopen</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> <span style="color: #FF0000">"r"</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>file <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_END<span style="color: #990000">);</span>
  size <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ftell</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  code <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">calloc</span></span><span style="color: #990000">(</span>size<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>instructionp_t<span style="color: #990000">));</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>code <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  cp <span style="color: #990000">=</span> code<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_SET<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span> <span style="color: #990000">(</span> ch <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #990000">)</span> <span style="color: #990000">!=</span> EOF <span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>ch<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ADD<span style="color: #990000">:</span> <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>add<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> MUL<span style="color: #990000">:</span> <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>mul<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> PUSH<span style="color: #990000">:</span>
        <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>pushi<span style="color: #990000">;</span>
        ch <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
        val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>ch<span style="color: #990000">--)</span> <span style="color: #FF0000">{</span> val <span style="color: #990000">=</span> val <span style="color: #990000">*</span> <span style="color: #993399">256</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
        <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>instructionp_t<span style="color: #990000">)</span> val<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #990000">*</span>cp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>stop<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">fclose</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> code<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>As we can see, we do more work at load time here, including the
decoding of integers larger than 255. (Yes, I know, the code
is not safe for very large integers.)</p></div>
<div class="paragraph"><p>The decode and dispatch loop of the VM becomes quite simple though:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  sp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  running <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>running<span style="color: #990000">)</span> <span style="color: #990000">(*</span>ip<span style="color: #990000">++)();</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Then we just need to implement the instructions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">()</span>  <span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">,</span>y<span style="color: #990000">;</span> x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> y <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x <span style="color: #990000">+</span> y<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">mul</span></span><span style="color: #990000">()</span>  <span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">,</span>y<span style="color: #990000">;</span> x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> y <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x <span style="color: #990000">*</span> y<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">pushi</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">;</span>   x <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)*</span>ip<span style="color: #990000">++;</span>       <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">stop</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> running <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In BEAM this concept is taken one step further, and BEAM uses
<em>directly threaded code</em> (sometimes called only <em>thread code</em>). In
directly threaded code the call and return sequence is replaced by
direct jumps to the implementation of the next instruction. In order
to implement this in C, BEAM uses the GCC extension "labels as
values".</p></div>
<div class="paragraph"><p>We will look closer at the BEAM emulator later but we will take a
quick look at how the add instruction is implemented. The code is
somewhat hard to follow due to the heavy usage of macros. The
STORE_ARITH_RESULT macro actually hides the dispatch function which
looks something like: <em>I += 4; Goto(*I);</em>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>OpCode<span style="color: #990000">)</span>    lb_##OpCode
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">Goto</span></span><span style="color: #990000">(</span>Rel<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> <span style="color: #990000">*(</span>Rel<span style="color: #990000">)</span>

<span style="color: #990000">...</span>

 <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>i_plus_jId<span style="color: #990000">):</span>
 <span style="color: #FF0000">{</span>
     <span style="color: #008080">Eterm</span> result<span style="color: #990000">;</span>

     <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">is_both_small</span></span><span style="color: #990000">(</span>tmp_arg1<span style="color: #990000">,</span> tmp_arg2<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
         <span style="color: #008080">Sint</span> i <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">signed_val</span></span><span style="color: #990000">(</span>tmp_arg1<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">signed_val</span></span><span style="color: #990000">(</span>tmp_arg2<span style="color: #990000">);</span>
         <span style="font-weight: bold"><span style="color: #000000">ASSERT</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">MY_IS_SSMALL</span></span><span style="color: #990000">(</span>i<span style="color: #990000">)</span> <span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #000000">IS_SSMALL</span></span><span style="color: #990000">(</span>i<span style="color: #990000">));</span>
         <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">MY_IS_SSMALL</span></span><span style="color: #990000">(</span>i<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
             result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">make_small</span></span><span style="color: #990000">(</span>i<span style="color: #990000">);</span>
             <span style="font-weight: bold"><span style="color: #000000">STORE_ARITH_RESULT</span></span><span style="color: #990000">(</span>result<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

     <span style="color: #FF0000">}</span>
     arith_func <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ARITH_FUNC</span></span><span style="color: #990000">(</span>mixed_plus<span style="color: #990000">);</span>
     <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> do_big_arith2<span style="color: #990000">;</span>
 <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>To make it a little easier to understand how the BEAM dispatcher is
implemented let us take a somewhat imagenary example. We will start
with some real external BEAM code but then I will invent some internal
BEAM instructions and implement them in C.</p></div>
<div class="paragraph"><p>If we start with a simple add function in Erlang:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">add</span></span>(<span style="color: #009900">A</span>,<span style="color: #009900">B</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">A</span>) <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">B</span>)<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>Compiled to BEAM code this will look like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #FF6600">add</span>, <span style="color: #993399">2</span>, <span style="color: #993399">2</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">add</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">add</span>},<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">allocate</span>,<span style="color: #993399">1</span>,<span style="color: #993399">2</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>},{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="font-weight: bold"><span style="color: #000080">call</span></span>,<span style="color: #993399">1</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">4</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>},{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="font-weight: bold"><span style="color: #000080">call</span></span>,<span style="color: #993399">1</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">4</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">gc_bif</span>,<span style="color: #FF6600">'+'</span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">0</span>},<span style="color: #993399">1</span>,[{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}],{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">deallocate</span>,<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
    <span style="color: #FF6600">return</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>(See add.erl and add.S in <a href="#AP-listings">[AP-listings]</a> for the full code.)</p></div>
<div class="paragraph"><p>Now if we zoom in on the the three instructions betwen the function calls
in this code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>},{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">move</span>,{<span style="color: #FF6600">x</span>,<span style="color: #993399">1</span>},{<span style="color: #FF6600">y</span>,<span style="color: #993399">0</span>}}<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>This code first saves the return value of the function call (x0) in a
new register (x1). Then it moves the caller saves register (y0) to
the first argument register (x0). Finally it moves the saved value in
x1 to the caller save register (y0) so that it will survive the next
function call.</p></div>
<div class="paragraph"><p>Imagine that we would implement three instruction in BEAM called
<span class="monospaced">move_xx</span>, <span class="monospaced">move_yx</span>, and <span class="monospaced">move_xy</span> (These instructions does not exist
in the BEAM we just use them to illustrate this example):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>OpCode<span style="color: #990000">)</span>    lb_##OpCode
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">Goto</span></span><span style="color: #990000">(</span>Rel<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> <span style="color: #990000">*((</span><span style="color: #009900">void</span> <span style="color: #990000">*)</span>Rel<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span>N<span style="color: #990000">)</span> <span style="color: #990000">(</span>Eterm <span style="color: #990000">*)</span> I<span style="color: #990000">[(</span>N<span style="color: #990000">)+</span><span style="color: #993399">1</span><span style="color: #990000">]</span>


  <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>move_xx<span style="color: #990000">):</span>
  <span style="color: #FF0000">{</span>
     <span style="font-weight: bold"><span style="color: #000000">x</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">))</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">x</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">));</span>
     I <span style="color: #990000">+=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
     <span style="font-weight: bold"><span style="color: #000000">Goto</span></span><span style="color: #990000">(*</span>I<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>move_yx<span style="color: #990000">):</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">x</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">))</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">y</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">));</span>
    I <span style="color: #990000">+=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">Goto</span></span><span style="color: #990000">(*</span>I<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>


  <span style="font-weight: bold"><span style="color: #000000">OpCase</span></span><span style="color: #990000">(</span>move_xy<span style="color: #990000">):</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">y</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">))</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">x</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">Arg</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">));</span>
    I <span style="color: #990000">+=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">Goto</span></span><span style="color: #990000">(*</span>I<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>Note that the star in "<span class="monospaced">goto</span> <span class="monospaced">&#42;</span>" does not mean dereference, the
expression means jump to an address pointer, we should really write it
as "<span class="monospaced">goto&#42;</span>".</p></div>
<div class="paragraph"><p>Now imagine that the compile C code for these instructions end up at
memory addresses 0x3000, 0x3100, and 0x3200. When the BEAM code is
loaded the three move instructions in the code will be replaced by the
memory addresses of the implementation of the instructions. Imagine
that the code (<span class="monospaced">{move,{x,0},{x,1}}, {move,{y,0},{x,0}},
{move,{x,1},{y,0}}</span>) is loaded at address 0x1000:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>                     /  0x1000: 0x3000 -&gt; 0x3000: OpCase(move_xx): x(Arg(1)) = x(Arg(0))
{move,{x,0},{x,1}}  {   0x1004: 0x0                                I += 3;
                     \  0x1008: 0x1                                Goto(*I);
                     /  0x100c: 0x3200
{move,{y,0},{x,0}}  {   0x1010: 0x1
                     \  0x1014: 0x1
                     /  0x1018: 0x3100
{move,{y,0},{x,0}}  {   0x101c: 0x1
                     \  0x1020: 0x1</pre>
</div></div>
<div class="paragraph"><p>The word at address 0x1000 points to the implementation of
the move_xx instruction. If the register <span class="monospaced">I</span> contains the instruction
pointer, pointing to 0x1000 then the dispatch will be to fetch <span class="monospaced">&#42;I</span>
(i.e. 0x3000) and jump to that address. ("<span class="monospaced">goto&#42;</span> <span class="monospaced">&#42;I</span>")</p></div>
<div class="paragraph"><p>In <a href="#CH-Instructions">[CH-Instructions]</a> we will look more closely at some real
BEAM instructions and how they are implemented.</p></div>
</div>
<div class="sect2">
<h3 id="_scheduling_non_preemptive_reduction_counting">Scheduling: Non-preemptive, Reduction counting</h3>
<div class="paragraph"><p>Most modern multi-threading operating systems use preemptive scheduling.
This means that the operating system decides when to switch from one
process to another, regardless of what the process is doing. This protects
the other processes from a processes misbehaving by not yielding in time.</p></div>
<div class="paragraph"><p>In cooperative multitasking which uses a non-preemptive scheduler the
running process decides when to yield. This has the advantage that the
yielding process can do so in a known state.</p></div>
<div class="paragraph"><p>For example in a language such as Erlang with dynamic memory
management and tagged values, an implementation may be designed such
that a process only yields when there are no untagged values in
working memory.</p></div>
<div class="paragraph"><p>Take the add instruction as an example, to add two Erlang integers,
the emulator first has to untag the integers, then add them together
and then tag the result as an integer. If a fully preemptive scheduler
is used there would be no guarantee that the process isn&#8217;t suspended
while the integers are untagged. Or the process could be suspended
while it is creating a tuple on the heap, leaving us with half a
tuple. This would make it very hard to traverse a suspended process
stack and heap.</p></div>
<div class="paragraph"><p>On the language level all processes are running concurrently and the
programmer should not have to deal with explicit yields. BEAM solves
this by keeping track of how long a process has been running. This is
done by counting <em>reductions</em>. The term originaly comes from the
mathematical term beta-reduction used in lambda calculus.</p></div>
<div class="paragraph"><p>The definition of a reduction in BEAM not very specific, but we can
see it as a small piece of work, which shouldn&#8217;t take <em>too long</em>.
Each function call is counted as a reduction, and BEAM does a test
upon entry to each function if the process has used up all its
reductions.</p></div>
<div class="paragraph"><p>Since there are no loops in Erlang, only tail-recursive function
calls, it is very hard to write a program that does any significant
amount of work without using up its reductions.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning">
</td>
<td class="content">
<div class="paragraph"><p>There are some BIFs that can run for a long time only using 1
reduction, like <span class="monospaced">term_to_binary</span> and <span class="monospaced">binary_to_term</span>. Try to make
sure that you only call these BIFs with small terms or binaries, or
you might lock up the scheduler for a very long time.</p></div>
<div class="paragraph"><p>Also, if you write your own NIFs, make sure they can yield and that
they bump the reduction counter by an amount proportional to their
run time.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>We will go through the details of how the scheduler works in
<a href="#CH-Scheduling">[CH-Scheduling]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_memory_management_garbage_collecting">Memory Management: Garbage Collecting</h3>
<div class="paragraph"><p>Erlang supports garbage collection; as an Erlang progammer you do not
need to do explicit memory management. On the BEAM level, though, the
code is responsible for checking for stack and heap overrun, and for
allocating enough space on the stack and the heap.</p></div>
<div class="paragraph"><p>The BEAM instruction <span class="monospaced">test_heap</span> will ensure that there is as much
space on the heap as requested. If needed the instruction will call
the garbage collector to reclaim space on the heap. The garbage
collector in turn will call the lower levels of the memory subsystem
to allocate or free memory as needed. We will look at the details
of memory management and garbage collection in <a href="#CH-Memory">[CH-Memory]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_beam_it_is_virtually_unreal">BEAM: it is virtually unreal</h3>
<div class="paragraph"><p>The BEAM is a virtual machine, by that we mean that it is implemented
in software instead of in hardware. There has been projects to
implement the BEAM by FPGA, and there is nothing stopping anyone from
implementing the BEAM in hardware. A better description might be to
call the BEAM an Abstract machine, and see it as blueprint for a
machine which can execute BEAM code. And, in fact, the "am" in BEAM
stands for "Abstract Machine".</p></div>
<div class="paragraph"><p>In this book we will make no distinction between abstract machines,
and virtual machines or their implementation. In a more formal setting
an abstract machine is a theoretical model of a computer, and a
virtual machine is either a software implementation of an abstract
machine or a software emulator of a real physical machine.</p></div>
<div class="paragraph"><p>Unfortunately there exist no official specification of the BEAM, it is
currently only defined by the implementation in Erlang/OTP.
If you want to implement your own BEAM you would have to try to mimic
the current implementation not knowing which parts are essential and
which parts are accidental. You would have to mimic every observable
behavior to be sure that you have a valid BEAM interpreter.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p><strong>TODO:</strong> Conclusion and handover to the chapters on instructions.</p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-beam_modules">Modules and The BEAM File Format (16p)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="modules">Modules</h3>
<div class="paragraph"><p>What is a module. How is code loaded. How does hot code loading work. How does the purging work. How does the code server work. How does dynamic code loading work, the code search path. Handling code in a distributed system. (Overlap with chapter 10, have to see what goes where.) Parameterized modules. How p-mods are implemented. The trick with p-mod calls. Here follows an excerpt from the current draft:</p></div>
</div>
<div class="sect2">
<h3 id="BEAM_files">The BEAM File Format</h3>
<div class="paragraph"><p>The definite source of information about the beam file format is obviously the source code of beam_lib.erl (see <a href="https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl">https://github.com/erlang/otp/blob/maint/lib/stdlib/src/beam_lib.erl</a>). There is actually also a more readable but slightly dated description of the format written by the main developer and maintainer of Beam (see <a href="http://www.erlang.se/~bjorn/beam_file_format.html">http://www.erlang.se/~bjorn/beam_file_format.html</a>).</p></div>
<div class="paragraph"><p>The beam file format is based on the interchange file format (EA IFF)#, with two small changes. We will get to those shortly. An IFF file starts with a header followed by a number of &ldquo;chunks&rdquo;. There are a number of standard chunk types in the IFF specification dealing mainly with images and music. But the IFF standard also lets you specify your own named chunks, and this is what BEAM does.</p></div>
<div class="paragraph"><p>An IFF file looks like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{‘FORM’:4
 SIZE:4
 FORMTYPE:4
 [{CHUNKNAME:4
   CHUNKSIZE:4
   [CHUNKDATA:1]:CHUNKSIZE
   [2-BYTEPAD:1]:0..1
  }
 ]:SIZE-4
}</pre>
</div></div>
<div class="paragraph"><p>Beam files differ from standard IFF files, in that each chunk is aligned on 4-byte boundary (i.e. 32 bit word) instead of on a 2-byte boundary as in the IFF standard. To indicate that this isn&rsquo;t a standard IFF file the IFF header is tagged with &ldquo;FOR1&rdquo; instead of &ldquo;FORM&rdquo;. The IFF specification suggest this tag for future extensions.</p></div>
<div class="paragraph"><p>The form type used by beam is &ldquo;BEAM&rdquo;. A beam file has the following layout:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{‘FOR1’:4
 SIZE:4
 ‘BEAM’:4
 [{CHUNKNAME:4
  CHUNKSIZE:4
  [CHUNKDATA:1]:CHUNKSIZE
  [4-BYTEPAD:1]:0..3
  }
 ]:SIZE-4
}</pre>
</div></div>
<div class="paragraph"><p>This file format prepends all areas with the size of the following area making it easy to parse the file directly while reading it from disk. To illustrate the structure and content of beam files, we will write a small program that extract all the chunks from a beam file. To make this program as simple and readable as possible we will not parse the file while reading, instead we load the whole file in memory as a binary, and then parse each chunk. The first step is to get a list of all chunks:</p></div>
<!-- While this is reasonably simple code, is it going to be obvious to readers what's going on here? It may require a bit of explanation as to how this code works. - bmacdonald -->
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">beamfile</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">/</span><span style="color: #993399">1</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read</span></span>(<span style="color: #009900">Filename</span>) <span style="color: #990000">-&gt;</span>
   {<span style="color: #FF6600">ok</span>, <span style="color: #009900">File</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">file:read_file</span></span>(<span style="color: #009900">Filename</span>),
   <span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"FOR1"</span>,
     <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
     <span style="color: #FF0000">"BEAM"</span>,
     <span style="color: #009900">Chunks</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">File</span>,
   {<span style="color: #009900">Size</span>, <span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Chunks</span>, [])}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>, <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Tail</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
   <span style="font-style: italic"><span style="color: #9A1900">%% Align each chunk on even 4 bytes</span></span>
   <span style="color: #009900">ChunkLength</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">Size</span>),
   <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Chunk</span><span style="color: #990000">:</span><span style="color: #009900">ChunkLength</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Tail</span>,
   <span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Rest</span>, [{[<span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>], <span style="color: #009900">Size</span>, <span style="color: #009900">Chunk</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Acc</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span> (<span style="color: #993399">4</span> <span style="color: #990000">*</span> ((<span style="color: #009900">N</span><span style="color: #990000">+</span><span style="color: #993399">3</span>) <span style="font-weight: bold"><span style="color: #0000FF">div</span></span> <span style="color: #993399">4</span>))<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>A sample run might look like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; beamfile:read("beamfile.beam").
{848,
[{"Atom",103,
  &lt;&lt;0,0,0,14,4,102,111,114,49,4,114,101,97,100,4,102,105,
    108,101,9,114,101,97,...&gt;&gt;},
 {"Code",341,
  &lt;&lt;0,0,0,16,0,0,0,0,0,0,0,132,0,0,0,14,0,0,0,4,1,16,...&gt;&gt;},
 {"StrT",8,&lt;&lt;"FOR1BEAM"&gt;&gt;},
 {"ImpT",88,&lt;&lt;0,0,0,7,0,0,0,3,0,0,0,4,0,0,0,1,0,0,0,7,...&gt;&gt;},
 {"ExpT",40,&lt;&lt;0,0,0,3,0,0,0,13,0,0,0,1,0,0,0,13,0,0,0,...&gt;&gt;},
 {"LocT",16,&lt;&lt;0,0,0,1,0,0,0,6,0,0,0,2,0,0,0,6&gt;&gt;},
 {"Attr",40,
  &lt;&lt;131,108,0,0,0,1,104,2,100,0,3,118,115,110,108,0,0,...&gt;&gt;},
 {"CInf",130,
  &lt;&lt;131,108,0,0,0,4,104,2,100,0,7,111,112,116,105,111,...&gt;&gt;},
 {"Abst",0,&lt;&lt;&gt;&gt;}]}</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Here we can see the chunk names that beam uses.</pre>
</div></div>
<div class="sect3">
<h4 id="atom_table_chunk">Atom table chunk</h4>
<div class="paragraph"><p>The chunk named Atom is mandatory and contains all atoms referred to by the module. The format of the atom chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{“Atom”:4
  CHUNKSIZE:4
  NUMBEROFATOMS:4
  [{LENGTH:1,
    ATOM:LENGTH}]:NUMBEROFATOMS
  [4-BYTEPAD:1]:0..3
}</pre>
</div></div>
<div class="paragraph"><p><em>NOTE:</em> There is a further constraint that the module name must be stored as the first atom in the table.</p></div>
<div class="paragraph"><p>Let us add a decoder for the atom chunk to our Beam file reader:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">beamfile</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">/</span><span style="color: #993399">1</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read</span></span>(<span style="color: #009900">Filename</span>) <span style="color: #990000">-&gt;</span>
   {<span style="color: #FF6600">ok</span>, <span style="color: #009900">File</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">file:read_file</span></span>(<span style="color: #009900">Filename</span>),
   <span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"FOR1"</span>,
     <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
     <span style="color: #FF0000">"BEAM"</span>,
     <span style="color: #009900">Chunks</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">File</span>,
   {<span style="color: #009900">Size</span>, <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Chunks</span>, []),[])}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>, <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Tail</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
   <span style="font-style: italic"><span style="color: #9A1900">%% Align each chunk on even 4 bytes</span></span>
   <span style="color: #009900">ChunkLength</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">Size</span>),
   <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Chunk</span><span style="color: #990000">:</span><span style="color: #009900">ChunkLength</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Tail</span>,
   <span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Rest</span>, [{[<span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>], <span style="color: #009900">Size</span>, <span style="color: #009900">Chunk</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Acc</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Atom"</span>, <span style="color: #009900">_Size</span>,
             <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_Numberofatoms</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Atoms</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>}
            | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
   <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">atoms</span>,<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">Atoms</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([<span style="color: #009900">Chunk</span>|<span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="font-style: italic"><span style="color: #9A1900">%% Not yet implemented chunk</span></span>
   <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>, [<span style="color: #009900">Chunk</span>|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([],<span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">Acc</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Atomlength</span>, <span style="color: #009900">Atom</span><span style="color: #990000">:</span><span style="color: #009900">Atomlength</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #009900">Atomlength</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">-&gt;</span>
   [<span style="font-weight: bold"><span style="color: #000080">list_to_atom</span></span>(<span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="color: #009900">Atom</span>)) | <span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">_Alignment</span>) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span> (<span style="color: #993399">4</span> <span style="color: #990000">*</span> ((<span style="color: #009900">N</span><span style="color: #990000">+</span><span style="color: #993399">3</span>) <span style="font-weight: bold"><span style="color: #0000FF">div</span></span> <span style="color: #993399">4</span>))<span style="color: #990000">.</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="export_table_chunk">Export table chunk</h4>
<div class="paragraph"><p>The chunk named &ldquo;ExpT&rdquo; (for EXPort Table) is mandatory and contains information about which functions are exported.</p></div>
<div class="paragraph"><p>The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{“ExpT”:4
  CHUNKSIZE:4
  NUMBEROFENTRIES:4
  [{FUNCTION:4,
    ARITY:4,
    LABEL:4
   }]:NUMBEROFENTRIES
}</pre>
</div></div>
<div class="paragraph"><p>We can extend our parse_chunk function by adding the following clause after the atom handling clause:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"ExpT", _Size,
             &lt;&lt;_Numberofentries:32/integer, Exports/binary&gt;&gt;}
            | Rest], Acc) -&gt;
   parse_chunks(Rest,[{exports,parse_exports(Exports)}|Acc]);

…

parse_exports(&lt;&lt;Function:32/integer,
               Arity:32/integer,
               Label:32/integer,
               Rest/binary&gt;&gt;) -&gt;
   [{Function, Arity, Label} | parse_exports(Rest)];
parse_exports(&lt;&lt;&gt;&gt;) -&gt; [].</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="import_table_chunk">Import table chunk</h4>
<div class="paragraph"><p>The chunk named &ldquo;ImpT&rdquo; (for IMPort Table) is mandatory and contains information about which functions are imported.</p></div>
<div class="paragraph"><p>The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{“ImpT”:4
  CHUNKSIZE:4
  NUMBEROFENTRIES:4
  [{FUNCTION:4,
    ARITY:4,
    LABEL:4
   }]:NUMBEROFENTRIES
}</pre>
</div></div>
<div class="paragraph"><p>The code for parsing the import table is basically the same as that for parsing the export table, and we can actually use the same function to parse entries in both tables. See the full code at the end of the chapter.</p></div>
</div>
<div class="sect3">
<h4 id="code_chunk">Code Chunk</h4>
<div class="paragraph"><p>The chunk named &ldquo;Code&rdquo; contains the beam code for the module and is mandatory. The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{“Code”:4
  CHUNKSIZE:4
  SUBSIZE:4
  INSTRUCTIONSET:4
  OPCODEMAX:4
  NUMBEROFLABELS:4
  NUMBEROFFUNCTIONS:4
  [OPCODE:1]:(CHUNKSIZE-SUBSIZE)
  [4-BYTEPAD:1]:0..3
}</pre>
</div></div>
<div class="paragraph"><p>The field SUBSIZE stores the number of words before the code starts. This makes it possible to add new information fields in the code chunk without breaking older loaders. The INSTRUCTIONSET field indicates which version of the instruction set the file uses. The version number is increased if any instruction is changed in an incompatible way.</p></div>
<div class="paragraph"><p>The OPCODEMAX field indicates the highest number of any opcode used in the code. New instructions can be added to the system in a way such that older loaders still can load a newer file as long as the instructions used in the file are within the range the loader knows about.</p></div>
<div class="paragraph"><p>The field NUMBEROFLABELS contains the number of labels so that a loader can preallocate a label table of the right size. The field NUMBEROFFUNCTIONS contains the number of functions so that a loader can preallocate a functions table of the right size.</p></div>
<div class="paragraph"><p>We can parse out the code chunk by adding the following code to our program:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"Code", Size, &lt;&lt;SubSize:32/integer,Chunk/binary&gt;&gt;
              } | Rest], Acc) -&gt;
   &lt;&lt;Info:SubSize/binary, Code/binary&gt;&gt; = Chunk,
   %% 8 is size of CunkSize &amp; SubSize
   OpcodeSize = Size - SubSize - 8,
   &lt;&lt;OpCodes:OpcodeSize/binary, _Align/binary&gt;&gt; = Code,
   parse_chunks(Rest,[{code,parse_code_info(Info), OpCodes}
                      | Acc]);

..

parse_code_info(&lt;&lt;Instructionset:32/integer,
                  OpcodeMax:32/integer,
                  NumberOfLabels:32/integer,
                  NumberOfFunctions:32/integer,
                  Rest/binary&gt;&gt;) -&gt;
   [{instructionset, Instructionset},
    {opcodemax, OpcodeMax},
    {numberoflabels, NumberOfLabels},
    {numberofFunctions, NumberOfFunctions} |
    case Rest of
         &lt;&lt;&gt;&gt; -&gt; [];
         _ -&gt; [{newinfo, Rest}]
    end].</pre>
</div></div>
<div class="paragraph"><p>We will learn how to decode the beam instructions in a later chapter, aptly named &ldquo;BEAM Instructions&rdquo;.</p></div>
</div>
<div class="sect3">
<h4 id="_string_table_chunk">String table chunk</h4>
<div class="paragraph"><p>The chunk named &ldquo;StrT&rdquo; is mandatory and contains all constant string literals in the module as one long string. If there are no string literals the chunks should still be present but empty and of size 0.</p></div>
<div class="paragraph"><p>The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{“StrT”:4
 CHUNKSIZE:4
 [STRINGBYTE]:CHUNKSIZE
 [4-BYTEPAD:1]:0..3
}</pre>
</div></div>
<div class="paragraph"><p>The string chunk can be parsed easilly by just turning the string of bytes into a binary:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"StrT", _Size, &lt;&lt;Strings/binary&gt;&gt;} | Rest], Acc) -&gt;
    parse_chunks(Rest,[{strings,binary_to_list(Strings)}|Acc]);</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_attributes_chunk">Attributes Chunk</h4>
<div class="paragraph"><p>The chunk named "Attr" is optional, but some OTP tools expect the attributes to be present. The releashandler expect the "vsn" attribute to be present. You can get the version attribute from a file with: beam_lib:version(Filename), this function assumes that there is an attribute chunk with a "vsn" attribute present.</p></div>
<div class="paragraph"><p>The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{"Attr":4
  CHUNKSIZE:4
  ATTRIBUTES:CHUNKSIZE
  [4-BYTEPAD]:0..3
}</pre>
</div></div>
<div class="paragraph"><p>We can parse the attribute chunk like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"Attr", Size, Chunk} | Rest], Acc) -&gt;
    &lt;&lt;Bin:Size/binary, _Pad/binary&gt;&gt; = Chunk,
    Attribs = binary_to_term(Bin),
    parse_chunks(Rest,[{attributes,Attribs}|Acc]);</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_compilation_information_chunk">Compilation Information Chunk</h4>
<div class="paragraph"><p>The chunk named "CInf" is optional, but some OTP tools expect the information to be present.</p></div>
<div class="paragraph"><p>The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{"CInf":4
  CHUNKSIZE:4
  INFORMATION:CHUNKSIZE
  [4-BYTEPAD]:0..3
}</pre>
</div></div>
<div class="paragraph"><p>We can parse the compilation information chunk like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"CInf", Size, Chunk} | Rest], Acc) -&gt;
    &lt;&lt;Bin:Size/binary, _Pad/binary&gt;&gt; = Chunk,
    CInfo = binary_to_term(Bin),
    parse_chunks(Rest,[{compile_info,CInfo}|Acc]);</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_local_function_table_chunk">Local Function Table Chunk</h4>
<div class="paragraph"><p>The chunk named "LocT" is optional and intended for cross reference tools.</p></div>
<div class="paragraph"><p>The format is the same as that of the export table:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{"LocT":4
  CHUNKSIZE:4
  NUMBEROFENTRIES:4
  [{FUNCTION:4,
    ARITY:4,
    LABEL:4
   }]:NUMBEROFENTRIES
}</pre>
</div></div>
<div class="paragraph"><p>The code for parsing the local function table is basically the same as that for parsing the export and the import table, and we can actually use the same function to parse entries in all tables. See the full code at the end of the chapter.</p></div>
</div>
<div class="sect3">
<h4 id="_literal_table_chunk">Literal Table Chunk</h4>
<div class="paragraph"><p>The chunk named "LitT" is optional and contains compressed code literals. The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{"LitT":4
  CHUNKSIZE:4
  COMPRESSEDTABLESIZE:4
  &lt;NUMBEROFLITERALS:4,
    [{SIZE:4
      LITERAL:SIZE
     }]:NUMBEROFLITERALS
   }&gt;:COMPRESSEDTABLESIZE
}</pre>
</div></div>
<div class="paragraph"><p>The whole table is compressed with zlib:compress/1, and can be uncompressed with zlib_uncompress/1.</p></div>
<div class="paragraph"><p>We can parse the chunk like this</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"LitT", _ChunkSize,
              &lt;&lt;_CompressedTableSize:32, Compressed/binary&gt;&gt;}
             | Rest], Acc) -&gt;
    &lt;&lt;_NumLiterals:32,Table/binary&gt;&gt; = zlib:uncompress(Compressed),
    Literals = parse_literals(Table),
    parse_chunks(Rest,[{literals,Literals}|Acc]);</pre>
</div></div>
<div class="paragraph"><p>&#8230;</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_literals(&lt;&lt;Size:32,Literal:Size/binary,Tail/binary&gt;&gt;) -&gt;
    [binary_to_term(Literal) | parse_literals(Tail)];
parse_literals(&lt;&lt;&gt;&gt;) -&gt; [].</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_abstract_code_chunk">Abstract Code Chunk</h4>
<div class="paragraph"><p>The chunk named "Abst" is optional and may contain the code in abstract form. If you give the flag debug_info to the compiler it will store the abstract syntax tree for the module in this chunk. OTP tools like the debugger and Xref need the abstract form. The format of the chunk is:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{"Abst":4
  CHUNKSIZE:4
  [ABSTRACTCODE]:CHUNKSIZE
  [4-BYTEPAD:1]:0..3
}</pre>
</div></div>
<div class="paragraph"><p>We can parse the chunk like this</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>parse_chunks([{"Abst", _ChunkSize, &lt;&lt;&gt;&gt;} | Rest], Acc) -&gt;
    parse_chunks(Rest,Acc);
parse_chunks([{"Abst", _ChunkSize, &lt;&lt;AbstractCode/binary&gt;&gt;} | Rest], Acc) -&gt;
    parse_chunks(Rest,[{abstract_code,binary_to_term(AbstractCode)}|Acc]);</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_compression_and_encryption">Compression and Encryption</h4>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect3">
<h4 id="_function_trace_chunk_obsolete">Function Trace Chunk (Obsolete)</h4>
<div class="paragraph"><p>This chunk type is now obsolete.</p></div>
</div>
<div class="sect3">
<h4 id="_bringing_it_all_together">Bringing it all Together</h4>
<div class="paragraph"><p>TODO</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Instructions">Generic BEAM Instructions (25p)</h2>
<div class="sectionbody">
<div class="paragraph"><p>Beam has two different instructions sets, an internal instructions
set, called <em>specific</em>, and an external instruction set, called
<em>generic</em>.</p></div>
<div class="paragraph"><p>The generic instruction set is what could be called the official
instruction set, this is the set of instructions used by both the
compiler and the Beam interpreter. If there was an official Erlang
Virtual Machine specification it would specify this
instruction set. If you want to write your own compiler to the Beam,
this is the instruction set you should target. If you want to write
your own EVM this is the instruction set you should handle.</p></div>
<div class="paragraph"><p>The external instruction set is quite stable, but it does change
between Erlang versions, especially between major versions.</p></div>
<div class="paragraph"><p>This is the instruction set which we will cover in this chapter.</p></div>
<div class="paragraph"><p>The other instruction set, the specific, is an optimized instruction
set used by the Beam to implement the external instruction set. To
give you an understanding of how the Beam works we will cover this
instruction set in <a href="#CH-Internal_instructions">[CH-Internal_instructions]</a>. The internal
instruction set can change without warning between minor version or
even in patch releases. Basing any tool on the internal instruction
set is risky.</p></div>
<div class="paragraph"><p>In this chapter I will go through the general syntax for the
instructions and some instruction groups in detail, a complete list of
instructions with short descriptions can be found in
<a href="#AP-Instructions">[AP-Instructions]</a>.</p></div>
<div class="sect2">
<h3 id="_instruction_definitions">Instruction definitions</h3>
<div class="paragraph"><p>The names and opcodes of the generic instructions are defined
in <span class="monospaced">lib/compiler/src/genop.tab</span>.</p></div>
<div class="paragraph"><p>The file contains a version number for the Beam instruction format, which
also is wirtten to <span class="monospaced">.beam</span> files. This number has so far never changed
and is still at version 0. If the external format would be changed in a
non backwards compatible way this number would be changed.</p></div>
<div class="paragraph"><p>The file genop.tab is used as input by <span class="monospaced">beam_makeops</span> which is a perl script
which generate code from the ops tabs. The generator is used both to generate
Erlang code for the compiler (beam_opcodes.hrl and beam_opcodes.erl) and to
generate C code for the emulator ( TODO: Filenames).</p></div>
<div class="paragraph"><p>Any line in the file starting with "#" is a comment and ignored by
<span class="monospaced">beam_makeops</span>. The file can contain definitions, which turns into a
binding in the perl script, of the form:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>NAME=EXPR</pre>
</div></div>
<div class="paragraph"><p>Like, e.g.:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>BEAM_FORMAT_NUMBER=0</pre>
</div></div>
<div class="paragraph"><p>The Beam format number is the same as the <span class="monospaced">instructionset</span> field in
the external beam format. It is only bumped when a backwards
icnompatible change to the instruction set is made.</p></div>
<div class="paragraph"><p>The main content of the file are the opcode definitions of the form:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>OPNUM: [-]NAME/ARITY</pre>
</div></div>
<div class="paragraph"><p>Where OPNUM and ARITY are integers, NAME is an identifier starting
with a lowercase letter (a-z), and <em>:</em>, <em>-</em>, and <em>/</em> are litterals.</p></div>
<div class="paragraph"><p>For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1: label/1</pre>
</div></div>
<div class="paragraph"><p>The minus sign (-) indicates a depricated function. A depricated
function keeps its opcode in order for the loader to be sort of
backwards compatible (it will recognize depricated instructions and
refuse to load the code).</p></div>
<div class="paragraph"><p>In the rest of this Chapter we will go through some BEAM instructions
in detail. For a full list with brief descriptions see:
<a href="#AP-Instructions">[AP-Instructions]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_beam_code_listings">BEAM code listings</h3>
<div class="paragraph"><p>As we saw in <a href="#CH-Compiler">[CH-Compiler]</a> we can give the option <em>S</em> to the
Erlang compiler to get a <span class="monospaced">.S</span> file with the BEAM code for the module
in a human and machine readable format (actually as Erlang terms).</p></div>
<div class="paragraph"><p>Given the file beamexample1.erl:</p></div>
-module(beamexample1).

-export([id/1]).

id(I) when is_integer(I) -> I.
<div class="paragraph"><p>When compiled with <span class="monospaced">erlc -S beamexample.erl</span> we get the following
beamexmaple.S file:</p></div>
{module, beamexample1}.  %% version = 0

{exports, [{id,1},{module_info,0},{module_info,1}]}.

{attributes, []}.

{labels, 7}.


{function, id, 1, 2}.
  {label,1}.
    {line,[{location,"beamexample1.erl",5}]}.
    {func_info,{atom,beamexample1},{atom,id},1}.
  {label,2}.
    {test,is_integer,{f,1},[{x,0}]}.
    return.


{function, module_info, 0, 4}.
  {label,3}.
    {line,[]}.
    {func_info,{atom,beamexample1},{atom,module_info},0}.
  {label,4}.
    {move,{atom,beamexample1},{x,0}}.
    {line,[]}.
    {call_ext_only,1,{extfunc,erlang,get_module_info,1}}.


{function, module_info, 1, 6}.
  {label,5}.
    {line,[]}.
    {func_info,{atom,beamexample1},{atom,module_info},1}.
  {label,6}.
    {move,{x,0},{x,1}}.
    {move,{atom,beamexample1},{x,0}}.
    {line,[]}.
    {call_ext_only,2,{extfunc,erlang,get_module_info,2}}.
<div class="paragraph"><p>In addition to the actual beam code for the integer identity
function we also get some meta instructions.</p></div>
<div class="paragraph"><p>The first line <span class="monospaced">{module, beamexample1}. %% version = 0</span> tells
us the module name "beamexample1" and the version number for
the instruction set "0".</p></div>
<div class="paragraph"><p>Then we get a list of exported functions "id/1, module_info/0,
module_info/1". As we can see the compiler has added two auto
generated functions to the code. These two functions are just
dispatchers to the generic module info BIFs (erlang:module_info/1 and
erlang:module_info/2) with the name of the module added as the first
argument.</p></div>
<div class="paragraph"><p>The line {attributes, []} list all defined compiler attributes, none in
our case.</p></div>
<div class="paragraph"><p>Then we get to know that there are less than 7 labels in the module,
<span class="monospaced">{labels, 7}</span>, which makes it easy to do code loading in one pass.</p></div>
<div class="paragraph"><p>The last type of meta instruction is the <span class="monospaced">function</span> instruction on
the format <span class="monospaced">{function, Name, Arity, StartLabel}</span>. As we can see with
the <span class="monospaced">id</span> function the start label is actually the second label in the
code of the function.</p></div>
<div class="paragraph"><p>The instruction <span class="monospaced">{label, N}</span> is not really an instruction, it does not
take up any space in memory when loaded. It is just to give a local
name (or number) to a position in the code. Each label potentially
marks the beginning of a basic block since it is a potential
destination of a jump.</p></div>
<div class="paragraph"><p>The first two instructions following the first label (<span class="monospaced">{label,1}</span>)
are actually error generating code which adds the line number and
module, function and arity information and throws an exception.
That are the instructions <span class="monospaced">line</span> and <span class="monospaced">func_info</span>.</p></div>
<div class="paragraph"><p>The meat of the function is after <span class="monospaced">{label,2}</span>, the instruction
<span class="monospaced">{test,is_integer,{f,1},[{x,0}]}</span>. The test instruction tests if its
arguments (in the list at the end, that is variable {x,0} in this
case) fulfills the test, in this case is an integer (is_integer).
If the test succeeds the next instruction (<span class="monospaced">return</span>) is executed.
Otherwise the functions fails to label 1 (<span class="monospaced">{f,1}</span>), that is,
execution continues at label one where a function clause exception
is thrown.</p></div>
<div class="paragraph"><p>The other two functions in the file are auto generated. If we look at
the second function the instruction <span class="monospaced">{move,{x,0},{x,1}}</span> moves the
argument in register x0 to the second argument register x1. Then the
instruction <span class="monospaced">{move,{atom,beamexample1},{x,0}}</span> moves the module name
atom to the first argument register x1. Finally a tail call is made to
<span class="monospaced">erlang:get_module_info/2</span>
(<span class="monospaced">{call_ext_only,2,{extfunc,erlang,get_module_info,2}}</span>). As we will
see in the next section there are several different call instructions.</p></div>
</div>
<div class="sect2">
<h3 id="_calls">Calls</h3>
<div class="paragraph"><p>As we have seen in <a href="#CH-Calls">[CH-Calls]</a> there are several different types
of calls in Erlang. To distinguish between local and remote calls
in the instruction set, remote calls have <span class="monospaced">_ext</span> in their instruction
names. Local calls just have a label in the code of the module, while
remote calls takes a destination of the form <span class="monospaced">{extfunc, Module, Function,
Arity}</span>.</p></div>
<div class="paragraph"><p>To distinguish between ordinary (stack building) calls and
tail-recursive calls, the latter have either <span class="monospaced">_only</span> or <span class="monospaced">_last</span> in
their name. The variant with <span class="monospaced">_last</span> will also deallocate as many
stack slot as given by the last argument.</p></div>
<div class="paragraph"><p>There is also a <span class="monospaced">call_fun Arity</span> instruction that calls the closure
stored in register {x, Arity}. The arguments are stored in x0 to {x,
Arity-1}.</p></div>
<div class="paragraph"><p>For a full listing of all types of call instructions see
<a href="#AP-Instructions">[AP-Instructions]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_stack_and_heap_management">Stack (and Heap) Management</h3>
<div class="paragraph"><p>The stack and the heap of an Erlang process on Beam share the same memory
area see <a href="#CH-Processes">[CH-Processes]</a> and <a href="#CH-Memory">[CH-Memory]</a> for a full discussion.
The stack grows toward lower addresses and the heap toward higher addresses.
Beam will do a garbage collection if more space than what is available is
needed on either the stack or the heap.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>A leaf function</strong>
</dt>
<dd>
<p>
A leaf function is a function which doesn&#8217;t call
                    any other function.
</p>
</dd>
<dt class="hdlist1">
<strong>A non leaf function</strong>
</dt>
<dd>
<p>
A non leaf function is a function which may call
                        another function.
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>On entry to a non leaf function the <em>continuation pointer</em> (CP) is saved on
the stack, and on exit it is read back from the stack. This is done by the
<span class="monospaced">allocate</span> and <span class="monospaced">deallocate</span> instructions, which are used for setting up
and tearing down the stack frame for the current instruction.</p></div>
<div class="paragraph"><p>A function skeleton for a leaf function looks like this:</p></div>
{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    ...
    return.
<div class="paragraph"><p>A function skeleton for a non leaf function looks like this:</p></div>
{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    {allocate,Need,Live}.

    ...
    call ...
    ...

    {deallocate,Need}.
    return.
<div class="paragraph"><p>The instruction <span class="monospaced">allocate StackNeed Live</span> saves the continuation
pointer (CP) and allocate space for <span class="monospaced">StackNeed</span> extra words on the
stack. If a GC is needed during allocation save <span class="monospaced">Live</span> number of X
registers. E.g. if <span class="monospaced">Live</span> is 2 then registers X0 and X1 are saved.</p></div>
<div class="paragraph"><p>When allocating on the stack, the stack pointer (E) is decreased.</p></div>
       Before           After
         | xxx |            | xxx |
    E -> | xxx |            | xxx |
         |     |            | ??? | caller save slot
           ...         E -> | CP  |
           ...                ...
 HTOP -> |     |    HTOP -> |     |
         | xxx |            | xxx |
<div class="paragraph"><p>For a full listing of all types of allocate and deallocate
instructions see <a href="#AP-Instructions">[AP-Instructions]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_message_passing">Message Passing</h3>
<div class="paragraph"><p>Sending a message is straight forward in beam code. You just use the
<span class="monospaced">send</span> instruction. Note though that the send instruction does not
take any arguments, it is more like a function call. It assumes that
the arguments (the destination and the message) are in the argument
registers X0 and X1. The message is also copied from X1 to X0.</p></div>
<div class="paragraph"><p>Receiving a message  is a bit more complicated since  it involves both
selective receive with pattern  matching and introduces a yield/resume
point within  a function  body. (There  is also  a special  feature to
minimize message queue scanning using refs, more on that later.)</p></div>
<div class="sect3">
<h4 id="_a_minimal_receive_loop">A Minimal Receive Loop</h4>
<div class="paragraph"><p>A minimal receive loop, which accepts any message and has no timeout
(e.g. <span class="monospaced">receive _ &#8594; ok end</span>) looks like this in BEAM code:</p></div>
<figure id="simple_receive">
<title>A simple receive loop.</title>
<programlisting>

  L1: loop_rec L2 x0
      remove_message
      ...
      jump L3

  L2: wait L1

  L3: ...
</programlisting>
</figure>
<div class="paragraph"><p>The <span class="monospaced">loop_rec L2 x0</span> instruction first checks if there is any message
in the message queue. If there are no messages execution jumps to L2,
where the process will be suspended waiting for a message to arrive.</p></div>
<div class="paragraph"><p>If there is a message in the message queue the <span class="monospaced">loop_rec</span> instruction
also moves the message from the <em>m-buf</em> to the process heap. See
<a href="#CH-Memory">[CH-Memory]</a> and <a href="#CH-Processes">[CH-Processes]</a> for details of the m-buf
handling.</p></div>
<div class="paragraph"><p>For code like <span class="monospaced">receive _ &#8594; ok end</span>, where we accept any messages,
there is no pattern matching needed, we just do a <span class="monospaced">remove_message</span>
which unlinks the next message from the message queue and stores a
pointer in X0. (It also removes any timeout, more on this soon.)</p></div>
</div>
<div class="sect3">
<h4 id="_a_selective_receive_loop">A Selective Receive Loop</h4>
<div class="paragraph"><p>For a selective receive like e.g. <span class="monospaced">receive [] &#8594; ok end</span> we will
loop over the message queue to check if any message in the queue
matches.</p></div>
<figure id="selective_receive">
<title>A selective receive loop.</title>
<programlisting>

  L2: loop_rec L4  X0
      test is_nil L3 X0
      remove_message
      move {atom,ok} X0
      return
  L3: loop_rec_end L2
  L4: wait L2

</programlisting>
</figure>
<div class="paragraph"><p>In this case we do a pattern match for Nil after the loop_rec
instruction if there was a message in the mailbox. If the message
doesn&#8217;t match we end up at L3 where the instruction <span class="monospaced">loop_rec_end</span>
advances the save pointer to the next message (<span class="monospaced">p&#8594;msg.save =
&amp;(*p&#8594;msg.save)&#8594;next</span>) and jumps back to L2.</p></div>
<div class="paragraph"><p>If there are no more messages in the message queue the process is
suspended by the <span class="monospaced">wait</span> instruction at L4 with the save pointer pointing
to the end of the message queue. When the processes is rescheduled
it will only look at new messages in the message queue (after the save
point).</p></div>
</div>
<div class="sect3">
<h4 id="_a_receive_loop_with_a_timeout">A Receive Loop With a Timeout</h4>
<div class="paragraph"><p>If we add a timeout to our selective receive the wait instruction is
replaced by a wait_timeout instruction followed by a timeout
instruction and the code following the timeout.</p></div>
<figure id="timeout_receive">
<title>A receive loop with a timeout.</title>
<programlisting>

  L6: loop_rec L8 X0
      test is_nil L7 X0
      remove_message
      move {atom,ok} X0
      return
  L7: loop_rec_end L6
  L8: wait_timeout L6 {integer,1000}
      timeout
      move {atom,done} X0
      return

</programlisting>
</figure>
<div class="paragraph"><p>The <span class="monospaced">wait_timeout</span> instructions sets up a timeout timer with the given
time (1000 ms in our example) and it also saves the address of the
next instruction (the <span class="monospaced">timeout</span>) in <span class="monospaced">p&#8594;def_arg_reg[0]</span> and then
when the timer is set,  <span class="monospaced">p&#8594;i</span> is set to point to def_arg_reg.</p></div>
<div class="paragraph"><p>This means that if no matching message arrives while the process is
suspended a timeout will be triggered after 1 second and execution for
the process will continue at the timeout instruction.</p></div>
<div class="paragraph"><p>Note that if a message that doesn&#8217;t match arrives in the mailbox, the
process is scheduled for execution and will run the pattern matching
code in the receive loop, but the timeout will not be canceled. It is
the <span class="monospaced">remove_message</span> code which also removes any timeout timer.</p></div>
<div class="paragraph"><p>The <span class="monospaced">timeout</span> instruction resets the save point of the mailbox to the
first element in the queue, and clears the timeout flag (F_TIMO) from
the PCB.</p></div>
</div>
<div class="sect3">
<h4 id="_the_synchronous_call_trick_aka_the_ref_trick">The Synchronous Call Trick (aka The Ref Trick)</h4>
<div class="paragraph"><p>We have now come to the last version of our receive loop, where we
use the ref trick alluded to earlier to avoid a long message box scan.</p></div>
<div class="paragraph"><p>A common pattern in Erlang code is to implement a type of "remote
call" with send and a receive between two processes. This is for
example used by gen_server. This code is often hidden behind a library
of ordinary function calls. E.g., you call the function
<span class="monospaced">counter:increment(Counter)</span> and behind the scene this turns into
something like <span class="monospaced">Counter ! {self(), inc}, receive {Counter, Count} &#8594;
Count end</span>.</p></div>
<div class="paragraph"><p>This is usually a nice abstraction to encapsulate state in a
process. There is a slight problem though when the mailbox of the
calling process has many messages in it. In this case the receive will
have to check each message in the mailbox to find out that no message
except the last matches the return message.</p></div>
<div class="paragraph"><p>This can quite often happen if you have a server that receives many
messages and for each message does a number of such remote calls, if
there is no back throttle in place the servers message queue will
fill up.</p></div>
<div class="paragraph"><p>To remedy this there is a hack in ERTS to recognize this pattern and
avoid scanning the whole message queue for the return message.</p></div>
<div class="paragraph"><p>The compiler recognizes code that uses a newly created reference (ref)
in a receive (see <a href="#ref_trick_code">[ref_trick_code]</a>), and emits code to avoid the
long inbox scan since the new ref can not already be in the inbox.</p></div>
<figure id="ref_trick_code">
<title>The Ref Trick Pattern.</title>
<programlisting source="Erlang">

  Ref = make_ref(),
  Counter ! {self(), inc, Ref},
  receive
    {Ref, Count} -> Count
  end.
</programlisting>
</figure>
<div class="paragraph"><p>This gives us the following skeleton for a complete receive, see
<a href="#ref_receive">[ref_receive]</a>.</p></div>
<figure id="ref_receive">
<title>A receive with the ref_trick.</title>
<programlisting>
     ...
     recv_mark L11
     call_ext 0 {extfunc,erlang,make_ref,0}
     ...

     recv_set L11
L11: loop_rec L13 x0
     test is_eq_exact L12 [X0, Y0]
     remove_message
     ...

L12: loop_rec_end L11
L13: wait_timeout L11 {integer,1000}
     timeout.
     ...

</programlisting>
</figure>
<div class="paragraph"><p>The <span class="monospaced">recv_mark</span> instruction saves the current position (the end
<span class="monospaced">msg.last</span>) in <span class="monospaced">msg.saved_last</span> and the address of the label
in <span class="monospaced">msg.mark</span></p></div>
<div class="paragraph"><p>The <span class="monospaced">recv_set</span> instruction checks that <span class="monospaced">msg.mark</span> points to the next
instruction and in that case moves the save point (<span class="monospaced">msg.save</span>) to the
last message received before the creation of the ref
(<span class="monospaced">msg.saved_last</span>). If the mark is invalid ( i.e. not equal to
<span class="monospaced">msg.save</span>) the instruction does nothing.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Calls">Different Types of Calls, Linking and Hot Code Loading (5p)</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>Local calls, remote calls, closure calls, tuple calls, p-mod
calls. The code server. Linking. Hot code loading, purging. (Overlap
with Chapter 4, have to see what goes where.) Higher order functions,
Implementation of higher order functions. Higher order functions and
hot code loading. Higher order functions in a distributed system.</p></div>
</div></div>
<div class="sect2">
<h3 id="_hot_code_loading">Hot Code Loading</h3>
<div class="paragraph"><p>In Erlang there is a semantic difference between a local function call
and a remote function call. A remote call, that is a call to a
function in a named module, is guaranteed to go to the latest loaded
version of that module. A local call, an unqualified call to a function
within the same module, is guaranteed to go to the same version
of the code as the caller.</p></div>
<div class="paragraph"><p>A call to a local function can be turned into a remote call by
specifying the module name at the call site. This is usually
done with the ?MODULE macro as in <span class="monospaced">?MODULE:foo()</span>.
A remote call to a non local module can not be turned into
a local call, i.e. there is no way to guarantee the version
of the callee in the caller.</p></div>
<div class="paragraph"><p>This is an important feature of Erlang which makes <em>hot code loading</em>
or <em>hot upgrades</em> possible. Just make sure you have a remote
call somewhere in your server loop and you can then load new code
into the system while it is running; when execution reaches the
remote call it will switch to executing the new code.</p></div>
<div class="paragraph"><p>A common way of writing server loops is to have a local call
for the main loop and a code upgrade handler which does
a remote call and possibly a state upgrade:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">State</span>) <span style="color: #990000">-&gt;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">receive</span></span>
    <span style="color: #FF6600">upgrade</span> <span style="color: #990000">-&gt;</span>
       <span style="color: #009900">NewState</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">?MODULE</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">code_upgrade</span></span>(<span style="color: #009900">State</span>),
       <span style="font-weight: bold"><span style="color: #000080">?MODULE</span></span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">NewState</span>);
     <span style="color: #009900">Msg</span> <span style="color: #990000">-&gt;</span>
       <span style="color: #009900">NewState</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">handle_msg</span></span>(<span style="color: #009900">Msg</span>, <span style="color: #009900">State</span>),
       <span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">NewState</span>)
   <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="paragraph"><p>With this construct, which is basically what <span class="monospaced">gen_server</span> uses,
the programmer has control over when and how a code upgrade is done.</p></div>
<div class="paragraph"><p>The hot code upgrade is one of the most important features of Erlang
which makes it possible to write servers that operates 24/7 year out
and year in. It is also one of the main reasons why Erlang is
dynamically typed. It is very hard in a statically typed language to
give type for the <span class="monospaced">code_upgrade</span> function. (It is also hard to give the
type of the loop function). These types will change in the future as
the type of State changes to handle new features.</p></div>
<div class="paragraph"><p>For a language implementer concerned with performance, the hot code
loading functionality is a burden though. Since each call to or from a
remote module can change to new code in the future it is very hard to
do whole program optimization across module boundaries. (Hard but not
impossible, there are solutions but so far I have not seen one fully
implemented).</p></div>
</div>
<div class="sect2">
<h3 id="_code_loading">Code Loading</h3>
<!--
Shouldn't Code Loading come before Hot Code Loading? Or are the two topics not related in that way? - bmacdonald
-->
<div class="paragraph"><p>In the Erlang Runtime System the code loading is handled by the
code server. The code server will call the lower level BIFs in the
<span class="monospaced">erlang</span> module for the actual loading. But the code server also
determines the purging policy.</p></div>
<div class="paragraph"><p>The runtime system can keep two versions of each module, a <em>current</em>
version and an <em>old</em> version. All fully qualified (remote) calls go
to the current version. Local calls in the old version and return
addresses on the stack can still go to the old version.</p></div>
<div class="paragraph"><p>If a third version of a module is loaded and there are still processes
running (have pointers on the stack to) the code server
will kill those processes and purge the old code. Then the current
version will become old and the third version will be loaded as the
current version.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Beam_loader">The BEAM Loader</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transforming_from_generic_to_specific_instructions">Transforming from Generic to Specific instructions</h3>
<div class="paragraph"><p>The BEAM loader does not just take the external beam format and writes
it to memory. It also does a number of transformations on the code
and translates from the external (generic) format to the internal
(specific) format.</p></div>
<div class="paragraph"><p>The code for the loader can be found in <span class="monospaced">beam_load.c</span> (in
<span class="monospaced">erts/emulator/</span>) but most of the logic for the translations are in
the file <span class="monospaced">ops.tab</span> (in the same directory).</p></div>
<div class="paragraph"><p>The first step of the loader is to parse beam file, basically the same
work as we did in Erlang in <a href="#CH-beam_modules">[CH-beam_modules]</a> but written in C.</p></div>
<div class="paragraph"><p>Then the rules in ops.tab are applied to instructions in the code
chunk to translate the generic instruction to one or more specific
instructions.</p></div>
<div class="paragraph"><p>The translation table works through pattern matching. Each line in the
file defines a pattern of one or more generic instructions with
arguments and optionally an arrow followed by one or more instructions
to translate to.</p></div>
<div class="paragraph"><p>The transformations in ops tab tries to handle patterns of
instructions generated by the compiler and peephole optimize them to
fewer specific instructions. The ops tab transformations tries to
generate jump tables for patterns of selects.</p></div>
<div class="paragraph"><p>The file ops.tab is not parsed at runtime, instead a pattern matching
program is generated from ops.tab and stored in an array in a
generated C file. The perl script <span class="monospaced">beam_makeops</span> (in
<span class="monospaced">erts/emulator/utils</span>) generates a target specific set of opcodes and
translation programs in the files <span class="monospaced">beam_opcodes.h</span> and
<span class="monospaced">beam_opcodes.c</span> (these files end up in the given target directory
e.g. <span class="monospaced">erts/emulator/x86_64-unknown-linux-gnu/opt/smp/</span>).</p></div>
<div class="paragraph"><p>The same program (beam_makeops) also generates the Erlang code for the
compiler back end <span class="monospaced">beam_opcodes.erl</span>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Internal_instructions">BEAM Internal Instructions</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="CH-Scheduling">Scheduling</h2>
<div class="sectionbody">
<div class="paragraph"><p>To fully understand where time in an ERTS system is spent you need
to understand how the system decides which Erlang code to run
and when to run it. These decisions are made by the Scheduler.</p></div>
<div class="paragraph"><p>The scheduler is responsible for the real-time guarantees of the
system. In a strict Computer Science definition of the word
real-time, a real-time system have to be able to guarantee a response
within a specified time. That is, there are real deadlines
and each task has to complete before its deadline. In Erlang there are
no such guarantees, a <em>timeout</em> in Erlang is only guaranteed to <strong>not</strong>
trigger <strong>before</strong> the given deadline.</p></div>
<div class="paragraph"><p>In a general system like Erlang where we want to be able to handle all
sorts of programs and loads, the scheduler will have to make some
compromises. There will always be corner cases where a generic
scheduler will behave badly. After reading this chapter
you will have a deeper understanding of how
the Erlang scheduler works and especially when it might not work
optimally. You should be able to design your system to avoid the corner
cases and you should also be able to analyze a misbehaving system.</p></div>
<div class="sect2">
<h3 id="_concurrency_parallelism_and_preemptive_multitasking">Concurrency, Parallelism, and Preemptive Multitasking</h3>
<div class="paragraph"><p>Erlang is a concurrent language. When we say that processes run
concurrently we mean that for an outside observer it looks like two
processes are executing at the same time. In a single core system this
is achieved by preemptive multitasking. This means that one process
will run for a while, and then the scheduler of the virtual machine
will suspend it and let another process run.</p></div>
<div class="paragraph"><p>In a multicore or a distributed system we can achieve true
parallelism, that is, two or more processes actually executing at the
exact same time. In an SMP enabled emulator the system uses several
OS threads to indirectly execute Erlang processes by running one
scheduler and emulator per thread. In a system using the default
settings for ERTS there will be one thread per enabled core (physical
or hyper threaded).</p></div>
<div class="paragraph"><p>We can check that we have a system capable of parallel execution,
by checking if SMP support is enabled:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>iex(1)&gt; :erlang.system_info :smp_support
true</pre>
</div></div>
<div class="paragraph"><p>We can also check how many schedulers we have running in the
system:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>iex(2)&gt; :erlang.system_info :schedulers_online
4</pre>
</div></div>
<div class="paragraph"><p>We can see this information in the Observer as shown
in the figure below.</p></div>
<div class="paragraph"><p>If we spawn more processes than we have have schedulers and
let them do some busy work we can see that there are a number
of processes <em>running</em> in parallel and some processes that
are <em>runnable</em> but not currently running. We can see this
with the function <span class="monospaced">erlang:process_info/2</span>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1&gt; Loop = fun (0, _) -&gt; ok; (N, F) -&gt; F(N-1, F) end,
   BusyFun = fun() -&gt; spawn(fun () -&gt; Loop(1000000, Loop) end) end,
   SpawnThem = fun(N) -&gt; [ BusyFun() || _ &lt;- lists:seq(1, N)] end,
   GetStatus = fun() -&gt; lists:sort([{erlang:process_info(P, [status]), P}
                        || P &lt;- erlang:processes()]) end,
   RunThem = fun (N) -&gt; SpawnThem(N), GetStatus() end,
   RunThem(8).

[{[{status,garbage_collecting}],&lt;0.62.0&gt;},
 {[{status,garbage_collecting}],&lt;0.66.0&gt;},
 {[{status,runnable}],&lt;0.60.0&gt;},
 {[{status,runnable}],&lt;0.61.0&gt;},
 {[{status,runnable}],&lt;0.63.0&gt;},
 {[{status,runnable}],&lt;0.65.0&gt;},
 {[{status,runnable}],&lt;0.67.0&gt;},
 {[{status,running}],&lt;0.58.0&gt;},
 {[{status,running}],&lt;0.64.0&gt;},
 {[{status,waiting}],&lt;0.0.0&gt;},
 {[{status,waiting}],&lt;0.1.0&gt;},

...</pre>
</div></div>
<div class="paragraph"><p>We will look closer at the different statuses that a process
can have later in this chapter, but for now all we need
to know is that a process that is <em>running</em> or <em>garbage_collecting</em>
is actually running in on a scheduler.
Since the machine in the example has four cores and four schedulers
there are four process running in parallel (the shell process and
three of the <em>busy processes</em>). There are also five busy processes
waiting to run in the state <em>runnable</em>.</p></div>
<div class="paragraph"><p>By using the <em>Load Charts</em> tab in the Observer we can see that all
four schedulers are fully loaded while the busy processes execute.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>observer:start().
ok
3&gt; RunThem(8).</pre>
</div></div>
<div class="imageblock">
<div class="content">
<img src="../images/observer_load.jpg" alt="Observer">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_preemptive_multitasking_in_erts_cooperating_in_c">Preemptive Multitasking in ERTS Cooperating in C</h3>
<div class="paragraph"><p>The preemptive multitasking on the Erlang level is achieved by
cooperative multitasking on the C level. The Erlang language, the
compiler and the virtual machine works together to ensure that the
execution of an Erlang process will yield within a limited time and
let the next process run. The technique used to measure and limit the
allowed execution time is called reduction counting, we will look at
all the details of reduction counting soon.</p></div>
</div>
<div class="sect2">
<h3 id="_reductions">Reductions</h3>
<div class="paragraph"><p>One can describe the scheduling in BEAM as preemptive scheduling on top
of cooperative scheduling.
A process can only be suspended at certain
points of the execution, such as at a receive or a function call. In
that way the scheduling is cooperative---a process has to execute code
which allows for suspension. The nature of Erlang code makes it
almost impossible for a process to run for a long time without doing a
function call. There are a few Built In Functions (BIFs) that still
can take too long without yielding. Also, if you call C code in a
badly implemented Native Implemented Function (NIF) you might block
one scheduler for a long time.
We will look at how to write well behaved NIFs in &lt;ref linkend="ch.c"/&gt;.)</p></div>
<div class="paragraph"><p>Since there are no other loop constructs than recursion and
list comprehensions,
there is no way to loop forever without doing a function call.
Each function call is counted as a <span class="monospaced">reduction</span>; when the reduction
limit for the process is reached it is suspended.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Reductions
The term reduction comes from the Prolog ancestry of Erlang.
In Prolog each execution step is a goal-reduction, where each
step reduces a logic problem into its constituent parts, and
then tries to solve each part.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_how_many_reductions_will_you_get">How Many Reductions Will You Get?</h4>
<div class="paragraph"><p>When a process is scheduled it will get a number of reductions defined
by <span class="monospaced">CONTEXT_REDS</span> (defined in <span class="monospaced">erl_vm.h</span>,
currently as 2000). After using
up its reductions or when doing a receive without a matching message
in the inbox, the process will be suspended and a new processes will
be scheduled.</p></div>
<div class="paragraph"><p>If the VM has executed as many reductions as defined by
<span class="monospaced">INPUT_REDUCTIONS</span> (currently <span class="monospaced">2*CONTEXT_REDS</span>, also defined in
<span class="monospaced">erl_vm.h</span>) or if there is no process ready to run
the scheduler will do system-level activities. That is, basically,
check for IO; we will cover the details soon.</p></div>
</div>
<div class="sect3">
<h4 id="_what_is_a_reduction_really">What is a Reduction Really?</h4>
<div class="paragraph"><p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can not yield in the middle, it has to make
sure it is in a clean state and return. In order to be re-entrant it
has to save its internal state somehow before it returns and then set
up the state again on re-entry. This can be very costly, especially
for a function that sometimes only does little work and sometimes lot.
The reason for writing a function in C instead of Erlang is usually to
achieve performance and to not do unnecessary book keeping work.
Since there is no clear definition of what one reduction is, other
than a function call on the Erlang level, there is a risk that a
function implemented in C takes many more clock cycles per reduction
than a normal Erlang function. This can lead to an imbalance in
the scheduler, and even starvation.</p></div>
<div class="paragraph"><p>For example in Erlang versions prior to R16, the BIFs
<span class="monospaced">binary_to_term/1</span> and <span class="monospaced">term_to_binary/1</span> were non yielding and only
counted as one reduction. This meant that a process calling these
functions on large terms could starve other processes. This can even
happen in a SMP system because of the way processes are balanced
between schedulers, which we will get to soon.</p></div>
<div class="paragraph"><p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable <span class="monospaced">FCALLS</span> (see
<span class="monospaced">beam_emu.c</span>).</p></div>
<div class="paragraph"><p>We can examine this value with <span class="monospaced">hipe_bifs:show_pcb/1</span>:</p></div>
iex(13)> :hipe_bifs.show_pcb self
P: 0x00007efd7c2c0400
-----------------------------------------------------------------
Offset| Name          |              Value |             *Value |
    0 | id            | 0x00000270000004e3 |                    |
...
  328 | rcount        | 0x0000000000000000 |                    |
  336 | reds          | 0x000000000000a528 |                    |
...
  320 | fcalls        | 0x00000000000004a3 |                    |
<div class="paragraph"><p>The field <span class="monospaced">reds</span> keep track of the total number of reductions a
process has done up until it was last suspended. By monitoring this
number you can see which processes do the most work.</p></div>
<div class="paragraph"><p>You can see the total number of reductions for a process (the reds
field) by calling <span class="monospaced">erlang:process_info/2</span> with the atom <span class="monospaced">reductions</span>
as the second argument. You can also see this number in the process
tab in the observer or with the i/0 command in the Erlang shell.</p></div>
<div class="paragraph"><p>As noted earlier, each time a process starts the field fcalls is set to
the value of <span class="monospaced">CONTEXT_REDS</span> and for each function call the
process executes fcalls is reduced by 1. When the process is
suspended the field reds is increased by the number of executed
reductions. In some C like code something like:
 <span class="monospaced">p-&gt;reds += (CONTEXT_REDS - p-&gt;fcalls)</span>.</p></div>
<div class="paragraph"><p>Normally a process would do all its alloted reductions and <span class="monospaced">fcalls</span>
would be 0 at this point, but if the process suspends in a receive
waiting for a message it will have some reductions left.</p></div>
<div class="paragraph"><p>When a process uses up all its reductions it will yield to
let another process run, it will go from the process state
<em>running</em> to the state <em>runnable</em>, if it yields in a receive
it will instead go into the state <em>waiting</em> (for a message).
In the next section we will take a look at all the different
states a process can be in.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_process_state_or_em_status_em">The Process State (or <em>status</em>)</h3>
<div class="paragraph"><p>The field <span class="monospaced">status</span> in the PCB contains the process state. It can be one
of <em>free</em>, <em>runnable</em>, <em>waiting</em>, <em>running</em>, <em>exiting</em>, <em>garbing</em>,
and <em>suspended</em>. When a process exits it is marked as
free---you should never be able to see a process in this state,
it is a short lived state where the process no longer exist as
far as the rest of the system is concerned but there is still
some clean up to be done (freeing memory and other resources).</p></div>
<div class="paragraph"><p>Each process status represents a state in the Process State
Machine. Events such as a timeout or a delivered
message triggers transitions along the edges in the state machine.
The <em>Process State Machine</em> looks like this:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__18.png" alt="book__18.png">
</div>
</div>
<div class="paragraph"><p>The normal states for a process are <em>runnable</em>, <em>waiting</em>, and <em>running</em>.
A running process is currently executing code in one of the schedulers.
When a process enters a receive and there is no matching message in
the message queue, the process will become waiting until a message
arrives or a timeout occurs. If a process uses up all its reductions,
it will become runnable and wait for a scheduler to pick it up again.
A waiting process receiving a message or a timeout will become
runnable.</p></div>
<div class="paragraph"><p>Whenever a process needs to do garbage collection, it will go into
the <em>garbing</em>
state until the GC is done. While it is doing GC
is saves the old state in the field <span class="monospaced">gcstatus</span> and when it is done
it sets the state back to the old state using <span class="monospaced">gcstatus</span>.</p></div>
<div class="paragraph"><p>The suspended state is only supposed to be used for debugging
purposes. You can call <span class="monospaced">erlang:suspend_process/2</span> on another process
to force it into the suspended state. Each time a process calls
<span class="monospaced">suspend_process</span> on another process, the <em>suspend count</em> is increased.
This is recorded in the field <span class="monospaced">rcount</span>.
A call to (<span class="monospaced">erlang:resume_process/1</span>) by the suspending process will
decrease the suspend count. A process in the suspend state will not
leave the suspend state until the suspend count reaches zero.</p></div>
<div class="paragraph"><p>The field <span class="monospaced">rstatus</span> (resume status) is used to keep track of the
state the process was in before a suspend. If it was <em>running</em>
or <em>runnable</em> it will start up as <em>runnable</em>, and if it was <em>waiting</em>
it will go back to the wait queue. If a suspended waiting process
receives a timeout <span class="monospaced">rstatus</span> is set to <em>runnable</em> so it will resume
as <em>runnable</em>.</p></div>
<div class="paragraph"><p>To keep track of which process to run next the scheduler keeps
the processes in a queue.</p></div>
</div>
<div class="sect2">
<h3 id="_process_queues">Process Queues</h3>
<div class="paragraph"><p>The main job of the scheduler is to keep track of work queues,
that is, queues of processes and ports.</p></div>
<div class="paragraph"><p>There are two process states that the scheduler has to handle,
<em>runable</em>, and <em>waiting</em>.
Processes waiting to receive a message are in
the waiting state. When a waiting process receives a message the send
operations triggers a move of the receiving process into the runable
state. If the receive statement have a timeout the scheduler has to
trigger the state transition to runable when the timeout triggers.
We will cover this mechanism later in this chapter.</p></div>
<div class="sect3">
<h4 id="_the_ready_queue">The Ready Queue</h4>
<div class="paragraph"><p>Processes in the runable state are placed in a FIFO (first in first
out) queue handled by the scheduler, called the <em>ready queue</em>. The
queue is implemented by a first and a last pointer and by the next
pointer in the PCB of each participating process.
When a new process is added to the queue the
<em>last</em> pointer is followed and the process is added to the end of the
queue in an O(1) operation. When a new process is scheduled it is
just popped from the head (the <em>first</em> pointer) of the queue.</p></div>
<div class="listingblock" id="the_ready_queue">
<div class="content monospaced">
<pre> The Ready Queue

 First: --&gt;  P5       +---&gt; P3       +-+-&gt; P17
             next: ---+     next: ---+ |  next: NULL
                                       |
 Last: --------------------------------+</pre>
</div></div>
<div class="paragraph"><p>In a SMP system, where you have several scheduler threads,
there is one queue per scheduler.</p></div>
<div class="listingblock" id="the_smp_ready_queues">
<div class="content monospaced">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Ready: P5         Ready: P1        Ready: P7        Ready: P9
        P3                P4               P12
        P17                                P10</pre>
</div></div>
<div class="paragraph"><p>The reality is slightly more complicated since Erlang processes have
priorities. Each scheduler actually have three queues. One queue for
<em>max priority</em> tasks, one for <em>high priority</em> tasks and one queue
containing both <em>normal</em> and <em>low priority</em> tasks.</p></div>
<div class="listingblock" id="priority_ready_queues">
<div class="content monospaced">
<pre> Scheduler 1       Scheduler 2      Scheduler 3      Scheduler 4

 Max:    P5        Max:             Max:             Max:
 High:             High:  P1        High:            High:
 Normal: P3        Ready: P4        Ready: P7        Ready: P9
         P17                               P12
                                           P10</pre>
</div></div>
<div class="paragraph"><p>If there are any processes int the max queue the scheduler will
pick these processes for execution. If there are no processes
in the max queue but there are processes in the high priority
queue the scheduler will pick those processes. Only if there
are no processes in the max and the high priority queues will
the scheduler pick the first process from the normal and low
queue.</p></div>
<div class="paragraph"><p>When a normal processes is inserted into the queue it get a <em>schedule
count</em> of 1 and a low prio process get a schedule count of 8.
When a process is picked from the front of the
queue its schedule count is reduced by one, if the count reaches zero
the process is scheduled, otherwise it is inserted at the end of the
queue. This means that low priority processes will go through the
queue seven times before they are scheduled.</p></div>
</div>
<div class="sect3">
<h4 id="_waiting_timeouts_and_the_timing_wheel">Waiting, Timeouts and the Timing Wheel</h4>
<div class="paragraph"><p>A processs trying to do a receive on an empty mailbox or on
a mailbox with no matching messages will yield and go into the
waiting state.</p></div>
<div class="paragraph"><p>When a message is deliverd to an inbox the sending process will check
whether the receiver is <em>sleeping</em> in the waiting state, and in that
case it will <em>wake</em> the process, change its state to runable, and put
it at the end of the appropriate ready queue.</p></div>
<div class="paragraph"><p>If the receive statement has a <span class="monospaced">timeout</span> clause a timer will be
created for the process which will trigger after the specified timeout
time. The only guarantee the runtime system gives on a timeout is that
it will not trigger before the set time, it might be some time after
the intended time before the process is scheduled and get to execute.</p></div>
<div class="paragraph"><p>Timers are handled in the VM by a <em>timing wheel</em>. That is, an array of
time slots which wraps around. The timing
wheel is a global resource and there might be contention for the write
lock to the timing wheel if you have many processes inserting timers
into the wheel.</p></div>
<div class="paragraph"><p>The default size (<span class="monospaced">TIW_SIZE</span>) of the timing wheel is 65536 slots (or
8192 slots if you have built the system for a small memory
footprint). The current time is indicated by an index into the array
(<span class="monospaced">tiw_pos</span>). When a timer is inserted into the wheel with a timeout of
T the timer is inserted into the slot at <span class="monospaced">(tiw_pos+T)%TIW_SIZE</span>.</p></div>
<div class="listingblock" id="the_timing_wheel">
<div class="content monospaced">
<pre>   0 1                                      65535
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
  | | |      | | | | | | |t| | | | |     | |     |
  +-+-+- ... +-+-+-+-+-+-+-+-+-+-+-+ ... +-+-----+
              ^           ^                       ^
              |           |                       |
           tiw_pos     tiw_pos+T               TIW_SIZE</pre>
</div></div>
<div class="paragraph"><p>The timer stored in the timing wheel is a pointer to an <span class="monospaced">ErlTimer</span>
struct. See [erl_time.h](<a href="https://github.com/erlang/otp/blob/OTP-19.1/erts/emulator/beam/erl_time.h">https://github.com/erlang/otp/blob/OTP-19.1/erts/emulator/beam/erl_time.h</a>). If several timers are
inserted into the same slot they are linked together in a linked list
by the <span class="monospaced">prev</span> and <span class="monospaced">next</span> fields. The <span class="monospaced">count</span> field is set to
<span class="monospaced">T/TIW_SIZE</span></p></div>
<div class="listingblock">
<a id="ErlTimer"></a>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>

<span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">** Timer entry:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">*/</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">erl_timer</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">erl_timer</span><span style="color: #990000">*</span> next<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* next entry tiw slot or chain */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">erl_timer</span><span style="color: #990000">*</span> prev<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* prev entry tiw slot or chain */</span></span>
    <span style="color: #008080">Uint</span> slot<span style="color: #990000">;</span>                  <span style="font-style: italic"><span style="color: #9A1900">/* slot in timer wheel */</span></span>
    <span style="color: #008080">Uint</span> count<span style="color: #990000">;</span>                 <span style="font-style: italic"><span style="color: #9A1900">/* number of loops remaining */</span></span>
    <span style="color: #009900">int</span>    active<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* 1=activated, 0=deactivated */</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">/* called when timeout */</span></span>
    <span style="color: #009900">void</span> <span style="color: #990000">(*</span>timeout<span style="color: #990000">)(</span><span style="color: #009900">void</span><span style="color: #990000">*);</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* called when cancel (may be NULL) */</span></span>
    <span style="color: #009900">void</span> <span style="color: #990000">(*</span>cancel<span style="color: #990000">)(</span><span style="color: #009900">void</span><span style="color: #990000">*);</span>
    <span style="color: #009900">void</span><span style="color: #990000">*</span> arg<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* argument to timeout/cancel procs */</span></span>
<span style="color: #FF0000">}</span> ErlTimer<span style="color: #990000">;</span>
</tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_ports">Ports</h3>
<div class="paragraph"><p>A port is an Erlang abstraction for a communication point with the
world outside of the Erlang VM. Communications with sockets, pipes,
and file IO are all done through ports on the Erlang side.</p></div>
<div class="paragraph"><p>A port, like a process, is created on the same scheduler as the
creating process. Also like processes port uses reductions to decide
when to yield, and they also get to run for 2000 reductions. But
since ports don&#8217;t run Erlang code there are no Erlang function calls
to count as reductions, instead each <em>port task</em> is counted as a
number of reductions. Currently a task uses a little more than 200
reductions per task, and a number of reductions relative to one
thousands of the size of transmitted data.</p></div>
<div class="paragraph"><p>A port task is one operation on a port, like opening, closing, sending
a number of bytes or receiving data. In order to execute a port task
the executing thread takes a lock on the port.</p></div>
<div class="paragraph"><p>Port tasks are scheduled and executed in each iteration in the
scheduler loop (see below) before a new process is selected for
execution.</p></div>
</div>
<div class="sect2">
<h3 id="_reductions_2">Reductions</h3>
<div class="paragraph"><p>When a process is scheduled it will get a number of reductions defined
by CONTEXT_REDS (defined in erl_vm.h, currently as 2000). After using
up its reductions or when doing a receive without a matching message
in the inbox, the process will be suspended and a new processes will
be scheduled.</p></div>
<div class="paragraph"><p>If the VM has executed as many reductions as defined by
INPUT_REDUCTIONS (currently 2*CONTEXT_REDS, also defined in
<span class="monospaced">erl_vm.h</span>) or if there is no process ready to run the scheduler will
do system-level activities. That is, basically, check for IO; we will
cover the details soon.</p></div>
<div class="paragraph"><p>It is not completely defined what a reduction is, but at least each
function call should be counted as a reduction. Things get a bit more
complicated when talking about BIFs and NIFs. A process should not be
able to run for "a long time" without using a reduction and yielding.
A function written in C can usually not yield at any time, and the
reason for writing it in C is usually to achieve performance. In such
functions a reduction might take longer which can lead to imbalance in
the scheduler.</p></div>
<div class="paragraph"><p>For example in Erlang versions prior to R16 the BIFs
<span class="monospaced">binary_to_term/1</span> and <span class="monospaced">term_to_binary/1</span> where non yielding and only
counted as one reduction. This meant that a process calling theses
functions on large terms could starve other processes. This can even
happen in a smp system because of the way processes are balanced
between schedulers, which we will get to soon.</p></div>
<div class="paragraph"><p>While a process is running the emulator keeps the number of reductions
left to execute in the (register mapped) variable FCALLS (see
<span class="monospaced">beam_emu.c</span>).</p></div>
</div>
<div class="sect2">
<h3 id="_the_scheduler_loop">The Scheduler Loop</h3>
<div class="paragraph"><p>Conceptually you can look at the scheduler as the driver of program
execution in the Erlang VM. In reality, that is, the way the C code
is structured, it is the emulator (<span class="monospaced">process_main</span> in beam_emu.c) that
drives the execution and it calls the scheduler as a subroutine to find
the next process to execute.</p></div>
<div class="paragraph"><p>Still, we will pretend that it is the other way around, since it makes
a nice conceptual model for the scheduler loop. That is, we see it
as the scheduler picking a process to execute and then handing over
the execution to the emulator.</p></div>
<div class="paragraph"><p>Looking at it that way, the scheduler loop looks like this:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Update reduction counters.
</p>
</li>
<li>
<p>
Check timers
</p>
</li>
<li>
<p>
If needed check balance
</p>
</li>
<li>
<p>
If needed migrate processes and ports
</p>
</li>
<li>
<p>
Do auxiliary scheduler work
</p>
</li>
<li>
<p>
If needed check IO and update time
</p>
</li>
<li>
<p>
While needed pick a port task to execute
</p>
</li>
<li>
<p>
Pick a process to execute
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_load_balancing">Load Balancing</h3>
<div class="paragraph"><p>The current strategy of the load balancer is to use as few schedulers
as possible without overloading any CPU. The idea is that you will get
better performance through better memory locality when processes share
the same CPU.</p></div>
<div class="paragraph"><p>One thing to note though is that the load balancing done in the
scheduler is between scheduler threads and not necessarily between
CPUs or cores. When you start the runtime system you can specify how
schedulers should be allocated to cores. The default behaviour is that
it is up to the OS to allocated scheduler threads to cores, but you
can also choose to bind schedulers to cores.</p></div>
<div class="paragraph"><p>The load balancer assumes that there is one schedulers running on each
core so that moving a process from a overloaded scheduler to an under
utilized scheduler will give you more parallel processing power. If
you have changed how schedulers are allocated to cores, or if you OS
is overloaded or bad at assigning threads to cores, the load balancing
might actually work against you.</p></div>
<div class="paragraph"><p>The load balancer uses two techniques to balance the load, <em>task
stealing</em> and <em>migration</em>. Task stealing is used every time a
scheduler runs out of work, this technique will result in the work
becoming more spread out between schedulers. Migration is more
complicated and tries to compact the load to the right number of
schedulers.</p></div>
<div class="sect3">
<h4 id="_task_stealing">Task Stealing</h4>
<div class="paragraph"><p>If a scheduler run queue is empty when it should pick a new process
to schedule the scheduler will try to steal work from another
scheduler.</p></div>
<div class="paragraph"><p>First the scheduler takes a lock on itself to prevent other schedulers
to try to steal work from the current scheduler. Then it checks if
there are any inactive schedulers that it can steal a task from. If
there are no inactive schedulers with stealable tasks then it will
look at active schedulers, starting with schedulers having a higher id
than itself, trying to find a stealable task.</p></div>
<div class="paragraph"><p>The task stealing will look at one scheduler at a time and try to
steal the highest priority task of that scheduler. Since this is done
per scheduler there might actually be higher priority tasks that are
stealable on another scheduler which will not be taken.</p></div>
<div class="paragraph"><p>The task stealing tries to move tasks towards schedulers with lower
numbers by trying to steal from schedulers with higher numbers,
but since the stealing also will wrap around and steal from schedulers
with lower numbers the result is that processes are spread out on all
active schedulers.</p></div>
<div class="paragraph"><p>Task stealing is quite fast and can be done on every iteration of
the scheduler loop when a scheduler has run out of tasks.</p></div>
</div>
<div class="sect3">
<h4 id="_migration">Migration</h4>
<div class="paragraph"><p>To really utilize the schedulers optimally a more elaborate migration
strategy is used. The current strategy is to compact the load to as
few schedulers as possible, while at the same time spread it out so
that no scheduler is overloaded.</p></div>
<div class="paragraph"><p>This is done by the function <em>check_balance</em> in <em>erl_process.c</em>.</p></div>
<div class="paragraph"><p>The migration is done by first setting up a migration plan and then
letting schedulers execute on that plan until a new plan is set up.
Every 2000*2000 reductions a scheduler calculates a migration path per
priority per scheduler by looking at the workload of all
schedulers. The migration path can have three different types of
values: 1) cleared 2) migrate to scheduler # 3) immigrate from
scheduler #</p></div>
<div class="paragraph"><p>When a process becomes ready (for example by receiving a message or
triggering a timeout) it will normally be scheduled on the last
scheduler it ran on (S1). That is, if the migration path of that
scheduler (S1), at that priority, is cleared. If the migration path of
the scheduler is set to emigrate (to S2) the process will be handed over
to that scheduler if both S1 and S2 have unbalanced run-queues. We will
get back to what that means.</p></div>
<div class="paragraph"><p>When a scheduler (S1) is to pick a new process to execute it checks to
see if it has an immigration path from (S2) set. If the two involved
schedulers have unbalanced run-queues S1 will steal a process from S2.</p></div>
<div class="paragraph"><p>The migration path is calculated by comparing the maximum run-queues
for each scheduler for a certain priority. Each scheduler will update
a counter in each iteration of its scheduler loop keeping track of
the maximal queue length. This information is then used to calculate
an average (max) queue length (<em>AMQL</em>).</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> Max
 Run Q
 Length
    5         o
              o
           o  o
Avg: 2.5 --------------
           o  o     o
    1      o  o     o

scheduler S1 S2 S3 S4</pre>
</div></div>
<div class="paragraph"><p>Then the schedulers are sorted on their max queue lengths.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> Max
 Run Q
 Length
    5               o
                    o
                 o  o
Avg: 2.5 --------------
              o  o  o
    1         o  o  o

scheduler S3 S4 S1 S2

           ^        ^
           |        |
          tix      fix</pre>
</div></div>
<div class="paragraph"><p>Any scheduler with a longer run queue than average (S1, S2) will be
marked for emigration and any scheduler with a shorter max run queue
than average (S3, S4) will be targeted for immigration.</p></div>
<div class="paragraph"><p>This is done by looping over the ordered set of schedulers with two
indices (immigrate from (<span class="monospaced">fix</span>)) and (emigrate to (<span class="monospaced">tix</span>)). In each
iteration of the a loop the immigration path of S[tix] is set to S[fix]
and the emigration path of S[fix] is set to S[tix]. Then tix is increased
and fix decreased till they both pass the balance point. If one index
reaches the balance point first it wraps.</p></div>
<div class="paragraph"><p>In the example:
 * Iteration 1: S2.emigrate_to = S3 and S3.immigrate_from = S2
 * Iteration 2: S1.emigrate_to = S4 and S4.immigrate_from = S1</p></div>
<div class="paragraph"><p>Then we are done.</p></div>
<div class="paragraph"><p>In reality things are a bit more complicated since schedulers can be
taken off line. The migration planning is only done for online
schedulers. Also, as mentioned before, this is done per priority
level.</p></div>
<div class="paragraph"><p>When a process is to be inserted into a ready queue and there is a
migration path set from S1 to S2 the scheduler first checks that the
run queue of S1 is larger than AMQL and that the run queue of S2 is
smaller than the average. This way the migration is only allowed if
both queues are still unbalanced.</p></div>
<div class="paragraph"><p>There are two exception though where a migration is forced even
when the queues are balanced or even imbalanced in the wrong way.
In both these cases a special evacuation flag is set which overrides
the balance test.</p></div>
<div class="paragraph"><p>The evacuation flag is set when a scheduler is taken off line to
ensure that no new processes are scheduled on an off line scheduler.
The flag is also set when the scheduler detects that no progress is
made on some priority. That is, if there for example is a max priority
process which always is ready to run so that no normal priority processes
ever are scheduled. Then the evacuation flag will be set for the normal
priority queue for that scheduler.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CH-Memory">The Memory Subsystem: Stacks, Heaps and Garbage Collection</h2>
<div class="sectionbody">
<div class="paragraph"><p>Before we dive into the memory subsystem of ERTS, we need to have some
basic vocabulary and understanding of the general memory layout of a
program in a modern operating system. In this review section I will
assume the program is compiled to an ELF executable and running on
Linux on something like an IA-32/AMD64 architecture. The layout and
terminology is basically the same for all operating systems that ERTS
compile on.</p></div>
<div class="paragraph"><p>A program&#8217;s memory layout looks something like this:</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__19.png" alt="book__19.png">
</div>
</div>
<div class="paragraph"><p>Even though this picture might look daunting it is still a
simplification. (For a full understanding of the memory subsystem read
a book like "Understanding the Linux Kernel" or "Linux System
Programming") What I want you to take away from this is that there are
two types of dynamically allocatable memory: the heap and memory
mapped segments. I will try to call this heap the <em>C-heap</em> from now
on, to distinguish it from an Erlang process heap. I will call a
memory mapped segment for just a <em>segment</em>, and any of the stacks in
this picture for the <em>C-stack</em>.</p></div>
<div class="paragraph"><p>The C-heap is allocated through malloc and a segment is allocated with
mmap.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
A note on pictures of memory
</p>
</li>
</ol></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p><strong>Note</strong> When drawing overview pictures of system memory and stacks we
will follow the convention that memory addresses grows upward. That is
low memory addresses on the bottom of the page and high memory
addresses on the top of the page. (Stacks most often grow downward
starting at high addresses, so that new elements are pushed at the
lowest address.)</p></div>
<div class="paragraph"><p>However when we draw a c-structure we will draw the fields from the
top and down, even though the first field of the structure will be
at the lowest address and the following fields at higher addresses.
So pictures of structures have low address at the top of the page
and high address at the bottom of the page.</p></div>
<div class="paragraph"><p>This means that a picture of a c-structure and a picture of a memory
area will have their address positions on the page mirrored. This becomes
somewhat confusing when we try to pictures structures and heaps in the
same picture.</p></div>
</div></div>
<div class="sect2">
<h3 id="_the_memory_subsystem">The memory subsystem</h3>
<div class="paragraph"><p>Now that we dive into the memory subsystem it will once again
be apparent that ERTS is more like an operating system than just a
programming language environment. Not only does ERTS provide a garbage
collector for Erlang terms on the Erlang process level, but it also
provides a plethora of low level memory allocators and memory
allocation strategies.</p></div>
<div class="paragraph"><p>For an overview of memory allocators see the erts_alloc documentation
at: <a href="http://www.erlang.org/doc/man/erts_alloc.html">http://www.erlang.org/doc/man/erts_alloc.html</a></p></div>
<div class="paragraph"><p>All these allocators also comes with a number of parameters that
can be used to tweak their behavior, and this is probably one
of the most important areas from an operational point of view.
This is where we can configure the system behavior to fit anything
from a small embedded control system (like a Raspberry Pi) to an
Internet scale 2TB database server.</p></div>
<div class="paragraph"><p>There are currently eleven different allocators, six different
allocation strategies, and more than 18 other different settings,
some of which are taking arbitrary numerical values. This
means that there basically is an infinite number of possible
configurations. (OK, strictly speaking it is not infinite, since
each number is bounded, but there are more configurations
than you can shake a stick at.)</p></div>
<div class="paragraph"><p>In order to be able to use these settings in any meaningful way
we will have to understand how these allocators work and
how each setting impacts the performance of the allocator.</p></div>
<div class="paragraph"><p>The erts_alloc manual goes as far as to give the following warning:</p></div>
<div class="quoteblock">
<div class="title">Warning</div>
<div class="content">
<div class="paragraph"><p><strong>Warning</strong></p></div>
<div class="paragraph"><p>Only use these flags if you are absolutely sure what you are
doing. Unsuitable settings may cause serious performance degradation
and even a system crash at any time during operation.</p></div>
</div>
<div class="attribution">
<em>http://www.erlang.org/doc/man/erts_alloc.html</em><br>
&#8212; Ericsson AB
</div></div>
<div class="paragraph"><p>Making you absolutely sure that you know what you are doing, that is
what this chapter is about.</p></div>
<div class="paragraph"><p>Oh yes, we will also go into details of how the garbage collector
works.</p></div>
</div>
<div class="sect2">
<h3 id="SS-Memory_Allocators">Different type of memory allocators</h3>
<div class="paragraph"><p>The Erlang run-time system is trying its best to handle memory
in all situations and under all types of loads, but there are
always corner cases. In this chapter we will look at the details
of how memory is allocated and how the different allocators work.
With this knoweledge and some tools that we will look at later
you should be able to detect and fix problems if your system
ends up in one of these corner cases.</p></div>
<div class="paragraph"><p>For a nice story about the troubles the system might get into
and how to analyze and correct the behavior read
Fred H&eacute;bert&#8217;s essay <a href="https://blog.heroku.com/archives/2013/11/7/logplex-down-the-rabbit-hole">"Troubleshooting Down the Logplex Rabbit Hole"</a>.</p></div>
<div class="paragraph"><p>When we are talking about a memory allocator in this book we
have a specific meaning in mind. Each memory allocator manage
allocations and deallocations of memory of a certain type.
Each allocator is intended for a specific type of data and is
often specialized for one size of data.</p></div>
<div class="paragraph"><p>Each memory allocator implements the allocator interface but
can used different algorithms and settings for the actual
memory allocation.</p></div>
<div class="paragraph"><p>The goal with having different allocators is to reduce
fragmentation, by grouping allocations of the same size,
and to increase performance, by making frequent allocations
cheap.</p></div>
<div class="paragraph"><p>There are two special, fundamental or generic, memory allocator types
<em>sys_alloc</em> and <em>mseg_alloc</em>, and nine specific allocators implemented
through the <em>alloc_util</em> framework.</p></div>
<div class="paragraph"><p>In the following sections we will go though the different allocators,
with a little detour into the general framework for allocators
(alloc_util).</p></div>
<div class="paragraph"><p>Each allocator has several names used in the documentation and in the
C code. See <a href="#table-allocators">[table-allocators]</a> for a short list of all allocators
and their names. The C-name is used in the C-code to refer to the
allocator. The Type-name is used in erl_alloc.types to bind allocation
types to an allocator. The Flag is the letter used for setting
parameters of that allocator when starting Erlang.</p></div>
<table class="tableblock frame-all grid-all" id="table-allocators"
style="
width:100%;
">
<caption class="title">Table 1. List of memory allocators.</caption>
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Name                    </th>
<th class="tableblock halign-left valign-top" > Description           </th>
<th class="tableblock halign-left valign-top" > C-name     </th>
<th class="tableblock halign-left valign-top" > Type-name </th>
<th class="tableblock halign-left valign-top" > Flag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Basic allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">malloc interface</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sys_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SYSTEM</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Y</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Memory segment allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mmap interface</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mseg_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">M</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Temporary allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Temporary allocations</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">temp_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">TEMPORARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">T</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Heap allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Erlang heap data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">eheap_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">EHEAP</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">H</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Binary allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Binary data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">binary_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ETS allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ETS data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ets_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ETS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Driver allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Driver data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">driver_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DRIVER</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">R</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Short lived allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Short lived memory</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">sl_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SHORT_LIVED</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">S</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Long lived allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Long lived memory</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ll_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LONG_LIVED</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">L</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Fixed allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Fixed size data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fix_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">FIXED_SIZE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Standard allocator</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">For most other data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">std_alloc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">STANDARD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_the_basic_allocator_sys_alloc">The basic allocator: sys_alloc</h4>
<div class="paragraph"><p>The allocator sys_alloc can not be disabled, and is basically a
straight mapping to the underlying OS malloc implementation in
libc.</p></div>
<div class="paragraph"><p>If a specific allocator is disabled then sys_alloc is used instead.</p></div>
<div class="paragraph"><p>All specific allocators uses either sys_alloc or mseg_alloc to
allocate memory from the operating system as needed.</p></div>
<div class="paragraph"><p>When memory is allocated from the OS sys_alloc can add (pad) a fixed
number of kilobytes to the requested number. This can reduce the
number system calls by over allocating memory. The default padding
is zero.</p></div>
<div class="paragraph"><p>When memory is freed, sys_alloc will keep some free memory allocated
in the process. The size of this free memory is called the trim
threshold, and the default is 128 kilobytes. This also reduces the
number of system calls at the cost of a higher memory footprint.
This means that if you are running the system with the default
settings you can experience that the Beam process does not give
memory back to the OS directly as memory is freed up.</p></div>
<div class="paragraph"><p>Memory areas allocated by sys_alloc are stored in the C-heap of the
beam process which will grow as needed through system calls to brk.</p></div>
</div>
<div class="sect3">
<h4 id="_the_memory_segment_allocator_mseg_alloc">The memory segment allocator: mseg_alloc</h4>
<div class="paragraph"><p>If the underlying operating system supports mmap a specific memory
allocator can use mseg_alloc instead of sys_alloc to allocate
memory from the operating system.</p></div>
<div class="paragraph"><p>Memory areas allocated through mseg_alloc are called segments. When a
segment is freed it is not immediately returned to the OS, instead it
is kept in a segment cache.</p></div>
<div class="paragraph"><p>When a new segment is allocated a cached segment is reused if
possible, i.e. if it is the same size or larger than the requested
size but not too large. The value of <em>absolute max cache bad fit</em>
determines the number of kilobytes of extra size which is considered
not too large. The default is 4096 kilobytes.</p></div>
<div class="paragraph"><p>In order not to reuse a 4096 kilobyte segment for really small
allocations there is also a <em>relative_max_cache_bad_fit</em> value which
states that a cached segment may not be used if it is more than
that many percent larger. The default value is 20 percent. That
is a 12 KB segment may be used when asked for a 10 KB segment.</p></div>
<div class="paragraph"><p>The number of entries in the cache defaults to 10 but can be
set to any value from zero to thirty.</p></div>
</div>
<div class="sect3">
<h4 id="_the_memory_allocator_framework_alloc_util">The memory allocator framework: alloc_util</h4>
<div class="paragraph"><p>Building on top of the two generic allocators (sys_alloc and mseg_alloc)
is a framework called <em>alloc_util</em> which is used to implement specific
memory allocators for different types of usage and data.</p></div>
<div class="paragraph"><p>The framework is implemented in <em>erl_alloc_util.[ch]</em> and the different
allocators used by ERTS are defined in erl_alloc.types in
the directory "erts/emulator/beam/".</p></div>
<div class="paragraph"><p>In a smp system there is usually one allocator of each type per
scheduler thread.</p></div>
<div class="paragraph"><p>The smallest unit of memory that an allocator work with is called a
<em>block</em>. When you call an allocator to allocate a certain amount of
memory what you get back is a block. It is also blocks that you give
as an argument to the allocator when you want to deallocate memory.</p></div>
<div class="paragraph"><p>The allocator does not allocate blocks from the operating system
directly though. Instead the allocator allocates a <em>carrier</em> from the
operating system, either through sys_alloc or through mseg_alloc,
which in turn uses malloc or mmap. If sys_alloc is used the carrier
is placed on the C-heap and if mseg_alloc is used the carrier
is placed in a segment.</p></div>
<div class="paragraph"><p>Small blocks are placed in a multiblock carrier. A multiblock carrier
can as the name suggests contain many blocks. Larger blocks are placed
in a singleblock carrier, which as the name implies on contains one
block.</p></div>
<div class="paragraph"><p>What&#8217;s considered a small and a large block is determined by the
parameter <em>singleblock carrier threshold</em> (<span class="monospaced">sbct</span>), see the list
of system flags below.</p></div>
<div class="paragraph"><p>Most allocators also have one "main multiblock carrier" which is never
deallocated.</p></div>
<div class="imageblock shaape">
<div class="content">
<img src="book__20.png" alt="book__20.png">
</div>
</div>
<div class="sect4">
<h5 id="_memory_allocation_strategies">Memory allocation strategies</h5>
<!--
Are you intending for readers to take advantage of these allocation strategies in their code? If so, this section needs to be much more prominent, and not a subheading in a reference section.  - bmacdonald
-->
<div class="paragraph"><p>To find a free block of memory in a multi block carrier an
allocation strategy is used. Each type of allocator has
a default allocation strategy, but you can also set the
allocation strategy with the <span class="monospaced">as</span> flag.</p></div>
<div class="paragraph"><p>The Erlang Run-Time System Application Reference Manual lists
the following allocation strategies:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p><em>Best fit</em>: Find the smallest block that satisfies the requested block size.
(bf)</p></div>
<div class="paragraph"><p><em>Address order best fit</em>: Find the smallest block that satisfies the
requested block size. If multiple blocks are found, choose the one
with the lowest address.
(aobf)</p></div>
<div class="paragraph"><p><em>Address order first fit</em>: Find the block with the lowest address that
satisfies the requested block size.
(aoff)</p></div>
<div class="paragraph"><p><em>Address order first fit carrier best fit</em>
Find the carrier with the lowest address that can satisfy the
requested block size, then find a block within that carrier using the
"best fit" strategy.  (aoffcbf)</p></div>
<div class="paragraph"><p><em>Address order first fit carrier address order best fit</em>: Find the
carrier with the lowest address that can satisfy the requested block
size, then find a block within that carrier using the "address order
best fit" strategy.
 aoffcaobf (address order first fit carrier address order best fit)</p></div>
<div class="paragraph"><p><em>Good fit</em>: Try to find the best fit, but settle for the best fit found
during a limited search.
(gf)</p></div>
<div class="paragraph"><p><em>A fit</em>: Do not search for a fit, inspect only one free block to see if
it satisfies the request. This strategy is only intended to be used
for temporary allocations.
(af)</p></div>
</div>
<div class="attribution">
&#8212; <a href="http://www.erlang.org/doc/man/erts_alloc.html">erts_alloc</a>
</div></div>
</div>
</div>
<div class="sect3">
<h4 id="_the_temporary_allocator_temp_alloc">The temporary allocator: temp_alloc</h4>
<div class="paragraph"><p>The allocator <em>temp_alloc</em>, is used for temporary
allocations. That is very short lived allocations. Memory allocated
by temp_alloc may not be allocated over a Erlang process context
switch.</p></div>
<div class="paragraph"><p>You can use temp_alloc as a small scratch or working area while doing
some work within a function. Look at it as an extension of the C-stack
and free it in the same way. That is, to be on the safe side, free
memory allocated by temp_alloc before returning from the function that
did the allocation. There is a note in erl_alloc.types saying that
you should free a temp_alloc block before the emulator starts
executing Erlang code.</p></div>
<div class="paragraph"><p>Note that no Erlang process running on the same scheduler as the
allocator may start executing Erlang code before the block is freed.
This means that you can not use a temporary allocation over a BIF
or NIF trap (yield).</p></div>
<div class="paragraph"><p>In a default R16 smp system there is N+1 temp_alloc allocators where N
is the number of schedulers. The temp_alloc uses the "A fit" (<span class="monospaced">af</span>)
strategy. Since the allocation pattern of the temp_alloc basically is
that of a stack (mostly of size 0 or 1), this strategy works fine.</p></div>
<div class="paragraph"><p>The temporary allocator is, in R16, used by the following types of
data: TMP_HEAP, MSG_ROOTS, ROOTSET, LOADER_TEMP, NC_TMP, TMP,
DCTRL_BUF, TMP_DIST_BUF, ESTACK, DB_TMP, DB_MC_STK, DB_MS_CMPL_HEAP,
LOGGER_DSBUF, TMP_DSBUF, DDLL_TMP_BUF, TEMP_TERM, SYS_READ_BUF,
ENVIRONMENT, CON_VPRINT_BUF.</p></div>
<div class="paragraph"><p>For an up to date list of allocation types allocated with each
allocator, see erl_alloc.types
(e.g. <span class="monospaced">grep TEMPORARY erts/emulator/beam/erl_alloc.types</span>).</p></div>
<div class="paragraph"><p>I will not go through each of these different types, but in
general as you can guess by their names, they are temporary
buffers or work stacks.</p></div>
</div>
<div class="sect3">
<h4 id="_the_heap_allocator_eheap_alloc">The heap allocator: eheap_alloc</h4>
<div class="paragraph"><p>The heap allocator, is used for allocating memory blocks
where tagged Erlang terms are stored, such as Erlang process heaps
(all generations), heap fragments, and the beam_registers.</p></div>
<div class="paragraph"><p>This is probably the memory areas you are most interested in as an
Erlang developer or when tuning an Erlang system. We will talk more
about how these areas are managed in the upcoming sections on garbage
collection and process memory. There we will also cover what a heap
fragment is.</p></div>
</div>
<div class="sect3">
<h4 id="_the_binary_allocator_binary_alloc">The binary allocator: binary_alloc</h4>
<div class="paragraph"><p>The binary allocator is used for, yes you guessed it, binaries.
Binaries can be of quite varying sizes and have varying life spans.
This allocator uses the <em>best fit</em> allocation strategy by default.</p></div>
</div>
<div class="sect3">
<h4 id="_the_ets_allocator_ets_alloc">The ETS allocator: ets_alloc</h4>
<div class="paragraph"><p>The ETS allocator is used for most ets related data,
except for some short lived or temporary data used by ets tables-</p></div>
</div>
<div class="sect3">
<h4 id="_the_driver_allocator_driver_alloc">The driver allocator: driver_alloc</h4>
<div class="paragraph"><p>The driver allocator is used for ports, linked in drivers and NIFs.</p></div>
</div>
<div class="sect3">
<h4 id="_the_short_lived_allocator_sl_alloc">The short lived allocator: sl_alloc</h4>
<div class="paragraph"><p>The short lived allocator is used for lists and buffers that are
expected to be short lived. Short lived data can live longer than
temporary data.</p></div>
</div>
<div class="sect3">
<h4 id="_the_long_lived_allocator_ll_alloc">The long lived allocator: ll_alloc</h4>
<div class="paragraph"><p>The long lived allocator is used for long lived data, such
as atoms, modules, funs and long lived tables</p></div>
</div>
<div class="sect3">
<h4 id="_the_fixed_size_allocator_fix_alloc">The fixed size allocator: fix_alloc</h4>
<div class="paragraph"><p>The fixed allocator is used for objects of a fixed size, such as PCBs,
message refs and a few other. The fixed size allocator uses the
<em>address order best fit</em> allocation strategy by default.</p></div>
</div>
<div class="sect3">
<h4 id="_the_standard_allocator_std_alloc">The standard allocator: std_alloc</h4>
<div class="paragraph"><p>The standard allocator is used by the other types of data.
(active_procs alloc_info_request arg_reg bif_timer_ll bits_buf bpd
calls_buf db_heir_data db_heir_data db_named_table_entry dcache
ddll_handle ddll_processes ddll_processes dist_entry dist_tab
driver_lock ethread_standard fd_entry_buf fun_tab gc_info_request
io_queue line_buf link_lh module_refs monitor_lh monitor_lh monitor_sh
nlink_lh nlink_lh nlink_sh node_entry node_tab nodes_monitor
port_data_heap port_lock port_report_exit port_specific_data proc_dict
process_specific_data ptimer_ll re_heap reg_proc reg_tab
sched_wall_time_request stack suspend_monitor thr_q_element thr_queue
zlib )</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_todo_system_flags_for_memory">TODO: system flags for memory</h3>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect2">
<h3 id="_process_memory">Process Memory</h3>
<div class="paragraph"><p>As we saw in <a href="#CH-Processes">[CH-Processes]</a> a process i really just a number
of memory areas, in this chapter we will look a bit closer at how
the stack, the heap and the mailbox are managed.</p></div>
<div class="paragraph"><p>The default size of the stack and heap is 233 words. This default
size can be changed globally when starting Erlang through the
+ <span class="monospaced">h + flag. You can also set the minimum heap size by when starting
a process with +spawn_opt</span> by setting <span class="monospaced">min_heap_size</span>.</p></div>
<div class="paragraph"><p>Erlang terms are tagged as we saw in <a href="#CH-TypeSystem">[CH-TypeSystem]</a>, and when
they are stored on the heap they are either cons cells or boxed
objects.</p></div>
<div class="sect3">
<h4 id="_term_sharing">Term sharing</h4>
<div class="paragraph"><p>Objects on the heap are passed by references within the context of one
process. If you call one function with a tuple as an argument, then
only a tagged reference to that tuple is passed to the called
function. When you build new terms you will also only use references
to sub terms.</p></div>
<div class="paragraph"><p>For example if you have the string "hello" (which is the same as this
list of integers: [104,101,108,108,111]) you would get a stack layout
similar to:</p></div>
<div class="listingblock" id="fig-list_layout">
<div class="content monospaced">
<pre>         ADR                               BINARY  VALUE  +  DESCRIPTION
 hend -&gt;     +-------- -------- -------- --------+
             |              ...                  |
             |              ...                  |
             |00000000 00000000 00000000 10000001| 128 + list tag  ---------------+
 stop -&gt;;     |                                   |                                |
                                                                                  |
 htop -&gt;;     |                                   |                                |
         132 |00000000 00000000 00000000 01111001| 120 + list tag  -------------- | -+
         128 |00000000 00000000 00000110 10001111| (H) 104 bsl 4 + small int tag &lt;+  |
         124 |00000000 00000000 00000000 01110001| 112 + list tag  ----------------- | -+
         120 |00000000 00000000 00000110 01011111| (e) 101 bsl 4 + small int tag &lt;---+  |
         116 |00000000 00000000 00000000 01110001| 112 + list tag  -------------------- | -+
         112 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;------+  |
         108 |00000000 00000000 00000000 01110001|  96 + list tag  ----------------------- | -+
         104 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;---------+  |
         100 |11111111 11111111 11111111 11111011| NIL                                        |
          96 |00000000 00000000 00000110 11111111| (o) 111 bsl 4 + small int tag &lt;------------+
             |                ...                |
 heap -&gt;     +-----------------------------------+</pre>
</div></div>
<div class="paragraph"><p>If you then create a tuple with two instances of the list, all that is repeated is
the tagged pointer to the list: 00000000000000000000000001000001. The code</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>L = [104, 101, 108, 108, 111],
T = {L, L}.</pre>
</div></div>
<div class="paragraph"><p>would result in a memory layout as seen below. That is,
a boxed header saying that this is a tuple of size 2 and then two
pointers to the same list.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>ADR VALUE                            DESCRIPTION
144 00000000000000000000000001000001 128+CONS
140 00000000000000000000000001000001 128+CONS
136 00000000000000000000000010000000 2+ARITYVAL</pre>
</div></div>
<div class="paragraph"><p>This is nice, since it is cheap to do and uses very little space. But if
you send the tuple to another process or do any other type of IO, or any
operations which results in something called a <em>deep copy</em>, then the
data structure is expanded. So if we send out tuple <span class="monospaced">T</span> to another process
P2 (<span class="monospaced">P2 ! T</span>) then the heap of T2 will look like in:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> ..</pre>
</div></div>
<div class="paragraph"><p>You can quickly bring down your Erlang node by expanding a highly shared term,
see <a href="#listing-share">share.erl</a>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>-module(share).

-export([share/2, size/0]).

share(0, Y) -&gt; {Y,Y};
share(N, Y) -&gt; [share(N-1, [N|Y]) || _ &lt;- Y].

size() -&gt;
    T = share:share(5,[a,b,c]),
    {{size, erts_debug:size(T)},
     {flat_size, erts_debug:flat_size(T)}}.



 1&gt; timer:tc(fun() -&gt; share:share(10,[a,b,c]), ok end).
 {1131,ok}

 2&gt; share:share(10,[a,b,c]), ok.
 ok

 3&gt; byte_size(list_to_binary(test:share(10,[a,b,c]))), ok.
 HUGE size (13695500364)
 Abort trap: 6</pre>
</div></div>
<div class="paragraph"><p>You can calculate the memory size of a shared term and the size of the
expanded size of the term with the functions <span class="monospaced">erts_debug:size/1</span> and
<span class="monospaced">erts_debug:flat_size/1</span>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>&gt; share:size().
{{size,19386},{flat_size,94110}}</pre>
</div></div>
<div class="paragraph"><p>For most applications this is not a problem, but you should be aware
of the problem, which can come up in many situations. A deep copy is
used for IO, ETS tables, binary_to_term, and message passing.</p></div>
<div class="paragraph"><p>Let us look in more detail how message passing works.</p></div>
</div>
<div class="sect3">
<h4 id="_message_passing_2">Message passing</h4>
<div class="paragraph"><p>When a process P1 sends a message M to another (local) process P2, the
process P1 first calculates the flat size of M. Then it allocates a
new message buffer of that size by doing a heap_alloc of a heap_frag in
the local scheduler context.</p></div>
<div class="paragraph"><p>Given the code in <a href="#listing-send">send.erl</a> the state of the system could
look like this just before the send in p1/1:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    x0       |00000000 00000000 00000000 00100011| Pid 2
    x1       |00000000 00000000 00000000 01001010| 136 + boxed tag -----------+
                                                                              |
                                                                              |
         ADR                               BINARY  VALUE  +  DESCRIPTION      |
 hend -&gt;     +-------- -------- -------- --------+                            |
             |              ...                  |                            |
             |              ...                  |                            |
 stop -&gt;     |                                   |                            |
                                                                              |
 htop -&gt;     |                                   |                            |
         144 |00000000 00000000 00000000 01000001| 128+CONS        ---------------+
         140 |00000000 00000000 00000000 01000001| 128+CONS        ---------------+
         136 |00000000 00000000 00000000 10000000| 2+ARITYVAL             &lt;---+   |
         132 |00000000 00000000 00000000 01111001| 120+CONS        -------------- | -+
         128 |00000000 00000000 00000110 10001111| (H) 104 bsl 4 + small int tag &lt;+  |
         124 |00000000 00000000 00000000 01110001| 112+CONS        ----------------- | -+
         120 |00000000 00000000 00000110 01011111| (e) 101 bsl 4 + small int tag &lt;---+  |
         116 |00000000 00000000 00000000 01110001| 112+CONS        -------------------- | -+
         112 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;------+  |
         108 |00000000 00000000 00000000 01110001|  96+CONS        ----------------------- | -+
         104 |00000000 00000000 00000110 11001111| (l) 108 bsl 4 + small int tag &lt;---------+  |
         100 |11111111 11111111 11111111 11111011| NIL                                        |
          96 |00000000 00000000 00000110 11111111| (o) 111 bsl 4 + small int tag &lt;------------+
             |                ...                |
 heap -&gt;     +-----------------------------------+


P2</pre>
</div></div>
<div class="paragraph"><p>Then P1 start sending the message M to P2. It (through the code in
erl_message.c) first calculates the flat size of M (which in our example is
23 words)<span class="footnote"><br>[We ignore tracing here which will add a trace token
to the size of the message, and always use a heap fragment.]<br></span>.
Then (in a SMP system) if it can take a lock on P2 and there is enough
room on the heap of P2 it will copy the message to the heap of P2.</p></div>
<div class="paragraph"><p>If P2 is running (or exiting) or there isn&#8217;t enough space on the heap,
then a new heap fragment is allocated
(of sizeof ErlHeapFragment - sizeof(Eterm) + 23*sizeof(Eterm))
<span class="footnote"><br>[The -sizeof(Eterm) comes from mem in ErlHeapFragment already
having the size of 1 Eterm]<br></span> which after initialization will look like:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;        NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; NULL
      Uint64 overhead;               0
    unsigned alloc_size;            23
    unsigned used_size;             23
    Eterm mem[1];                    ?
      ... 22 free words</pre>
</div></div>
<div class="paragraph"><p>Then the message is copied into the heap fragment:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>erl_heap_fragment:
    ErlHeapFragment* next;        NULL
    ErlOffHeap off_heap:
      erl_off_heap_header* first; Boxed tag+&amp;amp;mem+2*WS-+
      Uint64 overhead;               0                |
    unsigned alloc_size;            23                |
    unsigned used_size;             23                |
    Eterm mem:                    2+ARITYVAL   &lt;------+
                                  &amp;amp;mem+3*WS+1  ---+
                                  &amp;amp;mem+13*WS+1 ------+
                                  (H*16)+15    &lt;--+  |
                                  &amp;amp;mem+5*WS+1  --+   |
                                  (e*16)+15    &lt;-+   |
                                  &amp;amp;mem+7*WS+1  ----| |
                                  (l*16)+15    &lt;---+ |
                                  &amp;amp;mem+9*WS+1  ---+  |
                                  (l*16)+15    &lt;--+  |
                                  &amp;amp;mem+11*WS+1 ----+ |
                                  (o*16)+15    &lt;---+ |
                                  NIL                |
                                  (H*16)+15    &lt;-----+
                                  &amp;amp;mem+15*WS+1 --+
                                  (e*16)+15    &lt;-+
                                  &amp;amp;mem+17*WS+1 ----|
                                  (l*16)+15    &lt;---+
                                  &amp;amp;mem+19*WS+1 ---+
                                  (l*16)+15    &lt;--+
                                  &amp;amp;mem+21*WS+1 ----+
                                  (o*16)+15    &lt;---+
                                  NIL&lt;/pre&gt;</pre>
</div></div>
<div class="paragraph"><p>In either case a new mbox (<span class="monospaced">ErlMessage</span>) is allocated, a lock
 (<span class="monospaced">ERTS_PROC_LOCK_MSGQ</span>) is taken on the receiver and the message
 on the heap or the in the new heap fragment is linked into the mbox.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> erl_mesg {
    struct erl_mesg* next = NULL;
    data:  ErlHeapFragment *heap_frag = bp;
    Eterm m[0]            = message;
 } ErlMessage;</pre>
</div></div>
<div class="paragraph"><p>Then the mbox is linked into the in message queue (<span class="monospaced">msg_inq</span>) of the
receiver, and the lock is released. Note that <span class="monospaced">msg_inq.last</span> points to
the <span class="monospaced">next</span> field of the last message in the queue. When a new mbox is
linked in this next pointer is updated to point to the new mbox, and
the last pointer is updated to point to the next field of the new
mbox.</p></div>
</div>
<div class="sect3">
<h4 id="SS-Binaries">Binaries</h4>
<div class="paragraph"><p>As we saw in <a href="#CH-TypeSystem">[CH-TypeSystem]</a> there are four types of binaries
internally. Three of these types, <em>heap binaries</em>, <em>sub binaries</em> and
<em>match contexts</em> are stored on the local heap and handled by the
garbage collector and message passing as any other object, copied as
needed.</p></div>
<div class="sect4">
<h5 id="_reference_counting">Reference Counting</h5>
<div class="paragraph"><p>The fourth type.  large binaries or <em>refc binaries</em> on the other hand
are partially stored outside of the process heap and they are
reference counted.</p></div>
<div class="paragraph"><p>The payload of a refc binary is stored in memory allocated by the
binary allocator. There is also a small reference to the payload call
a ProcBin which is stored on the process heap. This reference is
copied by message passing and by the GC, but the payload is
untouched. This makes it relatively cheap to send large binaries to
other processes since the whole binary doesn&#8217;t need to be copied.</p></div>
<div class="paragraph"><p>All references through a ProcBin to a refc binary increases the
reference count of the binary by one. All ProcBin objects on a
process heap are linked together in a linked list. After a
GC pass this linked list is traversed and the reference count
of the binary is decreased with one for each ProcBin that
has deceased. If the reference count of the refc binary
reaches zero that binary is deallocated.</p></div>
<div class="paragraph"><p>Having large binaries reference counted and not copied by send or
garbage collection is a big win, but there is one problem
with having a mixed environment of garbage collection and
reference counting. In a pure reference counted implementation
the reference count would be reduce as soon as a reference to
the object dies, and when the reference count reaches zero the
object is freed. In the ERTS mixed environment a reference to a
reference counted object does not die until a garbage collection
detects that the reference is dead.</p></div>
<div class="paragraph"><p>This means that binaries, which has a tendency to be large or even
huge, can hang around for a long time after all references to the
binary are dead. Note that since binaries are allocated globally,
all references from all processes need to be dead, that is all
processes that has seen a binary need to do a GC.</p></div>
<div class="paragraph"><p>Unfortunately it is not always easy, as a developer, to see which
processes have seen a binary in the GC sense of the word seen. Imagine
for example that you have a load balancer that receives work items
and dispatches them to workers.</p></div>
<div class="paragraph"><p>In <a href="#load_balancer">this code</a> there is an example of a loop which
doesn&#8217;t need to do GC. (See <a href="#listing-lb">listing lb</a> for a full example.)</p></div>
<div class="listingblock" id="load_balancer">
<div class="content monospaced">
<pre>loop(Workers, N) -&gt;
  receive
    WorkItem -&gt;
       Worker = lists:nth(N+1, Workers),
       Worker ! WorkItem,
       loop(Workers, (N+1) rem length(Workers))
  end.</pre>
</div></div>
<div class="paragraph"><p>This server will just keep on grabbing references to binaries and
never free them, eventually using up all system memory.</p></div>
<div class="paragraph"><p>When one is aware of the problem it is easy to fix, one can either do
a garbage_collect on each iteration of <em>loop</em> or one could do it every
five seconds or so by adding an after clause to the receive. (<em>after
5000 &#8594; garbage_collect(), loop(Workers, N)</em> ).</p></div>
</div>
<div class="sect4">
<h5 id="_sub_binaries_and_matching">Sub Binaries and Matching</h5>
<div class="paragraph"><p>When you match out a part of a binary you get a sub binary.
This sub binary will be a small structure just containing
pointers into the real binary. This increases the reference
count for the binary but uses very little extra space.</p></div>
<div class="paragraph"><p>If a match would create a new copy of the matched part of the binary
it would cost both space and time. So in most cases just doing a
pattern match on a binary and getting a sub binary to work on is just
what you want.</p></div>
<div class="paragraph"><p>There are some degenerate cases, imagine for example that you load
huge file like a book into memory and then you match out a small part
like a chapter to work on. The problem is then that the whole of the
rest of the book is still kept in memory until you are done with
processing the chapter. If you do this for many books, perhaps you
want to get the introduction of every book in your file system, then
you will keep the whole of each book in memory and not just the
introductory chapter. This might lead to huge memory usage.</p></div>
<div class="paragraph"><p>The solution in this case, when you know you only want one small
part of a large binary and you want to have the small part hanging
around for some time, is to use <span class="monospaced">binary:copy/1</span>. This function
is only used for its side effect, which is to actually copy
the sub binary out of the real binary removing the reference to
the larger binary and therefore hopefully letting it be garbage
collected.</p></div>
<div class="paragraph"><p>There is a pretty thorough explanation of how binary construction
and matching is done in the Erlang documentation:
<a href="http://www.erlang.org/doc/efficiency_guide/binaryhandling.html">http://www.erlang.org/doc/efficiency_guide/binaryhandling.html</a>.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_garbage_collection">Garbage Collection</h4>
<!--
This part of the content seems to be good, and probably worthy of being a top-level heading. It might be a bit long, though. - bmacdonald
-->
<div class="paragraph"><p>When a process runs out of space on the stack and heap the process
will try to reclaim space by doing a minor garbage collection. The
code for this can be found in
<a href="https://github.com/erlang/otp/blob/maint/erts/emulator/beam/erl_gc.c">erl_gc.c</a>.</p></div>
<div class="paragraph"><p>ERTS uses a generational copying garbage collector. A copying
collector means that during garbage collection all live young terms
are copied from the old heap to a new heap. Then the old heap is
discarded. A generational collector works on the principle that
most terms die young, they are temporary terms created, used,
and thrown away. Older terms are promoted to the old generation
which is collected more seldom, with the rational that once
a term has become old it will probably live for a long time.</p></div>
<div class="paragraph"><p>Conceptually a garbage collection cycle works as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
First you collect all roots (e.g. the stack).
</p>
</li>
<li>
<p>
Then for each root, if the root points to a heap allocated object
which doesn&#8217;t have a forwarding pointer you copy the object to the new
heap. For each copied object update the original with a forwarding
pointer to the new copy.
</p>
</li>
<li>
<p>
Now go through the new heap and do the same as for the roots.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will go through an example to see how this is done in
detail. We will go through a minor collection without an
old generation, and we will only use the stack as the root set.
In reality the process dictionary, trace data and probe data
among other things are also included in the rootset.</p></div>
<div class="paragraph"><p>Let us look at how the call to garbage_collect in the gc_example
behaves. The code will generate a string which is shared by two
elements of a cons and a tuple, the tuple will the be eliminated
resulting in garbage. After the GC there should only be one string on
the heap. That is, first we generate the term
<span class="monospaced">{["Hello","Hello"], "Hello"}</span> (sharing the same string "Hello" in
all instances. Then we just keep the term <span class="monospaced">["Hello","Hello"]</span> when
triggering a gc.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">We will take the opportunity to go through how you, on a
linux system, can used gdb to examine the behavior of ERTS.
You can of course use the debugger of your choice. If you already know
how to use gdb or if you have no interest in going into the debugger
you can just ignore the meta text about how to inspect the system and
just look at the diagrams and the explanations of how the GC works.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">gc_example</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">example</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">example</span></span>() <span style="color: #990000">-&gt;</span>
  <span style="color: #009900">T</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">gen_data</span></span>(),
  <span style="color: #009900">S</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">1</span>, <span style="color: #009900">T</span>),
  <span style="font-weight: bold"><span style="color: #000000">erlang:garbage_collect</span></span>(),
  <span style="color: #009900">S</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">gen_data</span></span>() <span style="color: #990000">-&gt;</span>
 <span style="color: #009900">S</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">gen_string</span></span>(<span style="color: #FF0000">$H</span>, <span style="color: #FF0000">$e</span>, <span style="color: #FF0000">$l</span>, <span style="color: #FF0000">$l</span>, <span style="color: #FF0000">$o</span>),
 <span style="color: #009900">T</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">gen_tuple</span></span>([<span style="color: #009900">S</span>,<span style="color: #009900">S</span>],<span style="color: #009900">S</span>),
 <span style="color: #009900">T</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">gen_string</span></span>(<span style="color: #009900">A</span>,<span style="color: #009900">B</span>,<span style="color: #009900">C</span>,<span style="color: #009900">D</span>,<span style="color: #009900">E</span>) <span style="color: #990000">-&gt;</span>
   [<span style="color: #009900">A</span>,<span style="color: #009900">B</span>,<span style="color: #009900">C</span>,<span style="color: #009900">D</span>,<span style="color: #009900">E</span>]<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">gen_tuple</span></span>(<span style="color: #009900">A</span>,<span style="color: #009900">B</span>) <span style="color: #990000">-&gt;</span>
 {<span style="color: #009900">A</span>,<span style="color: #009900">B</span>}<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>After compiling the example I start an erlang shell, test the call
and prepare for a new call to the example (without hitting return):</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>1&gt; gc_example:example().
["Hello","Hello"]
2&gt; spawn(gc_example,example,[]).</pre>
</div></div>
<div class="paragraph"><p>Then I use gdb to attach to my erlang node (os PID: 2955 in this case)</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ gdb /home/happi/otp/lib/erlang/erts-6.0/bin/beam.smp 2955</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Depending on your settings for ptrace_scope you might have to
precede the gdb invocation with <em>sudo</em>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Then in gdb I set a breakpoint at the start of the main GC function and
let the node continue:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(gdb) break garbage_collect_0
(gdb) cont
Continuing.</pre>
</div></div>
<div class="paragraph"><p>Now I hit enter in the Erlang shell and execution stops at the breakpoint:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Breakpoint 1, garbage_collect_0 (A__p=0x7f673d085f88, BIF__ARGS=0x7f673da90340) at beam/bif.c:3771
3771        FLAGS(BIF_P) |= F_NEED_FULLSWEEP;</pre>
</div></div>
<div class="paragraph"><p>Now we can inspect the PCB of the process:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(gdb) p *(Process *) A__p
$1 = {common = {id = 1408749273747, refc = {counter = 1}, tracer_proc = 18446744073709551611, trace_flags = 0, u = {alive = {
        started_interval = 0, reg = 0x0, links = 0x0, monitors = 0x0, ptimer = 0x0}, release = {later = 0, func = 0x0, data = 0x0,
        next = 0x0}}}, htop = 0x7f6737145950, stop = 0x7f6737146000, heap = 0x7f67371458c8, hend = 0x7f6737146010, heap_sz = 233,
  min_heap_size = 233, min_vheap_size = 46422, fp_exception = 0, hipe = {nsp = 0x0, nstack = 0x0, nstend = 0x0, ncallee = 0x7f673d080000,
    closure = 0, nstgraylim = 0x0, nstblacklim = 0x0, ngra = 0x0, ncsp = 0x7f673d0863e8, narity = 0, float_result = 0}, arity = 0,
  arg_reg = 0x7f673d086080, max_arg_reg = 6, def_arg_reg = {393227, 457419, 18446744073709551611, 233, 46422, 2000}, cp = 0x7f673686ac40,
  i = 0x7f673be17748, catches = 0, fcalls = 1994, rcount = 0, schedule_count = 0, reds = 0, group_leader = 893353197987, flags = 0,
  fvalue = 18446744073709551611, freason = 0, ftrace = 18446744073709551611, next = 0x7f673d084cc0, nodes_monitors = 0x0,
  suspend_monitors = 0x0, msg = {first = 0x0, last = 0x7f673d086120, save = 0x7f673d086120, len = 0, mark = 0x0, saved_last = 0x7d0}, u = {
    bif_timers = 0x0, terminate = 0x0}, dictionary = 0x0, seq_trace_clock = 0, seq_trace_lastcnt = 0,
  seq_trace_token = 18446744073709551611, initial = {393227, 457419, 0}, current = 0x7f673be17730, parent = 1133871366675,
  approx_started = 1407857804, high_water = 0x7f67371458c8, old_hend = 0x0, old_htop = 0x0, old_heap = 0x0, gen_gcs = 0,
  max_gen_gcs = 65535, off_heap = {first = 0x0, overhead = 0}, mbuf = 0x0, mbuf_sz = 0, psd = 0x0, bin_vheap_sz = 46422,
  bin_vheap_mature = 0, bin_old_vheap_sz = 46422, bin_old_vheap = 0, sys_task_qs = 0x0, state = {counter = 41002}, msg_inq = {first = 0x0,
    last = 0x7f673d086228, len = 0}, pending_exit = {reason = 0, bp = 0x0}, lock = {flags = {counter = 1}, queue = {0x0, 0x0, 0x0, 0x0},
    refc = {counter = 1}}, scheduler_data = 0x7f673bd6c080, suspendee = 18446744073709551611, pending_suspenders = 0x0, run_queue = {
    counter = 140081362118912}, hipe_smp = {have_receive_locks = 0}}</pre>
</div></div>
<div class="paragraph"><p>Wow, that was a lot of information. The interesting part is about the stack and the heap:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>hend = 0x7f6737146010,
stop = 0x7f6737146000,
htop = 0x7f6737145950,
heap = 0x7f67371458c8,</pre>
</div></div>
<div class="paragraph"><p>By using some helper scripts we can inspect the stack and the heap in a meaningful
way. (see <a href="#AP-listings">[AP-listings]</a> for the definitions of the scripts in gdb_script.)</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(gdb) source gdb_scripts
(gdb) print_p_stack A__p
0x00007f6737146008 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
(gdb) print_p_heap A__p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f6737145928 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div></div>
<div class="paragraph"><p>Here we can see the heap of the process after it has allocated the
list "Hello" on the heap and the cons containing that list twice, and
the tuple containing the cons and the list. The <em>root set</em>, in this
case the stack, contains a pointer to the cons containing two copies
of the list. The tuple is dead, that is, there are no references to
it.</p></div>
<div class="paragraph"><p>The garbage collection starts by calculating the root set and by
allocating a new heap (<em>to space</em>). By stepping into the gc code in the
debugger you can see how this is done. I will not go through the
details here. After a number of steps the execution will reach the
point where all terms in the root set are copied to the new heap. This
starts around (depending on version) line 1272 with a <span class="monospaced">while</span> loop in
erl_gc.c.</p></div>
<div class="paragraph"><p>In our case the root is a cons pointing to address 0x00007f95666597f0
containing the letter (integer) <em>H</em>. When a cons cell is moved from
the current heap, called <em>from space</em>, to <em>to space</em> the value in the
head (or car) is overwritten with a <em>moved cons</em> tag (the value 0).</p></div>
<div class="paragraph"><p>After the first step where the root set is moved, the from space
and the to space looks like this:</p></div>
<div class="paragraph"><p>from space:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(gdb) print_p_heap p
0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
0x00007f6737145908 [0x000000000000048f] 72
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111</pre>
</div></div>
<div class="paragraph"><p>to space:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(gdb) print_heap n_htop-1 n_htop-2
0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div></div>
<div class="paragraph"><p>In from space the head of the first cons cell has been overwritten
with 0 (looks like a tuple of size 0) and the tail has been overwritten
with a forwarding pointer pointing to the new cons cell in the to space.
In to space we now have the first cons cell with two
backward pointers to the head and the tail of the cons in the from space.</p></div>
<div class="paragraph"><p>When the collector is done with the root set the to space contains
backward pointers to all still live terms. At this point the collector
starts sweeping the to space. It uses two pointers <span class="monospaced">n_hp</span> pointing to
the bottom of the unseen heap and <span class="monospaced">n_htop</span> pointing to the top of the heap.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>n_htop:
        0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
n_hp    0x00007f67371445b0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908</pre>
</div></div>
<div class="paragraph"><p>The GC will then look at the value pointed to by <span class="monospaced">n_hp</span>, in this case a
cons pointing back to the from space. So it moves that cons to the to
space, incrementing n_htop to make room for the new cons, and
incrementing <span class="monospaced">n_hp</span> to indicate that the first cons is seen.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0xfffffffffffffffb] NIL
0x00007f6737145918 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
        0x00007f67371445c0 [0x000000000000048f] 72
n_hp    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f6737145918
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div></div>
<div class="paragraph"><p>The same thing then happens with the second cons.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
0x00007f67371458f8 [0x000000000000065f] 101
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
        0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
        0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371458f8
n_hp    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div></div>
<div class="paragraph"><p>The next element in to space is the immediate 72, which is only
stepped over (with <span class="monospaced">n_hp</span>++). Then there is another cons which is moved.</p></div>
<div class="paragraph"><p>The same thing then happens with the second cons.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371458d9] cons -&gt; 0x00007f67371458d8
0x00007f67371458e8 [0x00000000000006cf] 108
0x00007f67371458e0 [0x00007f67371458c9] cons -&gt; 0x00007f67371458c8
0x00007f67371458d8 [0x00000000000006cf] 108
0x00007f67371458d0 [0xfffffffffffffffb] NIL
0x00007f67371458c8 [0x00000000000006ff] 111

to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
        0x00007f67371445d8 [0xfffffffffffffffb] NIL
n_hp    0x00007f67371445d0 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div></div>
<div class="paragraph"><p>Now we come to a cons that points to a cell that has already been moved.
The GC sees the IS_MOVED_CONS tag at 0x00007f6737145908 and copies the
destination of the moved cell from the tail (<span class="monospaced">*n_hp</span>+ = ptr[1];+). This
way sharing is preserved during GC. This step does not affect from space,
but the backward pointer in to space is rewritten.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>to space:

n_htop:
        0x00007f67371445e8 [0x00007f67371458e9] cons -&gt; 0x00007f67371458e8
        0x00007f67371445e0 [0x000000000000065f] 101
n_hp    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371458f9] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f6737145919] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div></div>
<div class="paragraph"><p>Then the rest of the list (the string) is moved.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>from space:

0x00007f6737145948 [0x00007f6737145909] cons -&gt; 0x00007f6737145908
0x00007f6737145940 [0x00007f6737145929] cons -&gt; 0x00007f6737145928
0x00007f6737145938 [0x0000000000000080] Tuple size 2
0x00007f6737145930 [0x00007f67371445b1] cons -&gt; 0x00007f67371445b0
0x00007f6737145928 [0x0000000000000000] Tuple size 0
0x00007f6737145920 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
0x00007f6737145918 [0x0000000000000000] Tuple size 0
0x00007f6737145910 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
0x00007f6737145908 [0x0000000000000000] Tuple size 0
0x00007f6737145900 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
0x00007f67371458f8 [0x0000000000000000] Tuple size 0
0x00007f67371458f0 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
0x00007f67371458e8 [0x0000000000000000] Tuple size 0
0x00007f67371458e0 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
0x00007f67371458d8 [0x0000000000000000] Tuple size 0
0x00007f67371458d0 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
0x00007f67371458c8 [0x0000000000000000] Tuple size 0

to space:

n_htop:
n_hp
SEEN    0x00007f6737144618 [0xfffffffffffffffb] NIL
SEEN    0x00007f6737144610 [0x00000000000006ff] 111
SEEN    0x00007f6737144608 [0x00007f6737144611] cons -&gt; 0x00007f6737144610
SEEN    0x00007f6737144600 [0x00000000000006cf] 108
SEEN    0x00007f67371445f8 [0x00007f6737144601] cons -&gt; 0x00007f6737144600
SEEN    0x00007f67371445f0 [0x00000000000006cf] 108
SEEN    0x00007f67371445e8 [0x00007f67371445f1] cons -&gt; 0x00007f67371445f0
SEEN    0x00007f67371445e0 [0x000000000000065f] 101
SEEN    0x00007f67371445d8 [0xfffffffffffffffb] NIL
SEEN    0x00007f67371445d0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0
SEEN    0x00007f67371445c8 [0x00007f67371445e1] cons -&gt; 0x00007f67371445e0
SEEN    0x00007f67371445c0 [0x000000000000048f] 72
SEEN    0x00007f67371445b8 [0x00007f67371445d1] cons -&gt; 0x00007f67371445d0
SEEN    0x00007f67371445b0 [0x00007f67371445c1] cons -&gt; 0x00007f67371445c0</pre>
</div></div>
<div class="paragraph"><p>There are some things to note from this example. When terms are
created in Erlang they are created bottom up, starting with the
elements. The garbage collector works top down, starting with the
top level structure and then copying the elements. This means that
the direction of the pointers change after the first GC. This has
no real implications but it is good to know when looking at actual
heaps. You can not assume that structures should be bottom up.</p></div>
<div class="paragraph"><p>Also note that the GC does a breath first traversal. This means that
locality for one term most often is worse after a GC. With the size of
modern cashes this should not be a problem. You could of course create
a pathological example where it becomes a problem, but you can also
create a pathological example where a depth first approach would cause
problems.</p></div>
<div class="paragraph"><p>The third thing to note is that sharing is preserved which is really
important otherwise we might end up using more space after a GC than
before.</p></div>
<div class="paragraph"><p>Generations&#8230;</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>  hend -&gt;  +----+
           |....|
  stop -&gt;  |    |
           |    |    +----+ old_hend
           |    |    |    |
  htop -&gt;  |    |    |    |
           |....|    |    | old_htop
           |....|    |....|
  heap -&gt;  +----+    +----+ old_heap
          The Heap   Old Heap</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>+high_water, old_hend, old_htop, old_heap,
gen_gcs, max_gen_gcs, off_heap,  mbuf, mbuf_sz, psd, bin_vheap_sz,
bin_vheap_mature, bin_old_vheap_sz, bin_old_vheap+.</pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_other_interesting_memory_areas">Other interesting memory areas</h3>
<div class="sect3">
<h4 id="_the_atom_table">The atom table.</h4>
<div class="paragraph"><p>TODO
==== Code
TODO
==== Constants
TODO</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_data_structures_ets_dets_mnesia">Advanced data structures (ETS, DETS, Mnesia)</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="CH-IO">IO, Ports and Networking (10p)</h2>
<div class="sectionbody">
<div class="paragraph"><p>Within Erlang all communication is done by asynchronous signaling.
The communication between an Erlang node and the outside world is done
through a <em>port</em>. A port is an interface between Erlang processes and
an external resource. In early versions of Erlang a port behaved very
much in the same way as a process and you comunicated by sending and
receiving signals. You can still communicate with ports this way but
there are also a number of BIFs to communicate directly with a port.</p></div>
<div class="paragraph"><p>In this chapter we will look at how ports are used as a common
interface for all IO, how ports comunicate with the outside world and
how Erlang processes comunicate with ports. But first we will look
at how standard IO works on a higher level.</p></div>
<div class="sect2">
<h3 id="_standard_io">Standard IO</h3>
<div class="ulist"><ul>
<li>
<p>
IO protocol
</p>
</li>
<li>
<p>
group leader
</p>
</li>
<li>
<p>
erlang:display&#8201;&#8212;&#8201;a biff that sends directly to node&#8217;s std out
</p>
</li>
<li>
<p>
io:format&#8201;&#8212;&#8201;sends through io protocol and the group leader
</p>
</li>
<li>
<p>
Redirecting standard IO at startup (detached mode)
</p>
</li>
<li>
<p>
Standard in and out
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_ports_2">Ports</h3>
<div class="paragraph"><p>A port is the process like interface between Erlang processes and
everything that is not Erlang processes. The programmer can to
a large extent pretend that everything in the world behaves like
an Erlang process and communicate through message passing.</p></div>
<div class="paragraph"><p>Each port has an owner, more on this later, but all processes
who knows about the port can send messages to the port.
In figure REF we see how a processes can communicate with the
port and how the port is communicating to the world outside the
Erlang node.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>  +-------------------+
  |   __              |
  |  /  \   owner    __           _______
  |  \__/ &lt; - -- -&gt; /  \ &lt;----&gt;  /      /
  |   P1            \__/        /______/
  |              7    |Port1     file
  |            /      |
  |          /        |
  |    __  /          |
  |   /  \            |
  |   \__/            |
  |    P2             |
  +-------------------+
      Erlang Node

Process P1 has opened a port (Port1) to a file, and is the owner of
the port and can receive messages from the port. Process P2 also has a
handle to the port and can send messages to the port. The processes
and the port resides in an Erlang node. The file lives in the file and
operating system on the outside of the Erlang node.</pre>
</div></div>
<div class="paragraph"><p>If the port owner dies or is terminated the port is also killed.
When a port terminates all external resources should also be cleaned
up. This is true for all ports that comes with Erlang and if you
implement your own port you should make sure it does this cleanup.</p></div>
<div class="sect3">
<h4 id="_different_types_of_ports">Different types of Ports</h4>
<div class="paragraph"><p>There are three different classes of ports: file descriptors, external
programs and drivers. A file descriptor port makes it possible for a
process to access an already opened file descriptor. A port to an
external program invokes the external program as a separate OS
process. A driver port requires a driver to be loaded in the Erlang
node.</p></div>
<div class="paragraph"><p>All ports are created by a call to <span class="monospaced">erlang:open_port(PortName,
PortSettings)</span>.</p></div>
<div class="paragraph"><p>A file descriptor port is opened with <span class="monospaced">{fd, In, Out}</span> as the
<span class="monospaced">PortName</span>. This class of ports is used by some internal ERTS servers
like the old shell. They are considered to not be very efficient and
hence seldom used.</p></div>
<div class="paragraph"><p>An external program port can be used to execute any program in the
native OS of the Erlang node. To open an external program port you
give either the argument <span class="monospaced">{spawn, Command}</span> or <span class="monospaced">{spawn_executable,
FileName}</span> with the name of the external program. This is the easiest
and one of the safest way to interact with code written in other
programming languages. Since the external program is executed in its
own OS process it will not bring down the Erlang node if it
crashes. (It can of course use up all CPU or memory or do a number of
other things to bring down the whole OS, but it is much safer than a
linked in driver or a NIF.)</p></div>
<div class="paragraph"><p>A driver port requires that a driver program has been loaded with
ERTS. Such a port is started with either <span class="monospaced">{spawn, Command}</span> or
<span class="monospaced">{spawn_driver, Command}</span>. Writing your own linked in driver can be an
efficient way to interface for example some C library code that you
would like to use. Note that a linked in driver executes in the same
OS process as the Erlang node and a crash in the driver will bring
down the whole node. Details about how to write an Erlang driver in
general can be found in <a href="#CH-C">[CH-C]</a>.</p></div>
<div class="paragraph"><p>Erlang OTP comes with a number port drivers implementing the
predefined port types. There are the common drivers available on all
platforms: tcp_inet, udp_inet, sctp_inet, efile, zlib_drv,
ram_file_drv, binary_filer, tty_sl. These drivers are used to
implement e.g. file handling and sockets in Erlang. On Windows there
is also a driver to access the registry: registry<em>drv</em>. And on most
platforms there are example drivers to use when implementing your own
driver like: multi and sig_drv.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre> +-----------------------------------------------------------------------------------------------------+
 |                               Entities on an Erlang Node                                            |
 |--------------------------------------------------+--------------------------------------------------|
 |                Processes                         |                    Ports                         |
 |--------------------------------------------------+---------++------++-------------------------------|
 |                                                  | FD      ||  OS  ||         Drivers               |
 |--------------------------------------------------+---------++------++----------+++-------+++--------|
 |                                                  | (Heart) || (ls) || tcp_inet ||| efile ||| ...    |
 +--------------------------------------------------+---------++------++----------+++-------+++--------+</pre>
</div></div>
<div class="sect4">
<h5 id="_ports_to_file_descriptors">Ports to file descriptors</h5>
<div class="paragraph"><p>Creating</p></div>
<div class="paragraph"><p>Commands</p></div>
<div class="paragraph"><p>Examples</p></div>
<div class="paragraph"><p>Implementation</p></div>
</div>
<div class="sect4">
<h5 id="_ports_to_spawned_os_processes">Ports to Spawned OS Processes</h5>
<div class="paragraph"><p>Creating</p></div>
<div class="paragraph"><p>Commands</p></div>
<div class="paragraph"><p>Implementation</p></div>
<div class="paragraph"><p>Windows</p></div>
</div>
<div class="sect4">
<h5 id="_ports_to_linked_in_drivers">Ports to Linked in Drivers</h5>
<div class="paragraph"><p>Creating</p></div>
<div class="paragraph"><p>Commands</p></div>
<div class="paragraph"><p>Implementation</p></div>
<div class="paragraph"><p>See chapter <a href="#CH-C">[CH-C]</a> for details of how to implement your own
linked in driver.</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_erlang">Distributed Erlang</h3>
</div>
<div class="sect2">
<h3 id="_sockets_udp_and_tcp">Sockets, UDP and TCP</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distribution">Distribution</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="CH-C">Interfacing C&#8201;&#8212;&#8201;BIFs NIFs and Linked in Drivers</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_native_code">Native code</h2>
<div class="sectionbody">
</div>
</div>
<h1 id="P-Running">Running ERTS</h1>
<div class="sect1">
<h2 id="_operation_and_maintenance">Operation and Maintenance</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_appendices">Appendix A: Appendices</h2>
<div class="sectionbody">
<div class="sect1">
<h2 id="CH-BuildingERTS">Building the Erlang Runtime System</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this chapter we will look at different way to configure and build
Erlang/OTP to suite your needs. We will use an Ubuntu Linux for most
of the examples. If you are using a different OS you can find detailed
instructions on how to build for that OS in the documentation in the
source code (in HOWTO/INSTALL.md), or on the web
[INSTALL.html.](<a href="http://www.erlang.org/doc/installation_guide/INSTALL.html">http://www.erlang.org/doc/installation_guide/INSTALL.html</a>)</p></div>
<div class="paragraph"><p>There are basically two ways to build the runtime system, the traditional
way with autoconf, configure and make or with the help of
[kerl.](<a href="https://github.com/spawngrid/kerl">https://github.com/spawngrid/kerl</a>)</p></div>
<div class="paragraph"><p>I recommend that you first give the traditional way a try, that way
you will get a better understanding of what happens when you
build and what settings you can change. Then go over to using kerl
for your day to day job of managing configurations and builds.</p></div>
<div class="sect2">
<h3 id="_first_time_build">First Time Build</h3>
<div class="paragraph"><p>To get you started we will go though a step by step process of
building the system from scratch and then we will look at
how you can configure your system for different purposes.</p></div>
<div class="paragraph"><p>This step by step guide assumes that you have a modern Ubuntu
installation. We will look at how to build on OS X and Windows
later in this chapter.</p></div>
<div class="sect3">
<h4 id="_prerequisites">Prerequisites</h4>
<div class="paragraph"><p>You will need a number of tools in order to fetch, unpack and
build from source. The file Install.md lists some of the most
important ones.</p></div>
<div class="paragraph"><p>Gven that we have a recent Ubuntu installation to start with
many of the needed tools such as tar, make, perl and gcc should
already be installed. But some tools like git, m4 and ncurses
will probably need to be installed.</p></div>
<div class="paragraph"><p>If you add a source URI to your apt configuration you will
be able to use the build-dep command to get the needed sources
to build erlang. You can do this by uncommenting the deb-src
line for your distribution in /etc/apt/sources.list.</p></div>
<div class="paragraph"><p>For the Yakkety Yak release you could add the line by:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> sudo cat <span style="color: #FF0000">"deb-src http://se.archive.ubuntu.com/ubuntu/ \</span>
<span style="color: #FF0000">yakkety main restricted"</span> <span style="color: #990000">&gt;&gt;</span> /etc/apt/sources<span style="color: #990000">.</span>list</tt></pre></div></div>
<div class="paragraph"><p>Then the following commands will get almost all the tools you need:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> sudo apt-get install git autoconf m4
<span style="color: #990000">&gt;</span> sudo apt-get build-dep erlang</tt></pre></div></div>
<div class="paragraph"><p>If you have a slightly older version of Ubuntu like Saucy and you
want to build with wx support, you need to get the wx libraries:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> sudo apt-key adv --fetch-keys http<span style="color: #990000">:</span>//repos<span style="color: #990000">.</span>codelite<span style="color: #990000">.</span>org/CodeLite<span style="color: #990000">.</span>asc
<span style="color: #990000">&gt;</span> sudo apt-add-repository <span style="color: #FF0000">'deb http://repos.codelite.org/wx3.0/ubuntu/ saucy universe'</span>
<span style="color: #990000">&gt;</span> sudo apt-get update
<span style="color: #990000">&gt;</span> sudo apt-get install libwxbase3<span style="color: #990000">.</span><span style="color: #993399">0</span>-<span style="color: #993399">0</span>-unofficial libwxbase3<span style="color: #990000">.</span><span style="color: #993399">0</span>-dev libwxgtk3<span style="color: #990000">.</span><span style="color: #993399">0</span>-<span style="color: #993399">0</span>-unofficial <span style="color: #990000">\</span>
libwxgtk3<span style="color: #990000">.</span><span style="color: #993399">0</span>-dev wx3<span style="color: #990000">.</span><span style="color: #993399">0</span>-headers wx-common libwxbase3<span style="color: #990000">.</span><span style="color: #993399">0</span>-dbg libwxgtk3<span style="color: #990000">.</span><span style="color: #993399">0</span>-dbg wx3<span style="color: #990000">.</span><span style="color: #993399">0</span>-i18n <span style="color: #990000">\</span>
wx3<span style="color: #990000">.</span><span style="color: #993399">0</span>-examples wx3<span style="color: #990000">.</span><span style="color: #993399">0</span>-doc</tt></pre></div></div>
<div class="paragraph"><p>You might also want to create a directory where you keep the
source code and also install your home built version without
interfering with any pre built and system wide installations.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> cd
<span style="color: #990000">&gt;</span> mkdir otp</tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_source">Getting the source</h3>
<div class="paragraph"><p>There are two main ways of getting the source. You can download a
tarball from [erlang.org](<a href="http://www.erlang.org/download.html">http://www.erlang.org/download.html</a>) or you
can check out the source code directly from Github.</p></div>
<div class="paragraph"><p>If you want to quickly download a stable version of the source try:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> cd <span style="color: #990000">~</span>/otp
<span style="color: #990000">&gt;</span> wget http<span style="color: #990000">:</span>//erlang<span style="color: #990000">.</span>org/download/otp_src_19<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>tar<span style="color: #990000">.</span>gz
<span style="color: #990000">&gt;</span> tar -xzf otp_src_19<span style="color: #990000">.</span><span style="color: #993399">1</span><span style="color: #990000">.</span>tar<span style="color: #990000">.</span>gz
<span style="color: #990000">&gt;</span> cd otp_src_19<span style="color: #990000">.</span><span style="color: #993399">1</span>
<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">ERL_TOP</span><span style="color: #990000">=</span>`pwd`</tt></pre></div></div>
<div class="paragraph"><p>or if you want to be able to easilly update to the latest bleeding
edge or you want to contribute fixes back to the comunity you can
check out the source through git:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> cd <span style="color: #990000">~</span>/otp
<span style="color: #990000">&gt;</span> git clone https<span style="color: #990000">:</span>//github<span style="color: #990000">.</span>com/erlang/otp<span style="color: #990000">.</span>git <span style="font-weight: bold"><span style="color: #0000FF">source</span></span>
<span style="color: #990000">&gt;</span> cd <span style="font-weight: bold"><span style="color: #0000FF">source</span></span>
<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">ERL_TOP</span><span style="color: #990000">=</span>`pwd`
<span style="color: #990000">&gt;</span> <span style="color: #990000">.</span>/otp_build autoconf</tt></pre></div></div>
<div class="paragraph"><p>Now you are ready to build and install Erlang:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">LANG</span><span style="color: #990000">=</span>C
<span style="color: #990000">&gt;</span> <span style="color: #990000">.</span>/configure --prefix<span style="color: #990000">=</span><span style="color: #009900">$HOME</span>/otp/install
<span style="color: #990000">&gt;</span> make
<span style="color: #990000">&gt;</span> make install
<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">PATH</span><span style="color: #990000">=</span><span style="color: #009900">$HOME</span>/otp/install/bin<span style="color: #990000">/:</span><span style="color: #009900">$PATH</span>
<span style="color: #990000">&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">export</span></span> <span style="color: #009900">ROOTDIR</span><span style="color: #990000">=</span><span style="color: #009900">$HOME</span>/otp/install<span style="color: #990000">/</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-Instructions">Appendix A: BEAM Instructions</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here we will go through most of the instructions in the BEAM
generic instruction set in detail. In the next section we list
all instructions with a brief explanation generated from the
documentaion in the code (see <span class="monospaced">lib/compiler/src/genop.tab</span>).</p></div>
<div class="sect2">
<h3 id="_functions_and_labels">Functions and Labels</h3>
<div class="sect3">
<h4 id="_label_lbl">label Lbl</h4>
<div class="paragraph"><p>Instruction number 1 in the generic instruction set is not really an
instruction at all. It is just a module local label giving a name, or
actually a number to the current position in the code.</p></div>
<div class="paragraph"><p>Each label potentially marks the beginning of a basic block since
it is a potential destination of a jump.</p></div>
</div>
<div class="sect3">
<h4 id="_func_info_module_function_arity">func_info Module Function Arity</h4>
<div class="paragraph"><p>The code for each function starts with a func_info instruction.
This instruction is used for generating a function clause error,
and the execution of the code in the function actually starts
at the label following the func_info instruction.</p></div>
<div class="paragraph"><p>Imagine a function with a guard:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">id</span></span>(<span style="color: #009900">I</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="font-weight: bold"><span style="color: #000080">is_integer</span></span>(<span style="color: #009900">I</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">I</span><span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>The Beam code for this function might look like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
{<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #FF6600">id</span>, <span style="color: #993399">1</span>, <span style="color: #993399">4</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">3</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">func_info</span>,{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">test1</span>},{<span style="font-weight: bold"><span style="color: #000080">atom</span></span>,<span style="color: #FF6600">id</span>},<span style="color: #993399">1</span>}<span style="color: #990000">.</span>
  {<span style="color: #FF6600">label</span>,<span style="color: #993399">4</span>}<span style="color: #990000">.</span>
    {<span style="color: #FF6600">test</span>,<span style="font-weight: bold"><span style="color: #000080">is_integer</span></span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">3</span>},[{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}]}<span style="color: #990000">.</span>
    <span style="color: #FF6600">return</span><span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="paragraph"><p>Here the meta information <span class="monospaced">{function, id, 1, 4}</span> tells us that
execution of the id/1 function will start at label 4. At label 4 we do
an <span class="monospaced">is_integer</span> on x0 and if we fail we jump to label 3 (f3) which
points to the func_info instruction, which will generate a <em>function
clause</em> exception. Otherwise we just fall through and return the
argument (x0).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_test_instructions">Test instructions</h3>
<div class="sect3">
<h4 id="_type_tests">Type tests</h4>
<div class="paragraph"><p>The type test instructions (<span class="monospaced">is_\* Lbl Argument</span>) checks whether the
argument is of the given type and if not jumps to the label Lbl.
The beam disassembler wraps all these instructions in a  <span class="monospaced">test</span>
instruction. E.g.:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    {<span style="color: #FF6600">test</span>,<span style="font-weight: bold"><span style="color: #000080">is_integer</span></span>,{<span style="color: #FF6600">f</span>,<span style="color: #993399">3</span>},[{<span style="color: #FF6600">x</span>,<span style="color: #993399">0</span>}]}<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>The current type test instructions are is_integer, is_float,
is_number, is_atom, is_pid, is_reference, is_port, is_nil, is_binary,
is_list, is_nonempty_list, is_function, is_function2, is_boolean,
is_bitstr, and is_tuple.</p></div>
<div class="paragraph"><p>And then there is also one type test instruction of Arity 3:
<span class="monospaced">test_arity Lbl Arg Arity</span>. This instruction tests that
the arity of the argument (assumed to be a tuple) is of <span class="monospaced">Arity</span>.
This instruction is usually preceded by an <span class="monospaced">is_tuple</span>
instruction.</p></div>
</div>
<div class="sect3">
<h4 id="_comparisons">Comparisons</h4>
<div class="paragraph"><p>The comparison instructions (<span class="monospaced">is_\* Lbl Arg1 Arg2</span>) compares the
two arguments according to the instructions and jumps to Lbl if the
comparison fails.</p></div>
<div class="paragraph"><p>The comparison instructions are: : is_lt,  is_ge,  is_eq,  is_ne,
is_eq_exact, and  is_ne_exact.</p></div>
<div class="paragraph"><p>Remember that all Erlang terms are ordered so these instructions can
compare any two terms. You can for example test if the atom <span class="monospaced">self</span>
is less than the pid  returned by <span class="monospaced">self()</span>. (It is.)</p></div>
<div class="paragraph"><p>Note that for numbers the comparison is done on the Erlang type
<em>number</em>, see <a href="#CH-TypeSystem">[CH-TypeSystem]</a>. That is, for a mixed float and
integer comparison the number of lower precision is converted to the
other type before comparison. For example on my system 1 and 0.1
compares as equal, as well as 9999999999999999 and 1.0e16.
Comparing floating point numbers is always risk and best avoided,
the result may wary depending on the underlying hardware.</p></div>
<div class="paragraph"><p>If you want to make sure that the integer 1 and the floating point
number 1.0 are compared different you can use is_eq_exact and
is_ne_exact. This corresponds to the Erlang operators <span class="monospaced">=:=</span> and
<span class="monospaced">=/=</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_function_calls">Function Calls</h3>
<div class="paragraph"><p>In this chapter we will summarize what the different call instructions
does. For a thorough description of how function calls work see
<a href="#CH-Calls">[CH-Calls]</a>.</p></div>
<div class="sect3">
<h4 id="_call_arity_label">call Arity Label</h4>
<div class="paragraph"><p>Does a call to the function of arity <span class="monospaced">Arity</span> in the same
module at label <span class="monospaced">Label</span>. First count down the reductions and
if needed do a context switch.</p></div>
<div class="paragraph"><p>For all local calls the label is the second label of the
function where the code starts. It is assumed that the preceding
instruction at that label is <span class="monospaced">func_info</span> in order to get the MFA if a
context switch is needed.</p></div>
</div>
<div class="sect3">
<h4 id="_call_last_arity_label">call_last Arity Label</h4>
<div class="paragraph"><p>Do a tail recursive call the function of arity <span class="monospaced">Arity</span> in the same
module at label <span class="monospaced">Label</span>. First count down the reductions and if needed
do a context switch.</p></div>
</div>
<div class="sect3">
<h4 id="_call_only_arity_label_deallocate">call_only Arity Label Deallocate</h4>
<div class="paragraph"><p>Deallocate <span class="monospaced">Deallocate</span> words of stack, then do a tail recursive call
to the function of arity <span class="monospaced">Arity</span> in the same module at label <span class="monospaced">Label</span> First
count down the reductions and if needed do a context switch.</p></div>
</div>
<div class="sect3">
<h4 id="_call_ext_arity_destination">call_ext Arity Destination</h4>
<div class="paragraph"><p>Does an external call to the function of arity <span class="monospaced">Arity</span> given by
 Destination. Destination is usually of the form <span class="monospaced">{extfunc, Module,
 Function, Arity}</span>. First count down the reductions and if needed do a
 context switch.</p></div>
</div>
<div class="sect3">
<h4 id="_call_ext_only_arity_destination">call_ext_only Arity Destination</h4>
<div class="paragraph"><p>Does a tail recursive external call to the function of arity <span class="monospaced">Arity</span> given by
 Destination. Destination is usually of the form <span class="monospaced">{extfunc, Module,
 Function, Arity}</span>. First count down the reductions and if needed do a
 context switch.</p></div>
</div>
<div class="sect3">
<h4 id="_call_ext_last_arity_destination_deallocate">call_ext_last Arity Destination Deallocate</h4>
<div class="paragraph"><p>Deallocate <span class="monospaced">Deallocate</span> words of stack, then do a tail recursive
external call to the function of arity <span class="monospaced">Arity</span> given by
Destination. Destination is usually of the form <span class="monospaced">{extfunc, Module,
Function, Arity}</span>. First count down the reductions and if needed do a
context switch.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_bif0_bif_reg_span_span_class_monospaced_bif1_lbl_bif_arg_reg_span_span_class_monospaced_bif2_lbl_bif_arg1_arg2_reg_span"><span class="monospaced">bif0 Bif Reg</span>, <span class="monospaced">bif1 Lbl Bif Arg Reg</span>, <span class="monospaced">bif2 Lbl Bif Arg1 Arg2 Reg</span></h4>
<div class="paragraph"><p>Call the bif <span class="monospaced">Bif</span> with the given arguments, and store the result in
<span class="monospaced">Reg</span>. If the bif fails jump to <span class="monospaced">Lbl</span>. No zero arity bif can fail an
thus those calls doesn&#8217;t take a fail label.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_gc_bif1_3_lbl_live_bif_arg1_3_reg_span"><span class="monospaced">gc_bif1-3 Lbl Live Bif Arg1-3 Reg</span></h4>
<div class="paragraph"><p>Call the bif  <span class="monospaced">Bif</span> with the given arguments,  and store the result in Reg.
If the bif fails jump to Lbl.
Store the arguments in x(Live),  x(Live+1) and x(live+2).</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_call_fun_arity_span"><span class="monospaced">call_fun Arity</span></h4>
<div class="paragraph"><p>The instruction <span class="monospaced">call_fun</span> assumes that the arguments are placed in
the argument registers and that the fun (the pointer to the closure)
is placed in the last argument register.</p></div>
<div class="paragraph"><p>That is, for a zero arity call, the closure is in x0. For a arity 1 call
x0 contains the argument and x1 contains the closure.</p></div>
</div>
<div class="sect3">
<h4 id="_apply_1">apply/1</h4>
<div class="paragraph"><p>TODO</p></div>
</div>
<div class="sect3">
<h4 id="_apply_last_2">apply_last/2</h4>
<div class="paragraph"><p>TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_stack_and_heap_management_2">Stack (and Heap) Management</h3>
<div class="paragraph"><p>The stack and the heap of an Erlang process on Beam share the same memory
area see <a href="#CH-Processes">[CH-Processes]</a> and <a href="#CH-Memory">[CH-Memory]</a> for a full discussion.
The stack grows toward lower addresses and the heap toward higher addresses.
Beam will do a garbage collection if more space than what is available is
needed on either the stack or the heap.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>A leaf function</strong>
</dt>
<dd>
<p>
A leaf function is a function which doesn&#8217;t call
                    any other function.
</p>
</dd>
<dt class="hdlist1">
<strong>A non leaf function</strong>
</dt>
<dd>
<p>
A non leaf function is a function which may call
                        another function.
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>These instructions are also used by non leaf functions for setting up
and tearing down the stack frame for the current instruction. That is,
on entry to the function the <em>continuation pointer</em> (CP) is saved on
the stack, and on exit it is read back from the stack.</p></div>
<div class="paragraph"><p>A function skeleton for a leaf function looks like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    ...
    return.</pre>
</div></div>
<div class="paragraph"><p>A function skeleton for a non leaf function looks like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>{function, Name, Arity, StartLabel}.
  {label,L1}.
    {func_info,{atom,Module},{atom,Name},Arity}.
  {label,L2}.
    {allocate,Need,Live}.

    ...
    call ...
    ...

    {deallocate,Need}.
    return.</pre>
</div></div>
<div class="sect3">
<h4 id="_span_class_monospaced_allocate_stackneed_live_span"><span class="monospaced">allocate StackNeed Live</span></h4>
<div class="paragraph"><p>Save the continuation pointer (CP) and allocate space for <span class="monospaced">StackNeed</span>
extra words on the stack. If a GC is needed during allocation save
<span class="monospaced">Live</span> number of X registers. E.g. if <span class="monospaced">Live</span> is 2 then registers X0
and X1 are saved.</p></div>
<div class="paragraph"><p>When allocating on the stack, the stack pointer (E) is decreased.</p></div>
<div class="exampleblock">
<div class="title">Example 1. Allocate 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content monospaced">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | ??? | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_allocate_heap_stackneed_heapneed_live_span"><span class="monospaced">allocate_heap StackNeed HeapNeed Live</span></h4>
<div class="paragraph"><p>Save the continuation pointer (CP) and allocate space for <span class="monospaced">StackNeed</span>
extra words on the stack. Ensure that there also is space for HeapNeed
words on the heap. If a GC is needed during allocation save <span class="monospaced">Live</span>
number of X registers.</p></div>
<div class="paragraph"><p>Note that the heap pointer (HTOP) is not changed until the actual heap
allocation takes place.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_allocate_zero_stackneed_live_span"><span class="monospaced">allocate_zero StackNeed Live</span></h4>
<div class="paragraph"><p>This instruction works the same way as allocate, but it also clears
out the allocated stack slots with NIL.</p></div>
<div class="exampleblock">
<div class="title">Example 2. allocate_zero 1 0</div>
<div class="content">
<div class="listingblock">
<div class="content monospaced">
<pre>       Before           After
         | xxx |            | xxx |
    E -&gt; | xxx |            | xxx |
         |     |            | NIL | caller save slot
           ...         E -&gt; | CP  |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_allocate_heap_zero_stackneed_heapneed_live_span"><span class="monospaced">allocate_heap_zero StackNeed HeapNeed Live</span></h4>
<div class="paragraph"><p>The allocate_heap_zero instruction works as the allocate_heap
instruction, but it also clears out the allocated stack slots
with NIL.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_test_heap_heapneed_live_span"><span class="monospaced">test_heap HeapNeed Live</span></h4>
<div class="paragraph"><p>The test_heap instruction ensures there is space for HeapNeed words on
the heap. If a GC is needed save Live number of X registers.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_init_n_span"><span class="monospaced">init N</span></h4>
<div class="paragraph"><p>The init instruction clears N stack words. By writing NIL to them.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_deallocate_n_span"><span class="monospaced">deallocate N</span></h4>
<div class="paragraph"><p>The deallocate instruction is the opposite of the allocate instruction,
it restores the continuation pointer and deallocates N+1 stack words.</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_return_span"><span class="monospaced">return</span></h4>
<div class="paragraph"><p>The return instructions jumps to the address in the continuation pointer (CP).</p></div>
</div>
<div class="sect3">
<h4 id="_span_class_monospaced_trim_n_remaining_span"><span class="monospaced">trim N Remaining</span></h4>
<div class="paragraph"><p>Removes N words of stack usage, while keeping the continuation pointer
on the top of the stack. (The argument Remaining is to the best of my
knowledge unused.)</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Trim 2
       Before           After
         | ??? |            | ??? |
         | xxx |       E -&gt; | CP  |
         | xxx |            | ... |
    E -&gt; | CP  |            | ... |
         |     |            | ... |
           ...                ...
 HTOP -&gt; |     |    HTOP -&gt; |     |
         | xxx |            | xxx |</pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_extracting_modifying">Moving, extracting, modifying.</h3>
<div class="sect3">
<h4 id="_move_source_destination">move Source Destination</h4>
<div class="paragraph"><p>Move the source Source (a litteral or a register) to the destination
register Destination.</p></div>
</div>
<div class="sect3">
<h4 id="_get_list_source_head_tail">get_list Source Head Tail</h4>
<div class="paragraph"><p>Get the head and tail (or car and cdr) parts of a list (a cons cell) from
Source and put them into the registers Head and Tail.</p></div>
</div>
<div class="sect3">
<h4 id="_get_tuple_element_source_element_destination">get_tuple_element Source Element Destination</h4>
<div class="paragraph"><p>Get element number Element from the tuple in Source and put it in the
destination register Destination.</p></div>
</div>
<div class="sect3">
<h4 id="_set_tuple_element_newelement_tuple_position">set_tuple_element NewElement Tuple Position</h4>
<div class="paragraph"><p>Update the element at postition Position of the tuple Tuple with the
new element NewElement.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_building_terms">Building terms.</h3>
<div class="sect3">
<h4 id="_put_list_3">put_list/3</h4>
<div class="paragraph"><p>TODO
==== put_tuple/2
TODO
==== put/1</p></div>
</div>
<div class="sect3">
<h4 id="_make_fun2_1">make_fun2/1</h4>
<div class="paragraph"><p>TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_binary_syntax">Binary Syntax</h3>
<div class="sect3">
<h4 id="_bs_put_integer_5">bs_put_integer/5</h4>
<div class="paragraph"><p>TODO
====  bs_put_binary/5
TODO
====  bs_put_float/5
TODO
====  bs_put_string/2
TODO
==== bs_init2/6
TODO
==== bs_add/5
TODO
==== bs_start_match2/5
TODO
==== bs_get_integer2/7
TODO
==== bs_get_float2/7
TODO
==== bs_get_binary2/7
TODO
==== bs_skip_bits2/5
TODO
==== bs_test_tail2/3
TODO
==== bs_save2/2
TODO
==== bs_restore2/2
TODO
==== bs_context_to_binary/1
TODO
==== bs_test_unit/3
TODO
==== bs_match_string/4
TODO
==== bs_init_writable/0
TODO
==== bs_append/8
TODO
==== bs_private_append/6
TODO
==== bs_init_bits/6
TODO
==== bs_get_utf8/5
TODO
==== bs_skip_utf8/4
TODO
==== bs_get_utf16/5
TODO
==== bs_skip_utf16/4
TODO
==== bs_get_utf32/5
TODO
==== bs_skip_utf32/4
TODO
==== bs_utf8_size/3
TODO
==== bs_put_utf8/3
TODO
==== bs_utf16_size/3
TODO
==== bs_put_utf16/3
TODO
==== bs_put_utf32/3
TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_floating_point_arithmetic">Floating Point Arithmetic</h3>
<div class="sect3">
<h4 id="_fclearerror_0">fclearerror/0</h4>
<div class="paragraph"><p>TODO
==== fcheckerror/1
TODO
==== fmove/2
TODO
==== fconv/2
TODO
==== fadd/4
TODO
==== fsub/4
TODO
==== fmul/4
TODO
==== fdiv/4
TODO
==== fnegate/3
TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_pattern_matching">Pattern Matching</h3>
<div class="sect3">
<h4 id="_select_val">select_val</h4>
<div class="paragraph"><p>TODO
==== select_arity_val
TODO
==== jump
TODO
=== Exception handling
==== catch/2
TODO
==== catch_end/1
TODO
==== badmatch/1
TODO
==== if_end/0
TODO
==== case_end/1
TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_meta_instructions">Meta instructions</h3>
<div class="sect3">
<h4 id="_on_load">on_load</h4>
<div class="paragraph"><p>TODO
==== line
TODO</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_generic_instructions">Generic Instructions</h3>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > Name </th>
<th class="tableblock halign-left valign-top" > Arity </th>
<th class="tableblock halign-left valign-top" > Op Code </th>
<th class="tableblock halign-left valign-top" > Spec </th>
<th class="tableblock halign-left valign-top" > Documentation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>allocate</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>allocate_heap</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Allocate space for StackNeed words on the stack and ensure there is       space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>allocate_heap_zero</strong> <em>StackNeed</em>, <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Allocate space for StackNeed words on the stack and HeapNeed words       on the heap. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>allocate_zero</strong> <em>StackNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Allocate space for StackNeed words on the stack. If a GC is needed       during allocation there are Live number of live X registers.       Clear the new stack words. (By writing NIL.)       Also save the continuation pointer (CP) on the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">112</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bif0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>bif0</strong> <em>Bif</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif and store the result in Reg.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>bif1</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bif2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>bif2</strong> <em>Lbl</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_add</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_append</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">134</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_bits_to_bytes</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(110)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_bits_to_bytes2</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(127)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">130</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_final</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(88)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_final2</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(126)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_get_binary</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(82)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">119</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_get_float</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(81)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_float2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">118</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_get_integer</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(80)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_integer2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">117</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">140</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_utf32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">142</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">138</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_init</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(87)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_init2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">109</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_init_bits</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">137</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_init_writable</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">133</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_match_string</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_need_buf</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(93)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_private_append</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">135</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_binary</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">90</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_float</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">91</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_integer</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">89</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">92</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">147</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_utf32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">148</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">145</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_restore</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(86)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_restore2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_save</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(85)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_save2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">122</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_skip_bits</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(83)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">120</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_skip_utf16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">141</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_skip_utf32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">143</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_skip_utf8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">139</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_start_match</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(79)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_start_match2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">116</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">bs_test_tail</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(84)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_tail2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">121</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">131</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">146</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">144</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the function at Label.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_ext</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_ext</strong> <em>Arity</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the function of arity Arity pointed to by Destination.       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_ext_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_ext_last</strong> <em>Arity</em>, <em>Destination</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Deallocate and do a tail call to function of arity Arity       pointed to by Destination.       Do not update the CP register.       Deallocate Deallocate words from the stack before the call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_ext_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">78</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_ext_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_fun</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">75</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_fun</strong> <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call a fun of arity Arity. Assume arguments in       registers x(0) to x(Arity-1) and that the fun is in x(Arity).       Save the next instruction as the return address in the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_last</strong> <em>Arity</em>, <em>Label</em>, <em>Deallocate</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Deallocate and do a tail recursive call to the function at Label.       Do not update the CP register.       Before the call deallocate Deallocate words of stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>call_only</strong> <em>Arity</em>, <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Do a tail recursive call to the function at Label.       Do not update the CP register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">74</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">62</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">63</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>deallocate</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Restore the continuation pointer (CP) from the stack and deallocate        N+1 words from the stack (the + 1 is for the CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fadd</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">98</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fcheckerror</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">95</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">94</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">97</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fdiv</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">101</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fmul</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fnegate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">102</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fsub</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">99</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">func_info</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>func_info</strong> <em>M</em>, <em>F</em>, <em>A</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Define a function M:F/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">gc_bif1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">124</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>gc_bif1</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif with the argument Arg, and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">gc_bif2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">125</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>gc_bif2</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif with the arguments Arg1 and Arg2,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">gc_bif3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">152</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>gc_bif3</strong> <em>Lbl</em>, <em>Live</em>, <em>Bif</em>, <em>Arg1</em>, <em>Arg2</em>, <em>Arg3</em>, <em>Reg</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Call the bif Bif with the arguments Arg1, Arg2 and Arg3,       and store the result in Reg.       On failure jump to Lbl.       Do a garbage collection if necessary to allocate space on the heap       for the result (saving Live number of X registers).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">65</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>get_list</strong> <em>Source</em>, <em>Head</em>, <em>Tail</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Get the head and tail (or car and cdr) parts of a list        (a cons cell) from Source and put them into the registers        Head and Tail.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">get_map_elements</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">158</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">get_tuple_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">66</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>get_tuple_element</strong> <em>Source</em>, <em>Element</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Get element number Element from the tuple in Source and put        it in the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">has_map_fields</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">157</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">73</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>init</strong> <em>N</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Clear the Nth stack word. (By writing NIL.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_band</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(33)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_bnot</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(38)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_bor</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(34)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_bsl</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(36)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_bsr</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(37)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_bxor</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(35)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_div</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(31)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">int_rem</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(32)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_atom</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_binary</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_binary</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a binary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_bitstr</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">129</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_bitstr</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a bit string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">114</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_boolean</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a Boolean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">is_constant</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(54)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_eq</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">41</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_eq</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_eq_exact</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">43</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_eq_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_float</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a float.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">77</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_function</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function (i.e. fun or closure).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">115</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_function2</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a       function of arity Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_ge</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_ge</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_integer</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not an integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">55</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons or nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_lt</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">39</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_lt</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is not less than Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_map</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">156</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_ne</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_ne</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is (numerically) equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_ne_exact</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_ne_exact</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arg2</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Compare two terms and jump to Lbl if Arg1 is exactly equal to Arg2.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_nil</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not nil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">56</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_nonempty_list</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a cons.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_number</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">49</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_pid</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a pid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">51</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_port</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a port.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_reference</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a reference.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_tagged_tuple</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">159</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_tagged_tuple</strong> <em>Lbl</em>, <em>Reg</em>, <em>N</em>, <em>Atom</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Reg and jumps to Lbl if it is not a tuple.       Test the arity of Reg and jumps to Lbl if it is not N.       Test the first element of the tuple and jumps to Lbl if it is not Atom.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">57</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>is_tuple</strong> <em>Lbl</em>, <em>Arg1</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the type of Arg1 and jump to Lbl if it is not a tuple.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>jump</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>label</strong> <em>Lbl</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Specify a module local label.       Label gives this code address a name (Lbl) and marks the start of       a basic block.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">153</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">loop_rec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>loop_rec</strong> <em>Label</em>, <em>Source</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Loop over the message queue, if it is empty jump to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>loop_rec_end</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Advance the save pointer to the next message and jump back to Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">m_div</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(30)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">m_minus</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(28)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">m_plus</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(27)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">m_times</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(29)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">make_fun</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(76)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">make_fun2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">103</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>move</strong> <em>Source</em>, <em>Destination</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Move the source Source (a literal or a register) to       the destination register Destination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">on_load</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">149</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">71</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">69</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">put_literal</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(128)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put_map_assoc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">154</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put_map_exact</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">155</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="line-through">put_string</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">(68)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>DEPRECATED</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put_tuple</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">70</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">108</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">150</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>recv_mark</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Save the end of the message queue and the address of        the label Label so that a recv_set instruction can start        scanning the inbox from this position.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">recv_set</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">151</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>recv_set</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Check that the saved mark points to Label and set the       save pointer in the message queue to the last position       of the message queue saved by the recv_mark instruction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>remove_message</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Unlink the current message from the message queue and store a        pointer to the message in x(0). Remove any timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>return</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Return to the address in the continuation pointer (CP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>select_tuple_arity</strong> <em>Tuple</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Check the arity of the tuple Tuple and jump to the corresponding       destination label, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">select_val</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">59</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>select_val</strong> <em>Arg</em>, <em>FailLabel</em>, <em>Destinations</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Jump to the destination label corresponding to Arg       in the Destinations list, if no arity matches, jump to FailLabel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>send</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Send argument in x(1) as a message to the destination process in x(0).        The message in x(1) ends up as the result of the send in x(0).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">67</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>set_tuple_element</strong> <em>NewElement</em>, <em>Tuple</em>, <em>Position</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Update the element at position Position of the tuple Tuple        with the new element NewElement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>test_arity</strong> <em>Lbl</em>, <em>Arg1</em>, <em>Arity</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Test the arity of (the tuple in) Arg1 and jump  to Lbl if it is not equal to Arity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>test_heap</strong> <em>HeapNeed</em>, <em>Live</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Ensure there is space for HeapNeed words on the heap. If a GC is needed       save Live number of X registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>timeout</strong></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Reset the save point of the mailbox and clear the timeout flag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">trim</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">136</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>trim</strong> <em>N</em>, <em>Remaining</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Reduce the stack usage by N words,       keeping the CP on the top of the stack.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">104</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try_case</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">106</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">107</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">105</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>wait</strong> <em>Label</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Suspend the processes and set the entry point to the beginning of the        receive loop at Label.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wait_timeout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><strong>wait_timeout</strong> <em>Lable</em>, <em>Time</em></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Sets up a timeout of Time milliseconds and saves the address of the        following instruction as the entry point if the timeout triggers.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_specific_instructions">Specific Instructions</h3>
<div class="paragraph"><p>Argument types</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Type </th>
<th class="tableblock halign-left valign-top" > Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A term, e.g. <span class="monospaced">[{foo,bar}]</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">An integer e.g. <span class="monospaced">42</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A register, e.g. <span class="monospaced">5</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A stack slot, e.g. <span class="monospaced">1</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A constant (atom,nil,small int) // Pid?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">An atom, e.g. <em>foo</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A label, i.e. a code address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Either a literal, a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Either a register or a stack slot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A register R0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A positive (unsigned) integer literal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">An optional code label</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A reference to an export table entry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A floating-point register</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>List of all BEAM Instructions</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Instruction        </th>
<th class="tableblock halign-left valign-top" > Arguments </th>
<th class="tableblock halign-left valign-top" > Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">deallocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">init</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">init2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">init3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y y y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_trim</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">test_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_zero</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_heap_zero</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">r f c f c f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x f c f c f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_val2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y f c f c f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_jump_on_val</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy f I I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_jump_on_val_zero</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">r f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">r f A f A f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x f A f A f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_select_tuple_arity2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y f A f A f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_func_info</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I a a I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">return</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">get_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy rxy rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">catch</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">catch_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">try_case_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set_tuple_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s d P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_get_tuple_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy P rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_number</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">jump</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">case_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">badmatch</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">if_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">raise</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">badarg</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">system_limit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_jump</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f ncxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_x1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_x2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x y x y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">y x y x</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x x x x</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxync rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">recv_mark</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_recv_set</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">remove_message</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">timeout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">timeout_locked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_loop_rec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">loop_rec_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wait</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wait_locked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wait_unlocked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_timeout</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_timeout_locked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_error</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_wait_error_locked</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_eq_exact_immed</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_ne_exact_immed</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_eq_exact_literal</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_ne_exact_literal</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_eq_exact</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_ne_exact</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_lt</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_ge</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_eq</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_is_ne</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_put_tuple</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">put_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fetch</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_return</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xcn r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_deallocate_return</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xycn r Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">deallocate_return</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">test_heap_1_put_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_tuple_of_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_tuple</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">test_arity</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">extract_next_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">extract_next_element2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">extract_next_element3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_integer_allocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_integer</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nonempty_list_allocate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nonempty_list_test_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f r I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nonempty_list</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_atom</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_float</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_nil</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_bitstring</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_reference</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_pid</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_port</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_boolean</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_function2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f s s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allocate_init</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">t I y</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">apply</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">apply_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply_fun</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply_fun_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_apply_fun_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_hibernate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_bif0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_bif1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_bif2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">call_bif3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_get</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">self</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">node</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fast_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_element</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy j s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bif1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f b s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bif1_body</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">b s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bif2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f b d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bif2_body</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">b d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">c r f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f P c r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f c r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_call</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xy r f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_call_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">xy r f Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">move_call_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">x r f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_ext</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_ext_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_ext_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call_ext</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">c r e</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call_ext_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e P c r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_move_call_ext_only</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">e c r</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_fun</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_call_fun_last</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_make_fun</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I t</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">is_function</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_start_match2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy f I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_save2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_restore2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_match_string</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f I I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer_small_imm</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx I f I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer_imm</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx I I f I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer_8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer_16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_integer_32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_binary_imm2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_binary2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_binary_all2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_binary_all_reuse</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_float2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I s I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_skip_bits2_imm2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_skip_bits2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx rxy I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_skip_bits_all2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_zero_tail2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_tail_imm2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_unit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_test_unit8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">f rx</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_context_to_binary</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_utf8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_get_utf16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rx f I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_validate_unicode_retract</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_fail</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_fail_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_heap_bin</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_heap_bin_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_bits_fail</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_bits_fail_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_bits</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_bits_heap</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_add</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_init_writable</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_append</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_private_append</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_integer</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_integer_imm</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_utf8_size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_utf16_size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">s d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_put_utf8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_put_utf16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bs_validate_unicode</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_float</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_float_imm</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_binary</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_binary_imm</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I s</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_new_bs_put_binary_all</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bs_put_string</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fmove</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">qdl ld</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fconv</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fadd</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fsub</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fmul</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fdiv</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fnegate</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">l l l</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_fcheckerror</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">fclearerror</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_increment</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rxy I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_plus</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_minus</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_times</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_m_div</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_int_div</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_rem</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bsl</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bsr</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_band</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bor</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_bxor</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_int_bnot</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j s I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_gc_bif1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_gc_bif2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">i_gc_bif3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">j I s I d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">int_code_end</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">label</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">line</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="AP-listings">Appendix B: Full Code Listings</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">beamfile</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">/</span><span style="color: #993399">1</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read</span></span>(<span style="color: #009900">Filename</span>) <span style="color: #990000">-&gt;</span>
    {<span style="color: #FF6600">ok</span>, <span style="color: #009900">File</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">file:read_file</span></span>(<span style="color: #009900">Filename</span>),
    <span style="color: #990000">&lt;&lt;</span><span style="color: #FF0000">"FOR1"</span>,
      <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
      <span style="color: #FF0000">"BEAM"</span>,
      <span style="color: #009900">Chunks</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">File</span>,
    {<span style="color: #009900">Size</span>, <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Chunks</span>, []),[])}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>, <span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Tail</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">%% Align each chunk on even 4 bytes</span></span>
    <span style="color: #009900">ChunkLength</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">Size</span>),
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Chunk</span><span style="color: #990000">:</span><span style="color: #009900">ChunkLength</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Tail</span>,
    <span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #009900">Rest</span>, [{[<span style="color: #009900">N</span>,<span style="color: #009900">A</span>,<span style="color: #009900">M</span>,<span style="color: #009900">E</span>], <span style="color: #009900">Size</span>, <span style="color: #009900">Chunk</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">read_chunks</span></span>(<span style="color: #990000">&lt;&lt;&gt;&gt;</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Acc</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">align_by_four</span></span>(<span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span> (<span style="color: #993399">4</span> <span style="color: #990000">*</span> ((<span style="color: #009900">N</span><span style="color: #990000">+</span><span style="color: #993399">3</span>) <span style="font-weight: bold"><span style="color: #0000FF">div</span></span> <span style="color: #993399">4</span>))<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Atom"</span>, <span style="color: #009900">_Size</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_Numberofatoms</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Atoms</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">atoms</span>,<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">Atoms</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"ExpT"</span>, <span style="color: #009900">_Size</span>,
              <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_Numberofentries</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Exports</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>}
             | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">exports</span>,<span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #009900">Exports</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"ImpT"</span>, <span style="color: #009900">_Size</span>,
              <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_Numberofentries</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Imports</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>}
             | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">imports</span>,<span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #009900">Imports</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Code"</span>, <span style="color: #009900">Size</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">SubSize</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Chunk</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Info</span><span style="color: #990000">:</span><span style="color: #009900">SubSize</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Code</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Chunk</span>,
    <span style="color: #009900">OpcodeSize</span> <span style="color: #990000">=</span> <span style="color: #009900">Size</span> <span style="color: #990000">-</span> <span style="color: #009900">SubSize</span> <span style="color: #990000">-</span> <span style="color: #993399">8</span>, <span style="font-style: italic"><span style="color: #9A1900">%% 8 is size of CunkSize &amp; SubSize</span></span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">OpCodes</span><span style="color: #990000">:</span><span style="color: #009900">OpcodeSize</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">_Align</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Code</span>,
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">code</span>,<span style="font-weight: bold"><span style="color: #000000">parse_code_info</span></span>(<span style="color: #009900">Info</span>), <span style="color: #009900">OpCodes</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"StrT"</span>, <span style="color: #009900">_Size</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Strings</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">strings</span>,<span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="color: #009900">Strings</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Attr"</span>, <span style="color: #009900">Size</span>, <span style="color: #009900">Chunk</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Bin</span><span style="color: #990000">:</span><span style="color: #009900">Size</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">_Pad</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Chunk</span>,
    <span style="color: #009900">Attribs</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">binary_to_term</span></span>(<span style="color: #009900">Bin</span>),
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">attributes</span>,<span style="color: #009900">Attribs</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"CInf"</span>, <span style="color: #009900">Size</span>, <span style="color: #009900">Chunk</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Bin</span><span style="color: #990000">:</span><span style="color: #009900">Size</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">_Pad</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">Chunk</span>,
    <span style="color: #009900">CInfo</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">binary_to_term</span></span>(<span style="color: #009900">Bin</span>),
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">compile_info</span>,<span style="color: #009900">CInfo</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"LocT"</span>, <span style="color: #009900">_Size</span>,
              <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_Numberofentries</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Locals</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>}
             | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">locals</span>,<span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #009900">Locals</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"LitT"</span>, <span style="color: #009900">_ChunkSize</span>,
              <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_CompressedTableSize</span><span style="color: #990000">:</span><span style="color: #993399">32</span>, <span style="color: #009900">Compressed</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>}
             | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">_NumLiterals</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">Table</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">zlib:uncompress</span></span>(<span style="color: #009900">Compressed</span>),
    <span style="color: #009900">Literals</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">parse_literals</span></span>(<span style="color: #009900">Table</span>),
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">literals</span>,<span style="color: #009900">Literals</span>}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Abst"</span>, <span style="color: #009900">_ChunkSize</span>, <span style="color: #990000">&lt;&lt;&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,<span style="color: #009900">Acc</span>);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Abst"</span>, <span style="color: #009900">_ChunkSize</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">AbstractCode</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">abstract_code</span>,<span style="font-weight: bold"><span style="color: #000080">binary_to_term</span></span>(<span style="color: #009900">AbstractCode</span>)}|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([{<span style="color: #FF0000">"Line"</span>, <span style="color: #009900">_ChunkSize</span>, <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">LineTable</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>} | <span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Ver</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">Bits</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">NumLineInstrs</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">NumLines</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">NumFnames</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,
      <span style="color: #009900">Lines</span><span style="color: #990000">:</span><span style="color: #009900">NumLines</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>,<span style="color: #009900">Fnames</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span> <span style="color: #990000">=</span> <span style="color: #009900">LineTable</span>,
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>,[{<span style="color: #FF6600">line</span>,
                        [{<span style="color: #FF6600">version</span>,<span style="color: #009900">Ver</span>},
                         {<span style="color: #FF6600">bits</span>,<span style="color: #009900">Bits</span>},
                         {<span style="color: #FF6600">num_line_instrunctions</span>,<span style="color: #009900">NumLineInstrs</span>},
                         {<span style="color: #FF6600">lines</span>,<span style="font-weight: bold"><span style="color: #000000">decode_lineinfo</span></span>(<span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="color: #009900">Lines</span>),<span style="color: #993399">0</span>)},
                         {<span style="color: #FF6600">function_names</span>,<span style="color: #009900">Fnames</span>}]}|<span style="color: #009900">Acc</span>]);


<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([<span style="color: #009900">Chunk</span>|<span style="color: #009900">Rest</span>], <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="font-style: italic"><span style="color: #9A1900">%% Not yet implemented chunk</span></span>
    <span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>(<span style="color: #009900">Rest</span>, [<span style="color: #009900">Chunk</span>|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">parse_chunks</span></span>([],<span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span> <span style="color: #009900">Acc</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Atomlength</span>, <span style="color: #009900">Atom</span><span style="color: #990000">:</span><span style="color: #009900">Atomlength</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>, <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #009900">Atomlength</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">-&gt;</span>
    [<span style="font-weight: bold"><span style="color: #000080">list_to_atom</span></span>(<span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="color: #009900">Atom</span>)) | <span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">parse_atoms</span></span>(<span style="color: #009900">_Alignment</span>) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Function</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                <span style="color: #009900">Arity</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                <span style="color: #009900">Label</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>) <span style="color: #990000">-&gt;</span>
    [{<span style="color: #009900">Function</span>, <span style="color: #009900">Arity</span>, <span style="color: #009900">Label</span>} | <span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #009900">Rest</span>)];
<span style="font-weight: bold"><span style="color: #000000">parse_table</span></span>(<span style="color: #990000">&lt;&lt;&gt;&gt;</span>) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">parse_code_info</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Instructionset</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                  <span style="color: #009900">OpcodeMax</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                  <span style="color: #009900">NumberOfLabels</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                  <span style="color: #009900">NumberOfFunctions</span><span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000000">32</span></span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">integer</span></span>,
                  <span style="color: #009900">Rest</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>) <span style="color: #990000">-&gt;</span>
    [{<span style="color: #FF6600">instructionset</span>, <span style="color: #009900">Instructionset</span>},
     {<span style="color: #FF6600">opcodemax</span>, <span style="color: #009900">OpcodeMax</span>},
     {<span style="color: #FF6600">numberoflabels</span>, <span style="color: #009900">NumberOfLabels</span>},
     {<span style="color: #FF6600">numberofFunctions</span>, <span style="color: #009900">NumberOfFunctions</span>} |
     <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">Rest</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
         <span style="color: #990000">&lt;&lt;&gt;&gt;</span> <span style="color: #990000">-&gt;</span> [];
         <span style="color: #990000">_</span> <span style="color: #990000">-&gt;</span> [{<span style="color: #FF6600">newinfo</span>, <span style="color: #009900">Rest</span>}]
     <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>]<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_literals</span></span>(<span style="color: #990000">&lt;&lt;</span><span style="color: #009900">Size</span><span style="color: #990000">:</span><span style="color: #993399">32</span>,<span style="color: #009900">Literal</span><span style="color: #990000">:</span><span style="color: #009900">Size</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span>,<span style="color: #009900">Tail</span><span style="color: #990000">/</span><span style="font-weight: bold"><span style="color: #000080">binary</span></span><span style="color: #990000">&gt;&gt;</span>) <span style="color: #990000">-&gt;</span>
    [<span style="font-weight: bold"><span style="color: #000080">binary_to_term</span></span>(<span style="color: #009900">Literal</span>) | <span style="font-weight: bold"><span style="color: #000000">parse_literals</span></span>(<span style="color: #009900">Tail</span>)];
<span style="font-weight: bold"><span style="color: #000000">parse_literals</span></span>(<span style="color: #990000">&lt;&lt;&gt;&gt;</span>) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>



<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #FF6600">tag_i</span>, <span style="color: #993399">1</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #FF6600">tag_a</span>, <span style="color: #993399">2</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">decode_tag</span></span>(<span style="font-weight: bold"><span style="color: #000080">?tag_i</span></span>) <span style="color: #990000">-&gt;</span> <span style="color: #FF6600">i</span>;
<span style="font-weight: bold"><span style="color: #000000">decode_tag</span></span>(<span style="font-weight: bold"><span style="color: #000080">?tag_a</span></span>) <span style="color: #990000">-&gt;</span> <span style="color: #FF6600">a</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag</span>,<span style="color: #009900">B</span>,<span style="color: #009900">Bs</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> (<span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">16#08</span>) <span style="color: #990000">=:=</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">%% N &lt; 16 = 4 bits, NNNN:0:TTT</span></span>
    <span style="color: #009900">N</span> <span style="color: #990000">=</span> <span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">bsr</span></span> <span style="color: #993399">4</span>,
    {{<span style="color: #009900">Tag</span>,<span style="color: #009900">N</span>},<span style="color: #009900">Bs</span>};
<span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag</span>,<span style="color: #009900">B</span>,[]) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> (<span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">16#10</span>) <span style="color: #990000">=:=</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN</span></span>
    <span style="color: #009900">Val0</span> <span style="color: #990000">=</span> <span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">2#11100000</span>,
    <span style="color: #009900">N</span> <span style="color: #990000">=</span> (<span style="color: #009900">Val0</span> <span style="font-weight: bold"><span style="color: #0000FF">bsl</span></span> <span style="color: #993399">3</span>),
    {{<span style="color: #009900">Tag</span>,<span style="color: #009900">N</span>},[]};
<span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag</span>,<span style="color: #009900">B</span>,<span style="color: #009900">Bs</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> (<span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">16#10</span>) <span style="color: #990000">=:=</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
    <span style="font-style: italic"><span style="color: #9A1900">%% N &lt; 2048 = 11 bits = 3:8 bits, NNN:01:TTT, NNNNNNNN</span></span>
    [<span style="color: #009900">B1</span>|<span style="color: #009900">Bs1</span>] <span style="color: #990000">=</span> <span style="color: #009900">Bs</span>,
    <span style="color: #009900">Val0</span> <span style="color: #990000">=</span> <span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">2#11100000</span>,
    <span style="color: #009900">N</span> <span style="color: #990000">=</span> (<span style="color: #009900">Val0</span> <span style="font-weight: bold"><span style="color: #0000FF">bsl</span></span> <span style="color: #993399">3</span>) <span style="font-weight: bold"><span style="color: #0000FF">bor</span></span> <span style="color: #009900">B1</span>,
    {{<span style="color: #009900">Tag</span>,<span style="color: #009900">N</span>},<span style="color: #009900">Bs1</span>};
<span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag</span>,<span style="color: #009900">B</span>,<span style="color: #009900">Bs</span>) <span style="color: #990000">-&gt;</span>
    {<span style="color: #009900">Len</span>,<span style="color: #009900">Bs1</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">decode_int_length</span></span>(<span style="color: #009900">B</span>,<span style="color: #009900">Bs</span>),
    {<span style="color: #009900">IntBs</span>,<span style="color: #009900">RemBs</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #009900">Len</span>,<span style="color: #009900">Bs1</span>),
    <span style="color: #009900">N</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>(<span style="color: #009900">IntBs</span>),
    {{<span style="color: #009900">Tag</span>,<span style="color: #009900">N</span>},<span style="color: #009900">RemBs</span>}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">decode_lineinfo</span></span>([<span style="color: #009900">B</span>|<span style="color: #009900">Bs</span>], <span style="color: #009900">F</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">Tag</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">decode_tag</span></span>(<span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">2#111</span>),
    {{<span style="color: #009900">Tag</span>,<span style="color: #009900">Num</span>},<span style="color: #009900">RemBs</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag</span>,<span style="color: #009900">B</span>,<span style="color: #009900">Bs</span>),
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">Tag</span> <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
        <span style="color: #FF6600">i</span> <span style="color: #990000">-&gt;</span>
            [{<span style="color: #009900">F</span>, <span style="color: #009900">Num</span>} | <span style="font-weight: bold"><span style="color: #000000">decode_lineinfo</span></span>(<span style="color: #009900">RemBs</span>, <span style="color: #009900">F</span>)];
        <span style="color: #FF6600">a</span> <span style="color: #990000">-&gt;</span>
            [<span style="color: #009900">B2</span>|<span style="color: #009900">Bs2</span>] <span style="color: #990000">=</span> <span style="color: #009900">RemBs</span>,
            <span style="color: #009900">Tag2</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">decode_tag</span></span>(<span style="color: #009900">B2</span> <span style="font-weight: bold"><span style="color: #0000FF">band</span></span> <span style="color: #993399">2#111</span>),
            {{<span style="color: #009900">Tag2</span>,<span style="color: #009900">Num2</span>},<span style="color: #009900">RemBs2</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">decode_int</span></span>(<span style="color: #009900">Tag2</span>,<span style="color: #009900">B2</span>,<span style="color: #009900">Bs2</span>),
            [{<span style="color: #009900">Num</span>, <span style="color: #009900">Num2</span>} | <span style="font-weight: bold"><span style="color: #000000">decode_lineinfo</span></span>(<span style="color: #009900">RemBs2</span>, <span style="color: #009900">Num2</span>)]
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>;
<span style="font-weight: bold"><span style="color: #000000">decode_lineinfo</span></span>([],<span style="color: #990000">_</span>) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">decode_int_length</span></span>(<span style="color: #009900">B</span>, <span style="color: #009900">Bs</span>) <span style="color: #990000">-&gt;</span>
    {<span style="color: #009900">B</span> <span style="font-weight: bold"><span style="color: #0000FF">bsr</span></span> <span style="color: #993399">5</span> <span style="color: #990000">+</span> <span style="color: #993399">2</span>, <span style="color: #009900">Bs</span>}<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #009900">N</span>, <span style="color: #009900">Bs</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #009900">N</span>, <span style="color: #009900">Bs</span>, [])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #009900">N</span>, [<span style="color: #009900">B</span>|<span style="color: #009900">Bs</span>], <span style="color: #009900">Acc</span>) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #009900">N</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span> <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #009900">N</span><span style="color: #990000">-</span><span style="color: #993399">1</span>, <span style="color: #009900">Bs</span>, [<span style="color: #009900">B</span>|<span style="color: #009900">Acc</span>]);
<span style="font-weight: bold"><span style="color: #000000">take_bytes</span></span>(<span style="color: #993399">0</span>, <span style="color: #009900">Bs</span>, <span style="color: #009900">Acc</span>) <span style="color: #990000">-&gt;</span>
    {<span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Acc</span>), <span style="color: #009900">Bs</span>}<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>(<span style="color: #009900">Bs</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>(<span style="color: #009900">Bs</span>, <span style="color: #993399">0</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>([<span style="color: #009900">B</span>|<span style="color: #009900">Bs</span>], <span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>(<span style="color: #009900">Bs</span>, (<span style="color: #009900">N</span> <span style="font-weight: bold"><span style="color: #0000FF">bsl</span></span> <span style="color: #993399">8</span>) <span style="font-weight: bold"><span style="color: #0000FF">bor</span></span> <span style="color: #009900">B</span>);
<span style="font-weight: bold"><span style="color: #000000">build_arg</span></span>([], <span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">N</span><span style="color: #990000">.</span>

</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">world</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">hello</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-include</span></span>(<span style="color: #FF0000">"world.hrl"</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">hello</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000080">?GREETING</span></span><span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">json_parser</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span>(<span style="color: #009900">AST</span>, <span style="color: #009900">_Options</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">AST</span>, [])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">FUNCTION</span>(<span style="color: #009900">Clauses</span>), {<span style="font-weight: bold"><span style="color: #000080">function</span></span>, <span style="color: #009900">Label</span>, <span style="color: #009900">Name</span>, <span style="color: #009900">Arity</span>, <span style="color: #009900">Clauses</span>})<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We are only interested in code inside functions.</span></span>
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([<span style="font-weight: bold"><span style="color: #000080">?FUNCTION</span></span>(<span style="color: #009900">Clauses</span>) | <span style="color: #009900">Elements</span>], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">Elements</span>, [<span style="font-weight: bold"><span style="color: #000080">?FUNCTION</span></span>(<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>(<span style="color: #009900">Clauses</span>)) | <span style="color: #009900">Res</span>]);
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([<span style="color: #009900">Other</span>|<span style="color: #009900">Elements</span>], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">json</span></span>(<span style="color: #009900">Elements</span>, [<span style="color: #009900">Other</span> | <span style="color: #009900">Res</span>]);
<span style="font-weight: bold"><span style="color: #000000">json</span></span>([], <span style="color: #009900">Res</span>) <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">lists:reverse</span></span>(<span style="color: #009900">Res</span>)<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We are interested in the code in the body of a function.</span></span>
<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>([{<span style="color: #FF6600">clause</span>, <span style="color: #009900">CLine</span>, <span style="color: #009900">A1</span>, <span style="color: #009900">A2</span>, <span style="color: #009900">Code</span>} | <span style="color: #009900">Clauses</span>]) <span style="color: #990000">-&gt;</span>
    [{<span style="color: #FF6600">clause</span>, <span style="color: #009900">CLine</span>, <span style="color: #009900">A1</span>, <span style="color: #009900">A2</span>, <span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">Code</span>)} | <span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>(<span style="color: #009900">Clauses</span>)];
<span style="font-weight: bold"><span style="color: #000000">json_clauses</span></span>([]) <span style="color: #990000">-&gt;</span> []<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">JSON</span>(<span style="color: #009900">Json</span>), {<span style="color: #FF6600">bin</span>, <span style="color: #990000">_</span>, [{<span style="color: #FF6600">bin_element</span>
                                          , <span style="color: #990000">_</span>
                                          , {<span style="color: #FF6600">tuple</span>, <span style="color: #990000">_</span>, [<span style="color: #009900">Json</span>]}
                                          , <span style="color: #990000">_</span>
                                          , <span style="color: #990000">_</span>}]})<span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% We look for: &lt;&lt;"json"&gt;&gt; = Json-Term</span></span>
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>([])                     <span style="color: #990000">-&gt;</span> [];
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>([<span style="font-weight: bold"><span style="color: #000080">?JSON</span></span>(<span style="color: #009900">Json</span>)|<span style="color: #009900">MoreCode</span>]) <span style="color: #990000">-&gt;</span> [<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Json</span>) | <span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">MoreCode</span>)];
<span style="font-weight: bold"><span style="color: #000000">json_code</span></span>(<span style="color: #009900">Code</span>)                   <span style="color: #990000">-&gt;</span> <span style="color: #009900">Code</span><span style="color: #990000">.</span>

<span style="font-style: italic"><span style="color: #9A1900">%% Json Object -&gt; [{}] | [{Lable, Term}]</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">tuple</span>,<span style="color: #009900">Line</span>,[]})            <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, {<span style="color: #FF6600">tuple</span>, <span style="color: #009900">Line</span>, []}};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">tuple</span>,<span style="color: #009900">Line</span>,<span style="color: #009900">Fields</span>})        <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>(<span style="color: #009900">Fields</span>,<span style="color: #009900">Line</span>);
<span style="font-style: italic"><span style="color: #9A1900">%% Json Array -&gt; List</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>})   <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Head</span>),
                                                       <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Tail</span>)};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">nil</span>, <span style="color: #009900">Line</span>})                <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">nil</span>, <span style="color: #009900">Line</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json String -&gt; &lt;</span></span><span style="font-weight: bold"><span style="color: #0000FF">&lt;String&gt;</span></span><span style="font-style: italic"><span style="color: #9A1900">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">string</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">String</span>})     <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">String</span>, <span style="color: #009900">Line</span>);
<span style="font-style: italic"><span style="color: #9A1900">%% Json Integer -&gt; Intger</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Integer</span>})   <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Integer</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Float -&gt; Float</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">float</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Float</span>})       <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">float</span></span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Float</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Constant -&gt; true | false | null</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">true</span>})         <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">true</span>};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">false</span>})        <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #000080">false</span>};
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">null</span>})         <span style="color: #990000">-&gt;</span> {<span style="font-weight: bold"><span style="color: #000080">atom</span></span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">null</span>};

<span style="font-style: italic"><span style="color: #9A1900">%% Variables, should contain Erlang encoded Json</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">var</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Var</span>})         <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">var</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Var</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Json Negative Integer or Float</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">Line</span>, <span style="color: #FF6600">'-'</span>, {<span style="color: #009900">Type</span>, <span style="color: #990000">_</span>, <span style="color: #009900">N</span>}}) <span style="font-weight: bold"><span style="color: #0000FF">when</span></span> <span style="color: #009900">Type</span> <span style="color: #990000">=:=</span> <span style="font-weight: bold"><span style="color: #000080">integer</span></span>
                                               ; <span style="color: #009900">Type</span> <span style="color: #990000">=:=</span> <span style="font-weight: bold"><span style="color: #000080">float</span></span> <span style="color: #990000">-&gt;</span>
                                          {<span style="color: #009900">Type</span>, <span style="color: #009900">Line</span>, <span style="font-weight: bold"><span style="color: #000080">-N</span></span>}<span style="color: #990000">.</span>
<span style="font-style: italic"><span style="color: #9A1900">%% parse_json(Code)                  -&gt; io:format("Code: ~p~n",[Code]), Code.</span></span>

<span style="font-weight: bold"><span style="color: #000080">-define</span></span>(<span style="color: #009900">FIELD</span>(<span style="color: #009900">Lable</span>, <span style="color: #009900">Code</span>), {<span style="color: #FF6600">remote</span>, <span style="color: #009900">L</span>, {<span style="color: #FF6600">string</span>, <span style="color: #990000">_</span>, <span style="color: #009900">Label</span>}, <span style="color: #009900">Code</span>})<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>([], <span style="color: #009900">L</span>) <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">nil</span>, <span style="color: #009900">L</span>};
<span style="font-style: italic"><span style="color: #9A1900">%% Label : Json-Term  --&gt; [{&lt;</span></span><span style="font-weight: bold"><span style="color: #0000FF">&lt;Label&gt;</span></span><span style="font-style: italic"><span style="color: #9A1900">&gt;, Term} | Rest]</span></span>
<span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>([<span style="font-weight: bold"><span style="color: #000080">?FIELD</span></span>(<span style="color: #009900">Lable</span>, <span style="color: #009900">Code</span>) | <span style="color: #009900">Rest</span>], <span style="color: #990000">_</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">cons</span></span>(<span style="font-weight: bold"><span style="color: #000000">tuple</span></span>(<span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">Label</span>, <span style="color: #009900">L</span>), <span style="font-weight: bold"><span style="color: #000000">parse_json</span></span>(<span style="color: #009900">Code</span>), <span style="color: #009900">L</span>)
         , <span style="font-weight: bold"><span style="color: #000000">parse_json_fields</span></span>(<span style="color: #009900">Rest</span>, <span style="color: #009900">L</span>)
         , <span style="color: #009900">L</span>)<span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">tuple</span></span>(<span style="color: #009900">E1</span>, <span style="color: #009900">E2</span>, <span style="color: #009900">Line</span>)    <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">tuple</span>, <span style="color: #009900">Line</span>, [<span style="color: #009900">E1</span>, <span style="color: #009900">E2</span>]}<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">cons</span></span>(<span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>, <span style="color: #009900">Line</span>) <span style="color: #990000">-&gt;</span> {<span style="color: #FF6600">cons</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">Head</span>, <span style="color: #009900">Tail</span>}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">str_to_bin</span></span>(<span style="color: #009900">String</span>, <span style="color: #009900">Line</span>) <span style="color: #990000">-&gt;</span>
    {<span style="color: #FF6600">bin</span>
     , <span style="color: #009900">Line</span>
     , [{<span style="color: #FF6600">bin_element</span>
         , <span style="color: #009900">Line</span>
         , {<span style="color: #FF6600">string</span>, <span style="color: #009900">Line</span>, <span style="color: #009900">String</span>}
         , <span style="color: #FF6600">default</span>
         , <span style="color: #FF6600">default</span>
        }
       ]
    }<span style="color: #990000">.</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">json_test</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-compile</span></span>({<span style="font-weight: bold"><span style="color: #000080">parse_transform</span></span>, <span style="color: #FF6600">json_parser</span>})<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">/</span><span style="color: #993399">1</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span>(<span style="color: #009900">V</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #990000">&lt;&lt;</span>{{
      <span style="color: #FF0000">"name"</span>  <span style="color: #990000">:</span> <span style="color: #FF0000">"Jack (\"Bee\") Nimble"</span>,
      <span style="color: #FF0000">"format"</span><span style="color: #990000">:</span> {
                  <span style="color: #FF0000">"type"</span>      <span style="color: #990000">:</span> <span style="color: #FF0000">"rect"</span>,
                  <span style="color: #FF0000">"widths"</span>     <span style="color: #990000">:</span> [<span style="color: #993399">1920</span>,<span style="color: #993399">1600</span>],
                  <span style="color: #FF0000">"height"</span>    <span style="color: #990000">:</span> (<span style="color: #990000">-</span><span style="color: #993399">1080</span>),
                  <span style="color: #FF0000">"interlace"</span> <span style="color: #990000">:</span> <span style="color: #000080">false</span>,
                  <span style="color: #FF0000">"frame rate"</span><span style="color: #990000">:</span> <span style="color: #009900">V</span>
                }
     }}<span style="color: #990000">&gt;&gt;.</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">stack_machine_compiler</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">compile</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">compile</span></span>(<span style="color: #009900">Expression</span>, <span style="color: #009900">FileName</span>) <span style="color: #990000">-&gt;</span>
    [<span style="color: #009900">ParseTree</span>] <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                          <span style="font-weight: bold"><span style="color: #000000">erl_parse:parse_exprs</span></span>(
                            <span style="font-weight: bold"><span style="color: #000080">element</span></span>(<span style="color: #993399">2</span>,
                                    <span style="font-weight: bold"><span style="color: #000000">erl_scan:string</span></span>(<span style="color: #009900">Expression</span>)))),
    <span style="font-weight: bold"><span style="color: #000000">file:write_file</span></span>(<span style="color: #009900">FileName</span>, <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">ParseTree</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">stop</span></span>()])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'+'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">add</span></span>()];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="color: #FF6600">op</span>, <span style="color: #009900">_Line</span>, <span style="color: #FF6600">'*'</span>, <span style="color: #009900">Arg1</span>, <span style="color: #009900">Arg2</span>}) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg1</span>) <span style="color: #990000">++</span> <span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>(<span style="color: #009900">Arg2</span>) <span style="color: #990000">++</span> [<span style="font-weight: bold"><span style="color: #000000">multiply</span></span>()];
<span style="font-weight: bold"><span style="color: #000000">generate_code</span></span>({<span style="font-weight: bold"><span style="color: #000080">integer</span></span>, <span style="color: #009900">_Line</span>, <span style="color: #009900">I</span>}) <span style="color: #990000">-&gt;</span> [<span style="font-weight: bold"><span style="color: #000000">push</span></span>(), <span style="font-weight: bold"><span style="color: #000080">integer</span></span>(<span style="color: #009900">I</span>)]<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">stop</span></span>()     <span style="color: #990000">-&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">add</span></span>()      <span style="color: #990000">-&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">multiply</span></span>() <span style="color: #990000">-&gt;</span> <span style="color: #993399">2</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000000">push</span></span>()     <span style="color: #990000">-&gt;</span> <span style="color: #993399">3</span><span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">integer</span></span>(<span style="color: #009900">I</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">L</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">binary_to_list</span></span>(<span style="font-weight: bold"><span style="color: #000000">binary:encode_unsigned</span></span>(<span style="color: #009900">I</span>)),
    [<span style="font-weight: bold"><span style="color: #000080">length</span></span>(<span style="color: #009900">L</span>) | <span style="color: #009900">L</span>]<span style="color: #990000">.</span>
</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdlib.h&gt;</span>

<span style="color: #009900">char</span> <span style="color: #990000">*</span><span style="font-weight: bold"><span style="color: #000000">read_file</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">FILE</span> <span style="color: #990000">*</span>file<span style="color: #990000">;</span>
  <span style="color: #009900">char</span> <span style="color: #990000">*</span>code<span style="color: #990000">;</span>
  <span style="color: #009900">long</span>  size<span style="color: #990000">;</span>

  file <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fopen</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> <span style="color: #FF0000">"r"</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>file <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_END<span style="color: #990000">);</span>
  size <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ftell</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  code <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">char</span><span style="color: #990000">*)</span><span style="font-weight: bold"><span style="color: #000000">calloc</span></span><span style="color: #990000">(</span>size<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span><span style="color: #990000">));</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>code <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_SET<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">fread</span></span><span style="color: #990000">(</span>code<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span><span style="color: #990000">),</span> size<span style="color: #990000">,</span> file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">fclose</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> code<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000080">#define</span></span> STOP <span style="color: #993399">0</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> ADD  <span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> MUL  <span style="color: #993399">2</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> PUSH <span style="color: #993399">3</span>

<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span>   <span style="color: #990000">(</span>stack<span style="color: #990000">[--</span>sp<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>X<span style="color: #990000">)</span> <span style="color: #990000">(</span>stack<span style="color: #990000">[</span>sp<span style="color: #990000">++]</span> <span style="color: #990000">=</span> X<span style="color: #990000">)</span>

<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>code<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #009900">int</span> stack<span style="color: #990000">[</span><span style="color: #993399">1000</span><span style="color: #990000">];</span>
  <span style="color: #009900">int</span> sp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> size <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="color: #009900">char</span> <span style="color: #990000">*</span>ip <span style="color: #990000">=</span> code<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(*</span>ip <span style="color: #990000">!=</span> STOP<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(*</span>ip<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ADD<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">());</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> MUL<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">());</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> PUSH<span style="color: #990000">:</span>
      size <span style="color: #990000">=</span> <span style="color: #990000">*</span>ip<span style="color: #990000">++;</span>
      val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>size<span style="color: #990000">--)</span> <span style="color: #FF0000">{</span> val <span style="color: #990000">=</span> val <span style="color: #990000">*</span> <span style="color: #993399">256</span> <span style="color: #990000">+</span> <span style="color: #990000">*</span>ip<span style="color: #990000">++;</span> <span style="color: #FF0000">}</span>
      <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>val<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>


<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>argv<span style="color: #990000">[])</span>
<span style="color: #FF0000">{</span>
  <span style="color: #009900">char</span> <span style="color: #990000">*</span>code<span style="color: #990000">;</span>
  <span style="color: #009900">int</span> res<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>argc <span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    code <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">read_file</span></span><span style="color: #990000">(</span>argv<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]);</span>
    res <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">(</span>code<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The value is: %i</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> res<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Give a the file name of a byte code program as argument</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdlib.h&gt;</span>

<span style="font-weight: bold"><span style="color: #000080">#define</span></span> STOP <span style="color: #993399">0</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> ADD  <span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> MUL  <span style="color: #993399">2</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> PUSH <span style="color: #993399">3</span>

<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">()</span> <span style="color: #990000">(</span>stack<span style="color: #990000">[--</span>sp<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>X<span style="color: #990000">)</span> <span style="color: #990000">(</span>stack<span style="color: #990000">[</span>sp<span style="color: #990000">++]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>X<span style="color: #990000">))</span>

<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="color: #009900">void</span> <span style="color: #990000">(*</span>instructionp_t<span style="color: #990000">)(</span><span style="color: #009900">void</span><span style="color: #990000">);</span>

<span style="color: #009900">int</span> stack<span style="color: #990000">[</span><span style="color: #993399">1000</span><span style="color: #990000">];</span>
<span style="color: #009900">int</span> sp<span style="color: #990000">;</span>
<span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span>ip<span style="color: #990000">;</span>
<span style="color: #009900">int</span> running<span style="color: #990000">;</span>

<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">()</span>  <span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">,</span>y<span style="color: #990000">;</span> x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> y <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x <span style="color: #990000">+</span> y<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">mul</span></span><span style="color: #990000">()</span>  <span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">,</span>y<span style="color: #990000">;</span> x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> y <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span> <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x <span style="color: #990000">*</span> y<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">pushi</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span> <span style="color: #009900">int</span> x<span style="color: #990000">;</span>   x <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)*</span>ip<span style="color: #990000">++;</span>       <span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>x<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">stop</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> running <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span>

<span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span><span style="font-weight: bold"><span style="color: #000000">read_file</span></span><span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">FILE</span> <span style="color: #990000">*</span>file<span style="color: #990000">;</span>
  <span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span>code<span style="color: #990000">;</span>
  <span style="color: #008080">instructionp_t</span> <span style="color: #990000">*</span>cp<span style="color: #990000">;</span>
  <span style="color: #009900">long</span>  size<span style="color: #990000">;</span>
  <span style="color: #009900">char</span> ch<span style="color: #990000">;</span>
  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> val<span style="color: #990000">;</span>

  file <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fopen</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> <span style="color: #FF0000">"r"</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>file <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_END<span style="color: #990000">);</span>
  size <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ftell</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  code <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">calloc</span></span><span style="color: #990000">(</span>size<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>instructionp_t<span style="color: #990000">));</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>code <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  cp <span style="color: #990000">=</span> code<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">fseek</span></span><span style="color: #990000">(</span>file<span style="color: #990000">,</span> <span style="color: #993399">0L</span><span style="color: #990000">,</span> SEEK_SET<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span> <span style="color: #990000">(</span> ch <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">)</span> <span style="color: #990000">)</span> <span style="color: #990000">!=</span> EOF <span style="color: #990000">)</span>
    <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>ch<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ADD<span style="color: #990000">:</span> <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>add<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> MUL<span style="color: #990000">:</span> <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>mul<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> PUSH<span style="color: #990000">:</span>
        <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>pushi<span style="color: #990000">;</span>
        ch <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
        val <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>ch<span style="color: #990000">--)</span> <span style="color: #FF0000">{</span> val <span style="color: #990000">=</span> val <span style="color: #990000">*</span> <span style="color: #993399">256</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fgetc</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span> <span style="color: #FF0000">}</span>
        <span style="color: #990000">*</span>cp<span style="color: #990000">++</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>instructionp_t<span style="color: #990000">)</span> val<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #990000">*</span>cp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>stop<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">fclose</span></span><span style="color: #990000">(</span>file<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> code<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>


<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  sp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  running <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>running<span style="color: #990000">)</span> <span style="color: #990000">(*</span>ip<span style="color: #990000">++)();</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">pop</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>


<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>argv<span style="color: #990000">[])</span>
<span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>argc <span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    ip <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">read_file</span></span><span style="color: #990000">(</span>argv<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]);</span>
    <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The value is: %i</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">());</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Give a the file name of a byte code program as argument</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="listingblock">
<a id="listing-share"></a>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">share</span>)<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">share</span></span><span style="color: #990000">/</span><span style="color: #993399">2</span>, <span style="font-weight: bold"><span style="color: #000080">size</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">share</span></span>(<span style="color: #993399">0</span>, <span style="color: #009900">Y</span>) <span style="color: #990000">-&gt;</span> {<span style="color: #009900">Y</span>,<span style="color: #009900">Y</span>};
<span style="font-weight: bold"><span style="color: #000000">share</span></span>(<span style="color: #009900">N</span>, <span style="color: #009900">Y</span>) <span style="color: #990000">-&gt;</span> [<span style="font-weight: bold"><span style="color: #000000">share</span></span>(<span style="color: #009900">N</span><span style="color: #990000">-</span><span style="color: #993399">1</span>, [<span style="color: #009900">N</span>|<span style="color: #009900">Y</span>]) || <span style="color: #990000">_</span> <span style="color: #990000">&lt;-</span> <span style="color: #009900">Y</span>]<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000080">size</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">T</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">share:share</span></span>(<span style="color: #993399">5</span>,[<span style="color: #FF6600">a</span>,<span style="color: #FF6600">b</span>,<span style="color: #FF6600">c</span>]),
    {{<span style="font-weight: bold"><span style="color: #000080">size</span></span>, <span style="font-weight: bold"><span style="color: #000000">erts_debug:size</span></span>(<span style="color: #009900">T</span>)},
     {<span style="color: #FF6600">flat_size</span>, <span style="font-weight: bold"><span style="color: #000000">erts_debug:flat_size</span></span>(<span style="color: #009900">T</span>)}}<span style="color: #990000">.</span></tt></pre></div></div>
<div class="listingblock">
<a id="listing-send"></a>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">send</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">P2</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">p2</span></span>() <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>),
    <span style="color: #009900">P1</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">p1</span></span>(<span style="color: #009900">P2</span>) <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>),
    {<span style="color: #009900">P1</span>, <span style="color: #009900">P2</span>}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">p2</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">receive</span></span>
        <span style="color: #009900">M</span> <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">io:format</span></span>(<span style="color: #FF0000">"P2 got ~p"</span>, [<span style="color: #009900">M</span>])
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">p1</span></span>(<span style="color: #009900">P2</span>) <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">L</span> <span style="color: #990000">=</span> <span style="color: #FF0000">"hello"</span>,
    <span style="color: #009900">M</span> <span style="color: #990000">=</span> {<span style="color: #009900">L</span>, <span style="color: #009900">L</span>},
    <span style="color: #009900">P2</span> <span style="color: #990000">!</span> <span style="color: #009900">M</span>,
    <span style="font-weight: bold"><span style="color: #000000">io:format</span></span>(<span style="color: #FF0000">"P1 sent ~p"</span>, [<span style="color: #009900">M</span>])<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph" id="listing-lb"><p>Load Balancer.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">-module</span></span>(<span style="color: #FF6600">lb</span>)<span style="color: #990000">.</span>
<span style="font-weight: bold"><span style="color: #000080">-export</span></span>([<span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>])<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">start</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="color: #009900">Workers</span> <span style="color: #990000">=</span> [<span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span> <span style="font-weight: bold"><span style="color: #000000">worker</span></span><span style="color: #990000">/</span><span style="color: #993399">0</span>) || <span style="color: #990000">_</span> <span style="color: #990000">&lt;-</span> <span style="font-weight: bold"><span style="color: #000000">lists:seq</span></span>(<span style="color: #993399">1</span>,<span style="color: #993399">10</span>)],
    <span style="color: #009900">LoadBalancer</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">Workers</span>, <span style="color: #993399">0</span>) <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>),
    {<span style="color: #FF6600">ok</span>, <span style="color: #009900">Files</span>} <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">file:list_dir</span></span>(<span style="color: #FF0000">"."</span>),
    <span style="color: #009900">Loaders</span> <span style="color: #990000">=</span> [<span style="font-weight: bold"><span style="color: #000080">spawn</span></span>(<span style="font-weight: bold"><span style="color: #0000FF">fun</span></span>() <span style="color: #990000">-&gt;</span> <span style="font-weight: bold"><span style="color: #000000">loader</span></span>(<span style="color: #009900">LoadBalancer</span>, <span style="color: #009900">F</span>) <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>) || <span style="color: #009900">F</span> <span style="color: #990000">&lt;-</span> <span style="color: #009900">Files</span>],
    {<span style="color: #009900">Loaders</span>, <span style="color: #009900">LoadBalancer</span>, <span style="color: #009900">Workers</span>}<span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">loader</span></span>(<span style="color: #009900">LB</span>, <span style="color: #009900">File</span>) <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span>  <span style="font-weight: bold"><span style="color: #000000">file:read_file</span></span>(<span style="color: #009900">File</span>) <span style="font-weight: bold"><span style="color: #0000FF">of</span></span>
        {<span style="color: #FF6600">ok</span>, <span style="color: #009900">Bin</span>} <span style="color: #990000">-&gt;</span>  <span style="color: #009900">LB</span> <span style="color: #990000">!</span> <span style="color: #009900">Bin</span>;
        <span style="color: #009900">_Dir</span> <span style="color: #990000">-&gt;</span> <span style="color: #FF6600">ok</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>,
    <span style="color: #FF6600">ok</span><span style="color: #990000">.</span>

<span style="font-weight: bold"><span style="color: #000000">worker</span></span>() <span style="color: #990000">-&gt;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">receive</span></span>
        <span style="color: #009900">Bin</span> <span style="color: #990000">-&gt;</span>
            <span style="font-weight: bold"><span style="color: #000000">io:format</span></span>(<span style="color: #FF0000">"Byte Size: ~w~n"</span>, [<span style="font-weight: bold"><span style="color: #000080">byte_size</span></span>(<span style="color: #009900">Bin</span>)]),
            <span style="font-weight: bold"><span style="color: #000000">garbage_collect</span></span>(),
            <span style="font-weight: bold"><span style="color: #000000">worker</span></span>()
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span>


<span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">Workers</span>, <span style="color: #009900">N</span>) <span style="color: #990000">-&gt;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">receive</span></span>
    <span style="color: #009900">WorkItem</span> <span style="color: #990000">-&gt;</span>
       <span style="color: #009900">Worker</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">lists:nth</span></span>(<span style="color: #009900">N</span><span style="color: #990000">+</span><span style="color: #993399">1</span>, <span style="color: #009900">Workers</span>),
       <span style="color: #009900">Worker</span> <span style="color: #990000">!</span> <span style="color: #009900">WorkItem</span>,
       <span style="font-weight: bold"><span style="color: #000000">loop</span></span>(<span style="color: #009900">Workers</span>, (<span style="color: #009900">N</span><span style="color: #990000">+</span><span style="color: #993399">1</span>) <span style="font-weight: bold"><span style="color: #0000FF">rem</span></span> <span style="font-weight: bold"><span style="color: #000080">length</span></span>(<span style="color: #009900">Workers</span>))
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span><span style="color: #990000">.</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated
 2017-04-12 15:40:28 UTC
</div>
</div>
</body>
</html>
